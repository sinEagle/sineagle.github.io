<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/eagle32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/eagle16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=DejaVu Sans Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-flat-top.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sineagle.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="title: Linux 系统编程date: 2022-12-26 17:27:34tags: [‘linux’, ‘OS’]description: ‘ ‘hidden: false Linux 系统编程入门什么是系统编程系统编程范畴 内核态系统编程： Linux内核编程 用户态系统编程： 系统调用  系统调用 将留给应用程序的内核API接口统一管理 硬件访问权限、特权指令 Linux系统调用接">
<meta property="og:type" content="article">
<meta property="og:title" content="sinEagle">
<meta property="og:url" content="https://sineagle.github.io/2022/12/26/Linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="sinEagle">
<meta property="og:description" content="title: Linux 系统编程date: 2022-12-26 17:27:34tags: [‘linux’, ‘OS’]description: ‘ ‘hidden: false Linux 系统编程入门什么是系统编程系统编程范畴 内核态系统编程： Linux内核编程 用户态系统编程： 系统调用  系统调用 将留给应用程序的内核API接口统一管理 硬件访问权限、特权指令 Linux系统调用接">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230411202126.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230411203215.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413102932.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413103035.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413103217.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413105654.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413110108.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414104356.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414161653.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414161805.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414162017.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414162601.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414170340.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414180712.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415094351.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415095110.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415095717.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415100840.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415100645.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415102254.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415102526.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415102856.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415105109.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415110528.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415150741.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415154326.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415170800.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415170944.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415171248.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415173003.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415184606.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415184806.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415185516.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415190156.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415193852.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416095900.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416101927.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416102918.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416102935.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416103419.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416104615.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416105132.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151434.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151454.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151521.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151824.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151919.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152201.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152406.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152513.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152901.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152946.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416153731.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416154248.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416155813.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416164036.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416173031.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416173244.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416173307.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416174832.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416174844.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416175302.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416193724.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416194911.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416200954.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416201007.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416201222.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416201408.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416204430.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416204941.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416205538.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416211921.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417091909.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417091934.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417092000.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417092026.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417092103.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417110711.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417145407.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417150041.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417150334.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417202454.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417202543.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417202633.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417203325.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418144651.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418145709.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418150014.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418150504.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418151220.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418190936.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418191355.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418193438.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418202227.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418202711.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418202958.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418210856.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418211750.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419090553.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419093403.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419103032.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419110902.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419153233.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419193408.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419200106.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419200138.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419205055.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419205233.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419205840.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419210013.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419211128.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419211614.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419211627.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419212231.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420091125.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420183955.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420184858.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420211427.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420211440.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421083247.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421083611.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421084728.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421104914.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421204440.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421210752.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421210931.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422083730.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422084438.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422085001.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422101044.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422101437.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422102810.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422103613.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422104838.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422104854.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422110920.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422112041.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422112249.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422112305.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422153132.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422154316.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422154333.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422154825.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422155417.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422155646.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422161650.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422161954.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422163241.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422192045.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422193844.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422194027.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423101900.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423161811.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423164212.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423164532.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423192753.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423194935.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423195441.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423200020.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423200348.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423200717.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424084059.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424110437.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424152349.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424152402.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424152413.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424163816.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424170325.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424171047.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424171248.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424205434.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424205450.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424211152.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424211137.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425104513.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425192856.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425192907.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425192921.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426152934.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426162205.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426171025.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426173807.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426202918.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426205031.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429164126.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165517.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165545.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165714.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165801.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165813.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165856.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430103217.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430115857.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430173437.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430210017.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230504093705.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230504093807.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230504094537.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230505160011.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230506155523.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230507093955.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230507094800.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230507094834.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508110906.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508111143.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508154211.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508154244.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508155311.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508162903.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508171832.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508174157.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508174801.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508211418.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508211438.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508211521.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508212114.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508212720.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508213425.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508213640.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508213926.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230509093355.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230509111242.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230509213110.png">
<meta property="article:published_time" content="2022-12-26T09:27:34.146Z">
<meta property="article:modified_time" content="2023-05-09T13:32:29.214Z">
<meta property="article:author" content="sineagle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230411202126.png">

<link rel="canonical" href="https://sineagle.github.io/2022/12/26/Linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title> | sinEagle</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sinEagle</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">bottlecode</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
			
			

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sineagle.github.io/2022/12/26/Linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpg">
      <meta itemprop="name" content="sineagle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sinEagle">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-12-26 17:27:34" itemprop="dateCreated datePublished" datetime="2022-12-26T17:27:34+08:00">2022-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-05-09 21:32:29" itemprop="dateModified" datetime="2023-05-09T21:32:29+08:00">2023-05-09</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>153k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2:19</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>title: Linux 系统编程<br>date: 2022-12-26 17:27:34<br>tags: [‘linux’, ‘OS’]<br>description: ‘ ‘<br>hidden: false</p>
<h1 id="Linux-系统编程入门"><a href="#Linux-系统编程入门" class="headerlink" title="Linux 系统编程入门"></a>Linux 系统编程入门</h1><h2 id="什么是系统编程"><a href="#什么是系统编程" class="headerlink" title="什么是系统编程"></a>什么是系统编程</h2><h3 id="系统编程范畴"><a href="#系统编程范畴" class="headerlink" title="系统编程范畴"></a>系统编程范畴</h3><ul>
<li>内核态系统编程： Linux内核编程</li>
<li>用户态系统编程： 系统调用</li>
</ul>
<h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><ul>
<li>将留给应用程序的内核API接口统一管理</li>
<li><font color='9900CC'>硬件访问权限、特权指令</font></li>
<li>Linux系统调用接口<ul>
<li>文件IO、目录、文件系统</li>
<li>进程、线程、进程间通信</li>
<li>时间、信号、网络</li>
<li>内存管理</li>
</ul>
</li>
</ul>
<h2 id="一个系统编程例子（文件基本操作）"><a href="#一个系统编程例子（文件基本操作）" class="headerlink" title="一个系统编程例子（文件基本操作）"></a>一个系统编程例子（文件基本操作）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  fd = open(<span class="string">&quot;hello.txt&quot;</span>, O_RDWR|O_CREAT, <span class="number">0666</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open file failed!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> <span class="built_in">string</span>[<span class="number">20</span>] = <span class="string">&quot;hello world!\n&quot;</span>;</span><br><span class="line">  write(fd, <span class="built_in">string</span>, <span class="number">14</span>);</span><br><span class="line">  fsync(fd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> * buf = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">20</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">20</span>);</span><br><span class="line">  lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">  read(fd, buf, <span class="number">14</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  close(fd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现-cp-命令"><a href="#实现-cp-命令" class="headerlink" title="实现 cp 命令"></a>实现 cp 命令</h2><p>基本流程：</p>
<ul>
<li>打开源文件</li>
<li>打开目标文件</li>
<li>读取源文件数据</li>
<li>写入到目标文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFERSIZE 4096</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage:\n copy src dst\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> srcfd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (srcfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> dstfd = open(argv[<span class="number">2</span>], O_CREAT|O_WRONLY, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (dstfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buffer[BUFFERSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((len = read(srcfd, buffer, BUFFERSIZE)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( write(dstfd, buffer, len) != len ) &#123;</span><br><span class="line">            perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(srcfd);</span><br><span class="line">    close(dstfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="系统调用与C标准库"><a href="#系统调用与C标准库" class="headerlink" title="系统调用与C标准库"></a>系统调用与C标准库</h2><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230411202126.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">float</span> score;</span><br><span class="line">&#125; stu[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;please input name age score: \n&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s%d%f&quot;</span>, stu[i].name, &amp;stu[i].age, &amp;stu[i].score);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="keyword">if</span> ((fp = fopen(<span class="string">&quot;hello.dat&quot;</span>, <span class="string">&quot;w+&quot;</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fopen failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(&amp;stu, <span class="keyword">sizeof</span>(struct student), <span class="number">2</span>, fp);</span><br><span class="line">    <span class="keyword">if</span> (ferror(fp) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fwrite failed!\n&quot;</span>);</span><br><span class="line">        clearerr(fp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fflush(fp);</span><br><span class="line">    rewind(fp);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">student</span>* <span class="title">buf</span> =</span> (struct student *) <span class="built_in">malloc</span>(<span class="number">2</span> * <span class="keyword">sizeof</span>(struct student));</span><br><span class="line"></span><br><span class="line">    fread(buf, <span class="keyword">sizeof</span>(struct student), <span class="number">2</span>, fp);</span><br><span class="line">    <span class="keyword">if</span> (ferror(fp) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fread failed!\n&quot;</span>);</span><br><span class="line">        clearerr(fp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;姓名\t年龄\t分数\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\t%d\t%f\n&quot;</span>, buf[i].name, buf[i].age, buf[i].score);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230411203215.png"></p>
<p>Linux系统调用基本流程</p>
<ul>
<li><strong>软中断</strong> : x86下的 <code>int 0x80</code>， ARM架构下的 <code>SWI</code>软中断指令 <ul>
<li>开始CPL为3，根据<strong>IDT表</strong>中的段选择符和偏移地址合在一起设置成新的PC，更新CS和IP后，CS末尾的CPL设置为0，特权级变为0，可以进入内核态了、</li>
</ul>
</li>
<li>处理器会将当前的用户栈指针和程序计数器等信息保存在内核栈中，并跳转到系统调用处理程序的入口点<ul>
<li>寄存器传递相关的参数：打开的文件名、参数、系统调用号</li>
</ul>
</li>
<li>进入内核态，执行内核特权指令代码函数</li>
<li>返回值保存到相应寄存器中</li>
<li>返回到用户态、恢复上下文，切换用户栈，系统调用结束</li>
</ul>
<h2 id="strace-命令"><a href="#strace-命令" class="headerlink" title="strace 命令"></a>strace 命令</h2><p>基本功能</p>
<ul>
<li>监控用户进程和内核进程的交互</li>
<li>追踪进程的系统调用、信号传递、状态变化</li>
</ul>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><ul>
<li>系统编程错误一般通过函数的返回值来表示</li>
<li>执行成功，返回 0 或 正确值</li>
<li>执行失败，返回-1，并把系统全局变量 <code>errno</code> 赋值，指示具体错误</li>
<li>全局变量 errno 由操作系统维护：当系统调用或调用库函数出错时，会重置该值</li>
</ul>
<p>可以通过 <code>perror()</code> 根据 errno 值来打印具体的错误</p>
<h2 id="GNU编码风格"><a href="#GNU编码风格" class="headerlink" title="GNU编码风格"></a>GNU编码风格</h2><h3 id="函数顶头写"><a href="#函数顶头写" class="headerlink" title="函数顶头写"></a>函数顶头写</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413102932.png"></p>
<h3 id="空格"><a href="#空格" class="headerlink" title="空格"></a>空格</h3><p>使用空格的地方</p>
<ul>
<li>左括号之前</li>
<li>逗号之后</li>
<li>运算符两边</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413103035.png"></p>
<h3 id="对齐"><a href="#对齐" class="headerlink" title="对齐"></a>对齐</h3><p>多行对齐</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413103217.png"></p>
<h3 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h3><ul>
<li>函数名、变量名用小写字母、下划线进行分割</li>
<li>宏、枚举常量使用大写字母定义</li>
<li>函数命名：open_door</li>
<li>Windows风格：OpenDoor</li>
</ul>
<h2 id="Linux哲学：一切皆文件"><a href="#Linux哲学：一切皆文件" class="headerlink" title="Linux哲学：一切皆文件"></a>Linux哲学：一切皆文件</h2><p>Linux设计思想：</p>
<ul>
<li>一个程序只实现一个功能，多个程序组合完成复杂的功能</li>
<li>数据配置在文本文件中</li>
<li>机制与策略</li>
<li><strong>一切皆文件</strong></li>
</ul>
<h3 id="广义上的文件"><a href="#广义上的文件" class="headerlink" title="广义上的文件"></a>广义上的文件</h3><ul>
<li>普通文件</li>
<li>目录</li>
<li>特殊设备文件：字符设备、块设备、网络设备</li>
<li>套接字</li>
<li>进程、线程</li>
<li>命名管道</li>
</ul>
<h3 id="VPS"><a href="#VPS" class="headerlink" title="VPS"></a>VPS</h3><p>虚拟文件系统</p>
<ul>
<li>virtual file system</li>
<li>对不同的文件系统进行抽象</li>
<li>提供一个统一的操作接口</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413105654.png"></p>
<h3 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h3><p>基本概念：</p>
<ul>
<li>file descriptor 简称 fd ，用来描述一个已经打开的文件索引（非负整数）</li>
<li>当 fd 为负时，表示文件打开失败</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230413110108.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">15</span>);</span><br><span class="line">    write(<span class="number">1</span>, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="编程实战：音频播放器"><a href="#编程实战：音频播放器" class="headerlink" title="编程实战：音频播放器"></a>编程实战：音频播放器</h2><h3 id="设备文件"><a href="#设备文件" class="headerlink" title="设备文件"></a>设备文件</h3><ul>
<li>普通文件可以通过文件名与实际的存储数据进行关联</li>
<li>设备文件通过设备结点与具体的物理设备进行关联</li>
<li>设备号：主设备号 + 次设备号组成</li>
<li>设备文件存放在 /dev 目录下</li>
<li>设备结点可以自动创建、也可以手工创建</li>
</ul>
<h3 id="常见的设备文件"><a href="#常见的设备文件" class="headerlink" title="常见的设备文件"></a>常见的设备文件</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414104356.png"></p>
<h3 id="设备文件-dsp"><a href="#设备文件-dsp" class="headerlink" title="设备文件 dsp"></a>设备文件 dsp</h3><ul>
<li>打开声卡设备文件 /dev/dsp</li>
<li>打开音频数据文件 xx.wav</li>
<li>从音频文件读一段数据</li>
<li>写入声卡设备文件</li>
<li>关闭文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/soundcard.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dst_fd;</span><br><span class="line">    dst_fd = open (<span class="string">&quot;/dev/dsp&quot;</span>, O_WRONLY, <span class="number">0667</span>); <span class="comment">/*open dsp*/</span></span><br><span class="line">    <span class="keyword">if</span> (dst_fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;open /dev/dsp error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> src_fd;</span><br><span class="line">    src_fd  = open (<span class="string">&quot;./fruit.wav&quot;</span>, O_RDONLY, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (src_fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;open wav file failed!&quot;</span>);</span><br><span class="line">        close (dst_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> read_count;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> ((read_count = read(src_fd, buf, <span class="number">1024</span>)) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (write(dst_fd, buf, read_count) != read_count)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;write /dev/dsp error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (read_count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;read wav file error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(src_fd);</span><br><span class="line">    close(dst_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过 <code>ioctl</code>系统调用配置声卡后改进</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/soundcard.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dst_fd;</span><br><span class="line">    dst_fd = open (<span class="string">&quot;/dev/dsp&quot;</span>, O_WRONLY, <span class="number">0666</span>); <span class="comment">/*open dsp*/</span></span><br><span class="line">    <span class="keyword">if</span> (dst_fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;open /dev/dsp error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rate = <span class="number">44100</span>;</span><br><span class="line">    ioctl (dst_fd, SNDCTL_DSP_SPEED, &amp;rate);</span><br><span class="line">    <span class="keyword">int</span> channels = <span class="number">2</span>;</span><br><span class="line">    ioctl (dst_fd, SNDCTL_DSP_CHANNELS, &amp;channels);</span><br><span class="line">    <span class="keyword">int</span> format = <span class="number">16</span>;</span><br><span class="line">    ioctl (dst_fd, SNDCTL_DSP_SETFMT, &amp;format);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> src_fd;</span><br><span class="line">    src_fd  = open (<span class="string">&quot;./fruit.wav&quot;</span>, O_RDONLY, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (src_fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;open wav file failed!&quot;</span>);</span><br><span class="line">        close (dst_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> read_count;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> ((read_count = read(src_fd, buf, <span class="number">1024</span>)) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (write(dst_fd, buf, read_count) != read_count)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;write /dev/dsp error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (read_count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;read wav file error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(src_fd);</span><br><span class="line">    close(dst_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="揭开文件系统的神秘面纱"><a href="#揭开文件系统的神秘面纱" class="headerlink" title="揭开文件系统的神秘面纱"></a>揭开文件系统的神秘面纱</h1><h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>基本概念</p>
<ul>
<li>一切皆文件：磁盘文件、设备文件、FIFO</li>
<li>文件系统：对文件进行管理的程序</li>
</ul>
<p>文件主要对数据进行封装和管理，而文件系统就是对文件进行管理的程序。</p>
<ul>
<li>数据以文件形式封装</li>
<li>以统一文件接口进行读写</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414161653.png"></p>
<h2 id="文件在磁盘上的存储"><a href="#文件在磁盘上的存储" class="headerlink" title="文件在磁盘上的存储"></a>文件在磁盘上的存储</h2><h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414161805.png"></p>
<h3 id="磁盘原理"><a href="#磁盘原理" class="headerlink" title="磁盘原理"></a>磁盘原理</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414162017.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414162601.png"></p>
<h3 id="磁盘控制器驱动"><a href="#磁盘控制器驱动" class="headerlink" title="磁盘控制器驱动"></a>磁盘控制器驱动</h3><p>磁盘接口</p>
<ul>
<li>SATA</li>
<li>IDE</li>
<li>SCSI</li>
</ul>
<h3 id="文件数据存储"><a href="#文件数据存储" class="headerlink" title="文件数据存储"></a>文件数据存储</h3><p>扇区与地址</p>
<ul>
<li>每个文件存在一块连续的扇区上</li>
<li>一个字节的文件也要占用扇区的整数倍</li>
</ul>
<h3 id="文件信息存储"><a href="#文件信息存储" class="headerlink" title="文件信息存储"></a>文件信息存储</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414170340.png"></p>
<p>这些信息也叫做文件的<strong>元数据</strong></p>
<h3 id="存储抽象"><a href="#存储抽象" class="headerlink" title="存储抽象"></a>存储抽象</h3><p>随着技术的发展，因为每个磁盘厂家设置的扇区大小不一致，为了适应不同厂家不同容量的硬盘，需要把存储单元固定下来，需要定义最小读写的逻辑单元</p>
<ul>
<li>扇区：磁盘的最小读写的物理单元</li>
<li>簇：Windows下文件系统的最小读写逻辑单元</li>
<li>块：Linux 下文件系统的最小读写逻辑单元<ul>
<li>一个簇/块的大小等于扇区的2、4、8、16倍</li>
<li>一个文件占用的体积是簇/块的整数倍</li>
<li>簇/块越小，磁盘利用率越高，但存储效率会降低</li>
<li>文件体积越小，簇/块越大，磁盘空间利用率越低</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230414180712.png"></p>
<h2 id="文件在Flash上的存储"><a href="#文件在Flash上的存储" class="headerlink" title="文件在Flash上的存储"></a>文件在Flash上的存储</h2><p>磁盘与Flash存储的异同点：</p>
<ul>
<li><p>由控制器驱动进行底层读写</p>
<ul>
<li>磁盘：SCSI命令、SATA命令</li>
<li>NAND Flash：芯片读写指令、周期</li>
</ul>
</li>
<li><p>寻址方式都是多级地址</p>
<ul>
<li>磁盘：xx磁道， xx磁头， xx扇区</li>
<li>Flash： xx块号， xx块内页号， xx页内字节号</li>
</ul>
</li>
<li><p>都是整片为单位进行读写</p>
<ul>
<li><p>磁盘以扇区为最小读写单位，Nand Flash以页为最小读写单位</p>
</li>
<li><p>都可以被文件系统抽象为逻辑块，通过映射层进行地址映射</p>
</li>
</ul>
</li>
</ul>
<h2 id="文件索引结点：inode"><a href="#文件索引结点：inode" class="headerlink" title="文件索引结点：inode"></a>文件索引结点：inode</h2><h3 id="逻辑块"><a href="#逻辑块" class="headerlink" title="逻辑块"></a>逻辑块</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415094351.png"></p>
<h3 id="文件的存储"><a href="#文件的存储" class="headerlink" title="文件的存储"></a>文件的存储</h3><p>两部分：</p>
<ul>
<li>纯数据区<ul>
<li>文件真正的数据存储区、基本存储单位为block</li>
</ul>
</li>
<li><strong>元数据区</strong><ul>
<li>文件属性：磁盘中的存储位置、文件长度等信息</li>
<li>时间戳：创建时间、修改时间</li>
<li>读写权限：使用read/write系统调用时，要首先要进行权限检查</li>
<li>所属组、所有者</li>
<li>链接数</li>
</ul>
</li>
</ul>
<p>文件的元数据区是如何存储的呢？使用<code>inode</code>来进行存储</p>
<h3 id="索引结点：inode"><a href="#索引结点：inode" class="headerlink" title="索引结点：inode"></a>索引结点：inode</h3><p>用来存储文件信息</p>
<ul>
<li><p>inode：每个文件使用一个<font color='9900CC'>inode结构体</font>来描述</p>
</li>
<li><p>每个inode有固定编号、有单独的存储空间</p>
</li>
<li><p>每个inode的大小为128/256B</p>
</li>
<li><p>Linux系统根据inode来查找文件的存储位置</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415095110.png"></p>
<p>使用 <code>stat</code> 命令可以查看文件 inode 信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415095717.png"></p>
<p>通过 <code>df -i</code> 命令可以查看某个分区的 inode 总数</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415100840.png"></p>
<h3 id="索引结点表（inode-table）"><a href="#索引结点表（inode-table）" class="headerlink" title="索引结点表（inode table）"></a>索引结点表（inode table）</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415100645.png"></p>
<h3 id="data-block"><a href="#data-block" class="headerlink" title="data block"></a>data block</h3><p>数据块（逻辑块）</p>
<ul>
<li>格式化磁盘时划分的文件系统的最小逻辑读写单位</li>
<li>每个block都有自己的编号，inode中存放文件的block地址信息</li>
<li>一个block一般是扇区或页的整数倍：1K/2K/4K</li>
</ul>
<p>查看某个分区的block信息： <code>df</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415102254.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415102526.png"></p>
<p><code>-h</code>选项用于将大小以人类可读的方式显示，方便查看</p>
<h3 id="存储映射"><a href="#存储映射" class="headerlink" title="存储映射"></a>存储映射</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415102856.png"></p>
<h2 id="超级块：superblock"><a href="#超级块：superblock" class="headerlink" title="超级块：superblock"></a>超级块：superblock</h2><p>super block</p>
<ul>
<li>记录整个文件系统的信息</li>
<li>一个inode、block的大小</li>
<li>inode使用情况：已使用数量、未使用数量</li>
<li>block使用情况：已使用数量、未使用数量</li>
<li>文件系统挂载情况</li>
<li>文件系统的挂载时间、最后一次写入数据、检验磁盘的时间</li>
<li>当文件系统挂载时，这部分信息会加载到内存，并常驻内存</li>
</ul>
<h3 id="磁盘格式化"><a href="#磁盘格式化" class="headerlink" title="磁盘格式化"></a>磁盘格式化</h3><p>两种格式化</p>
<ul>
<li><p>物理格式化</p>
<ul>
<li><p>磁盘在使用前要<font color='9900CC'>进行分区和格式化</font>：MBR中存放分区信息、开机代码（Linux下使用 <code>fdisk</code>命令）</p>
</li>
<li><p>出厂前厂家已经做好的工作：划分磁道、扇区</p>
</li>
<li><p>物理格式化完成后，磁盘就会对应不同的分区（Windows出现C盘、D盘等，Linux下出现/dev/下出现不同的设备结点）</p>
</li>
</ul>
</li>
<li><p>逻辑格式化</p>
<ul>
<li>使用格式化工具，在磁盘上<font color='9900CC'>安装文件系统</font>（每个分区可以安装不同的文件系统，使用对应的文件系统的格式化工具就可以完成安装）</li>
<li>将磁盘划分为不同的block</li>
<li>将磁盘<font color='9900CC'>划分为不同的区段</font></li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415105109.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415110528.png"></p>
<p>使用文件系统格式化工具进行逻辑格式化，会将整个分区上的物理存储空间划分为不同的区段</p>
<ul>
<li><p>boot sector：引导扇区</p>
</li>
<li><p>Superblock: 记录文件系统的整体信息、inode 和  block 信息</p>
</li>
<li><p>block group（将block划分为不同的块组）</p>
<ul>
<li>每个block group 都有一个 group descriptor，聚集存储在分区开头位置</li>
<li>block bitmap: 记录block的使用情况，哪些在使用，哪些是空的</li>
<li>inode bitmap：记录inode的使用情况</li>
<li>inode table</li>
<li>data block存储真正的数据</li>
</ul>
</li>
<li><p>block description:  记录每一个 block group 的起始地址</p>
</li>
</ul>
<h3 id="块组"><a href="#块组" class="headerlink" title="块组"></a>块组</h3><p>block group</p>
<ul>
<li><p>一个分区在格式化时，可以划分为多个block group</p>
</li>
<li><p>每个block group包含block bitmap、 inode bitmap、inode table、data block</p>
</li>
<li><p>每个block bitmap大小为一个block，每bit表示一个block</p>
</li>
<li><p>每个inode bitmap大小为一个block，每一个bit表示一个inode</p>
</li>
</ul>
<p>group descriptor</p>
<ul>
<li><p>存储在superblock的后面</p>
</li>
<li><p> 有一个block指针，指向block bitmap</p>
</li>
<li><p>有一个block指针，指向inode bitmap</p>
</li>
<li><p>有一个block指针，指向inode table</p>
</li>
<li><p>group descriptor信息存储在superblock中：group descriptor总数等信息</p>
</li>
</ul>
<h3 id="文件在磁盘上的存储-1"><a href="#文件在磁盘上的存储-1" class="headerlink" title="文件在磁盘上的存储"></a>文件在磁盘上的存储</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415150741.png"></p>
<h2 id="目录和目录项"><a href="#目录和目录项" class="headerlink" title="目录和目录项"></a>目录和目录项</h2><p>目录</p>
<ul>
<li>是一个文件、有自己的 inode ，在 inode 中将文件类型标记为目录</li>
<li>目录存储在 <code>data block</code> 中</li>
<li>目录本质是一个表格：由若干目录项组成<ul>
<li>一个目录下面可以多个文件：文件名和文件对应的 inode </li>
<li>一个目录文件有多个子目录：目录名和其对应的 inode </li>
<li>多个子目录构成树状的文件系统结构</li>
</ul>
</li>
</ul>
<p>目录项</p>
<ul>
<li><font color='9900CC'>一个目录项由<strong>文件名</strong>和 <strong>inode编号</strong>组成，根据 inode编号可以找到 inode table 中真正的  inode 结点</font></li>
<li>目录项存储在 <code>data block</code> 中</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415154326.png"></p>
<h2 id="文件路径解析"><a href="#文件路径解析" class="headerlink" title="文件路径解析"></a>文件路径解析</h2><h3 id="文件路径"><a href="#文件路径" class="headerlink" title="文件路径"></a>文件路径</h3><p>构成</p>
<ul>
<li><p>由各个目录、子目录构成</p>
</li>
<li><p>各个路径构成树状结构的文件系统</p>
</li>
</ul>
<p>分类</p>
<ul>
<li>相对路径</li>
<li>绝对路径</li>
</ul>
<h3 id="绝对路径"><a href="#绝对路径" class="headerlink" title="绝对路径"></a>绝对路径</h3><p>根目录：绝对路径的参考起点</p>
<ul>
<li><p>Linux内核中的 “/”</p>
</li>
<li><p>Windows系统中的盘符</p>
</li>
<li><p>文件系统预留的inode编号：2</p>
</li>
</ul>
<h3 id="相对路径"><a href="#相对路径" class="headerlink" title="相对路径"></a>相对路径</h3><p>当前目录：相对目录的参考起点</p>
<ul>
<li>. : 当前目录的硬链接</li>
<li>.. : 上级目录的硬链接</li>
<li>根目录下的 . 和 ..</li>
<li>查看当前目录 inode 编号 ： ls -i -d</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>• 一个目录下可以包含多个文件、或者嵌套多个子目录</p>
<p>• 各级目录构成一个路径，应用程序根据该路径来找到文件</p>
<p>• 路径分为绝对路径和相对路径</p>
<p>• 路径的本质：各级目录文件中的目录构成的一个inode链</p>
<h2 id="文件系统的挂载"><a href="#文件系统的挂载" class="headerlink" title="文件系统的挂载"></a>文件系统的挂载</h2><p>基本原理</p>
<ul>
<li>一个磁盘格式化、安装文件系统后，可以通过文件接口访问存储空间</li>
<li>挂载：让磁盘与Linux根文件系统的某个目录建立关联、加入全局文件系统树</li>
<li>用户通过挂载后的路径名来访问文件</li>
<li>挂载点（mount point）是进入该挂载设备文件系统的入口</li>
</ul>
<h3 id="实验-目录挂载"><a href="#实验-目录挂载" class="headerlink" title="实验-目录挂载"></a>实验-目录挂载</h3><p>将 <code>udisk</code> 挂载到 <code>mnt</code> 上</p>
<p>通过 <code>sudo mount --bind udisk/ mnt/</code> 实现</p>
<p>然后在 <code>mnt</code>中新建 <code>hello.c</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415170800.png"></p>
<p>可以看到两个目录都存在 hello.c</p>
<p>然后进行卸载 <code>umount mnt/</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415170944.png"></p>
<p>这样数据文件就只存放在 <code>udisk</code>中了</p>
<p>解除挂载后，在 mnt 目录下新建 mnt.c，然后再进行挂载</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415171248.png"></p>
<p>可以看到挂载点的东西被屏蔽掉了</p>
<h3 id="挂载过程"><a href="#挂载过程" class="headerlink" title="挂载过程"></a>挂载过程</h3><p>结构体：vfsmount\superblock</p>
<ul>
<li>每个挂载的文件系统，VFS都会创建一个<code>vfsmount</code>(用来表示挂载的文件系统)、<code>super_block</code> 对象</li>
<li>该对象描述了文件系统 mount 的所有信息</li>
<li>父文件系统的挂载点：vfsmount-&gt;mnt_mountpoint = /mnt</li>
<li>子文件系统的根目录：vfsmount-&gt;mnt_root = superblock-&gt;s_root</li>
<li>初始化好 vfsmount 对象后，将该对象添加到 VFSMOUNT hash table中</li>
</ul>
<h3 id="文件路径解析-1"><a href="#文件路径解析-1" class="headerlink" title="文件路径解析"></a>文件路径解析</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415173003.png"></p>
<p>目录项</p>
<ul>
<li>若目录项 <code>dentry</code> 标记为 DCACHE_MOUNTED，路径解析时对该目录 /mnt 项屏蔽</li>
<li>计算该目录的 HASH 值， 根据值去 VMSMOUNT hash table 中查找对应的 <code>vfsmount</code> 对象</li>
<li>根据 <code>vfsmount-&gt;mnt_root</code>，找到子文件系统的根目录</li>
<li>查找子文件系统指定目录下的文件</li>
</ul>
<h2 id="文件系统的类型"><a href="#文件系统的类型" class="headerlink" title="文件系统的类型"></a>文件系统的类型</h2><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415184606.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415184806.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415185516.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415190156.png"></p>
<h2 id="虚拟文件系统：VFS"><a href="#虚拟文件系统：VFS" class="headerlink" title="虚拟文件系统：VFS"></a>虚拟文件系统：VFS</h2><h3 id="VFS"><a href="#VFS" class="headerlink" title="VFS"></a>VFS</h3><p>虚拟文件系统</p>
<ul>
<li>virtual file system</li>
<li>基于内核和存储设备之间的抽象层</li>
<li>向上：统一封装了不同设备、文件系统的读写接口：<strong>系统调用API</strong></li>
<li>向下：新的设备、文件系统添加到Linux内核，<strong>实现VFS接口即可</strong></li>
<li>Linux内核支持60+种不同类型的文件系统</li>
</ul>
<p>Linux系统中的VFS</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230415193852.png"></p>
<h3 id="VFS对象类型"><a href="#VFS对象类型" class="headerlink" title="VFS对象类型"></a>VFS对象类型</h3><p>对象类型</p>
<ul>
<li>super_block: 已经安装的具体的文件系统</li>
<li>inode: 代表一个具体的文件</li>
<li>dentry: 目录项，目录项路径的组成部分</li>
<li>file: 进程打开的文件</li>
</ul>
<p>对象方法</p>
<ul>
<li>super_operations: alloc_inode、write_inode、destroy_inode</li>
<li>inode_operations: link、mknod、mkdir、rename、create</li>
<li>dentry_opertions: d_hash、d_compare、d_delete、d_release</li>
<li>file_operations: read、write、open、close、fsync、mmap</li>
</ul>
<h3 id="通过OOP理解VFS"><a href="#通过OOP理解VFS" class="headerlink" title="通过OOP理解VFS"></a>通过OOP理解VFS</h3><p>VFS中面向对象的思想</p>
<ul>
<li>封装：file-&gt;file_operations</li>
<li>继承：write_inode、ext2_write_inode</li>
<li>多态：callback</li>
</ul>
<h2 id="文件描述符-1"><a href="#文件描述符-1" class="headerlink" title="文件描述符"></a>文件描述符</h2><h3 id="程序中如何操作文件"><a href="#程序中如何操作文件" class="headerlink" title="程序中如何操作文件"></a>程序中如何操作文件</h3><p>文件描述符</p>
<ul>
<li>Linux进程使用文件描述符(<em>file descriptors</em>,简称<em>fd</em>)来操作文件</li>
<li>int fd = open (“/home/wit/hello.txt”, O_WRONLY, 0666);</li>
<li>read (fd, buf, 100);</li>
</ul>
<p>结构体<code>files_struct</code></p>
<ul>
<li>用来表示一个进程打开的文件列表</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span> count;</span><br><span class="line">    <span class="keyword">bool</span> resize_in_progress;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> resize_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> __<span class="title">rcu</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> <span class="title">fdtab</span>;</span></span><br><span class="line">    <span class="keyword">int</span> next_fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> close_on_exec_init[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> open_fds_init[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> full_fds_bits_init[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> * <span class="title">fd_array</span>[<span class="title">NR_OPEN_DEFAULT</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> <span class="title">fu_llist</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">fu_rcuhead</span>;</span></span><br><span class="line">    &#125; f_u; <span class="comment">//所有打开的文件构成一个系统级的全局双链表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">f_path</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">f_inode</span>;</span> <span class="comment">//inode节点</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">f_op</span>;</span> <span class="comment">//该文件的读写方法</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> f_lock;</span><br><span class="line">    <span class="keyword">atomic_long_t</span> f_count;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> f_flags;</span><br><span class="line">    <span class="keyword">fmode_t</span> f_mode; <span class="comment">//打开模式</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">f_pos_lock</span>;</span></span><br><span class="line">    <span class="keyword">loff_t</span> f_pos; <span class="comment">//文件当前位置</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span> <span class="title">f_owner</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">f_cred</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span> <span class="title">f_ra</span>;</span></span><br><span class="line">    u64 f_version;</span><br><span class="line">    <span class="keyword">void</span> *private_data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">f_mapping</span>;</span></span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>



<h3 id="一个进程打开的文件"><a href="#一个进程打开的文件" class="headerlink" title="一个进程打开的文件"></a>一个进程打开的文件</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416095900.png"></p>
<p>文件描述符就是 file指针 在<code>fd_array</code>（进程打开的文件列表）中的偏移</p>
<h2 id="文件指针"><a href="#文件指针" class="headerlink" title="文件指针"></a>文件指针</h2><h3 id="通过C库函数操作文件"><a href="#通过C库函数操作文件" class="headerlink" title="通过C库函数操作文件"></a>通过C库函数操作文件</h3><p>文件指针</p>
<ul>
<li><p>C标准库函数</p>
<ul>
<li><p>C标准库函数使用文件指针来操作文件</p>
</li>
<li><p>FILE *fp = fopen(“/home/wit/hello.txt”, “w+”);</p>
</li>
<li><p>fread (buf, 4, 100, fp);</p>
</li>
</ul>
</li>
</ul>
<h3 id="C语言中的文件指针FILE"><a href="#C语言中的文件指针FILE" class="headerlink" title="C语言中的文件指针FILE*"></a>C语言中的文件指针FILE*</h3><p>对文件描述符的封装</p>
<ul>
<li><p>文件描述符：fd</p>
</li>
<li><p>文件位置:f_fops</p>
</li>
<li><p>缓冲区</p>
<ul>
<li>为了提高效率，会在用户空间申请缓冲区</li>
</ul>
</li>
<li><p>文件标志:f_mod</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> <span class="title">FILE</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">     <span class="keyword">int</span> _flags;</span><br><span class="line">     <span class="keyword">char</span>* _IO_read_ptr; <span class="comment">/* Current read pointer */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_read_end; <span class="comment">/* End of get area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_read_base; <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_write_ptr; <span class="comment">/* Current put pointer. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_write_end; <span class="comment">/* End of put area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_buf_base; <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_buf_end; <span class="comment">/* End of reserve area. */</span></span><br><span class="line">     <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">     <span class="keyword">char</span> *_IO_backup_base; <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">     <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">     <span class="keyword">int</span> _fileno; <span class="comment">// 文件描述符</span></span><br><span class="line">     _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="标准流"><a href="#标准流" class="headerlink" title="标准流"></a>标准流</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416101927.png"></p>
<h2 id="硬链接和软链接"><a href="#硬链接和软链接" class="headerlink" title="硬链接和软链接"></a>硬链接和软链接</h2><h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>Linux下一种文件共享的方式，类似于Windows下的快捷方式</p>
<p>一个文件使用多个别名：多个文件名共享一个inode</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416102918.png"></p>
<h3 id="硬链接"><a href="#硬链接" class="headerlink" title="硬链接"></a>硬链接</h3><p>硬链接和文件有相同的 inode 和 data block</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416102935.png"></p>
<h3 id="软链接"><a href="#软链接" class="headerlink" title="软链接"></a>软链接</h3><ul>
<li>软链接是一个普通文件，文件内容为：指向文件的路径名</li>
<li>有自己的 inode编号 和 data block ，文件权限、属性…</li>
<li>删除软链接并不会影响到其指向文件本身</li>
<li>Windows 的快捷方式</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416103419.png"></p>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><h4 id="给文件创建一个硬链接"><a href="#给文件创建一个硬链接" class="headerlink" title="给文件创建一个硬链接"></a>给文件创建一个硬链接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln hello.c hello-hardlink.c</span><br></pre></td></tr></table></figure>

<p>使用 <code>ls -i</code> 命令看到两个文件 inode编号 相同</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416104615.png"></p>
<h4 id="给文件创建一个软链接"><a href="#给文件创建一个软链接" class="headerlink" title="给文件创建一个软链接"></a>给文件创建一个软链接</h4><p>使用 <code>ln -s</code> 命令创建一个软链接</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s hello.c hello-softlink.c</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416105132.png"></p>
<h3 id="软链接和硬链接的区别"><a href="#软链接和硬链接的区别" class="headerlink" title="软链接和硬链接的区别"></a>软链接和硬链接的区别</h3><p>硬链接</p>
<ul>
<li>只能对存在的文件创建硬链接</li>
<li>不能对目录创建硬链接</li>
<li>创建硬链接不能跨越文件系统分区</li>
</ul>
<p>软链接</p>
<ul>
<li>可以对不存在的文件或目录创建软链接</li>
<li>可以对目录创建软链接</li>
<li>可以跨越文件系统分区创建软链接</li>
</ul>
<h4 id="为什么硬链接不能跨越文件系统或分区创建？-为什么软链接可以跨越文件系统或分区创建？"><a href="#为什么硬链接不能跨越文件系统或分区创建？-为什么软链接可以跨越文件系统或分区创建？" class="headerlink" title="为什么硬链接不能跨越文件系统或分区创建？ 为什么软链接可以跨越文件系统或分区创建？"></a>为什么硬链接不能跨越文件系统或分区创建？ 为什么软链接可以跨越文件系统或分区创建？</h4><blockquote>
<p>来自chatGPT的回答：在Linux和其他类UNIX系统上，硬链接是一种文件系统对象，它允许多个文件名引用同一个物理文件。硬链接与原始文件具有相同的inode号码，因此它们实际上是指向同一个数据块的不同文件名。</p>
<p>然而，硬链接不能跨越文件系统或分区创建是因为不同的文件系统或分区有不同的inode号码空间。在一个文件系统或分区中，每个inode号码都是唯一的，但是在不同的文件系统或分区中，相同的inode号码可能会被分配给不同的文件。因此，如果尝试在不同的文件系统或分区中创建硬链接，则会遇到inode号码冲突的问题，因此硬链接不支持跨越文件系统或分区创建。</p>
<p>相反，软链接（也称为符号链接）可以跨越文件系统或分区创建，因为它们只是一个指向另一个文件的符号引用，它们与原始文件具有不同的inode号码。在创建软链接时，文件系统会创建一个新文件，该文件包含指向原始文件的路径名。因此，软链接不受inode号码空间的限制。</p>
</blockquote>
<blockquote>
<p>来自Claude的回答：硬链接不能跨越文件系统或分区创建的原因是:硬链接实际上是指向同一个inode的多个目录项。inode存储在文件系统的inode表中,记录了文件的元信息和数据块索引信息。不同的文件系统或分区有独立的inode表,彼此之间的inode编号没有对应关系。所以,如果在不同的文件系统或分区创建硬链接,实际上会创建两个不同的inode,而不是指向同一个inode。这就失去了硬链接的意义。举个例子,假设有两个分区,分区1中有一个文件file,其inode号是12345。现在在分区1中创建一个硬链接link1指向file,然后在分区2中也创建一个名为link2的硬链接指向file。实际上,link2指向的不是分区1的inode 12345,而是分区2中的一个新的inode,因为两个分区的inode表是独立的。所以link1和link2指向的并不是同一个文件,这就违背了硬链接的定义。硬链接创建失败。硬链接依赖单个文件系统共享的inode资源来实现多个文件名指向同一文件。一旦跨文件系统或分区,这个前提就不复存在了。相比之下,软链接则可以跨文件系统与分区创建,这是因为软链接包含的是一个路径,path可以跨越文件系统与分区,指向不同目录下的文件。软链接的实现与文件系统或分区的内部机制无关,它只是一个包含路径的文件。而硬链接则依赖文件系统的inode机制,这也是二者最大的区别所在。所以,总结起来,硬链接不能跨文件系统或分区创建的原因有:1. 不同文件系统或分区有独立的inode表,inode编号无对应关系。2. 硬链接依赖共享同一个inode来实现同步更新多个文件名指向的文件。跨文件系统/分区时,无法找到同一个inode。3. 硬链接的本质是多个目录项指向同一文件,要求在同一个文件命名空间内。不同文件系统/分区有独立的文件命名空间。理解硬链接与软链接的区别与实现机制,是Unix/Linux系统管理员必备的知识点。这也有助于我们更深入学习文件系统与存储管理的原理。</p>
</blockquote>
<h4 id="为什么不能不能对目录创建硬链接？"><a href="#为什么不能不能对目录创建硬链接？" class="headerlink" title="为什么不能不能对目录创建硬链接？"></a>为什么不能不能对目录创建硬链接？</h4><blockquote>
<p>来自 Claude 的回答：</p>
<ol>
<li><p>硬链接实际上是多个目录项指向同一个inode。如果对目录创建硬链接,当目录中的内容发生变化时,由于硬链接的同步更新性质,可能导致目录层次混乱或循环引用。这违反了典型的目录树结构。</p>
</li>
<li><p>目录中包含的条目会随子目录和文件创建与删除动态变化。如果有多个硬链接指向同一目录,那么 inode 中的数据块索引信息就会因此无限增加,极易出现inode数据块溢出的情况。这影响文件系统的稳定性。</p>
</li>
<li><p> 不同硬链接之间,子目录和文件是共享的。这可能导致权限管理混乱,从而威胁系统安全性。如果删除某个硬链接目录,会导致其他硬链接下的文件也被删除,这违背常理。</p>
</li>
<li><p>硬链接的存取时间等都与源目录相同。但目录作为一个独立的文件系统对象,其元信息应独立于其他硬链接。这也体现了目录在模型抽象级别上应该作为一个独立实体。</p>
</li>
<li><p>许多文件系统的设计和实现都假定目录无法产生循环,目录树结构必须是典型的单向树形结构。如果允许对目录创建硬链接,这一前提将不复存在,需要对文件系统的逻辑进行重大修改。</p>
</li>
</ol>
<p>所以,总结来说,不能对目录创建硬链接的主要原因是:1) 它违反典型的目录树结构与父子关系。2) 会导致inode数据块索引信息无限增长,威胁文件系统稳定性。3) 会导致权限管理混乱,影响系统安全性。4) 硬链接具有同步更新的性质,但目录需要作为独立文件系统对象。5) 现有的文件系统设计假定目录无法产生循环,不支持对目录创建硬链接。综上,允许对目录创建硬链接将会给文件系统带来难以掌握的副作用与后果。这也违反了Unix/Linux的哲学,即“使简单事情保持简单”。所以在文件系统的设计与实现中,约定俗成地禁止了对目录设置硬链接。理解这一约束的来龙去脉,有助于我们进一步理解Unix/Linux风格的文件系统架构与设计思想。这同样也让我们对日常管理系统文件的行为有所警醒,不会误触这一潜在的“雷区”。所以这也是成为一名优秀系统管理员所必备的知识点与技能。</p>
</blockquote>
<h2 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h2><h3 id="跟-FS-相关"><a href="#跟-FS-相关" class="headerlink" title="跟 FS 相关"></a>跟 FS 相关</h3><ul>
<li><p>mount</p>
</li>
<li><p>mkdir/rmdir/chmod/chown/</p>
</li>
<li><p>df、du、wc</p>
</li>
</ul>
<h3 id="磁盘管理"><a href="#磁盘管理" class="headerlink" title="磁盘管理"></a>磁盘管理</h3><p>统计磁盘使用率：$ df -h</p>
<p>统计目录：$ du</p>
<h3 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h3><p>• 当前目录下的C文件个数：$ find . -name “*.c” | wc -l </p>
<p>• 当前目录下(包括子目录)的文件个数：$ ls –lR | grep “^-” | wc –l </p>
<p>• 一个项目的总目录个数：$ ls –lR | grep “^d” | wc –l</p>
<p>• 一个项目的代码总行数：$ find . -name “*.c” |xargs cat | wc -l  </p>
<h2 id="实验：磁盘格式化及挂载"><a href="#实验：磁盘格式化及挂载" class="headerlink" title="实验：磁盘格式化及挂载"></a>实验：磁盘格式化及挂载</h2><p>使用磁盘基本步骤</p>
<p>• 格式化、分区</p>
<p>• 安装文件系统</p>
<p>• 挂载：将磁盘挂载到我们电脑上的某个目录上 </p>
<h3 id="分区格式化"><a href="#分区格式化" class="headerlink" title="分区格式化"></a>分区格式化</h3><p>当新建一个硬盘，此时在 /dev/ 目录下多了一个 <code>sdb</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151434.png"></p>
<p>此时它还没有挂载</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151454.png"></p>
<p>直接进行挂载，行不通</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151521.png"></p>
<p>需要进行格式化、分区</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151824.png"></p>
<p>通过命令来进行格式化，敲入 m 进入菜单</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416151919.png"></p>
<p>使用 n 添加一个分区</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152201.png"></p>
<p>使用 p 添加主分区</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152406.png"></p>
<p>剩下的默认即可，完成分区</p>
<p>添加分区后，查看 /dev/</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152513.png"></p>
<p>发现多了一个 sdb1</p>
<h3 id="安装文件系统"><a href="#安装文件系统" class="headerlink" title="安装文件系统"></a>安装文件系统</h3><p>Linux 有不同的命令安装文件系统</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152901.png"></p>
<p>使用 <code>mkfs.ex4</code> 命令安装 <code>ext4</code> 文件系统</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416152946.png"></p>
<p>划分了不同的 datablock inode  superBlock， 此时就安装好了文件系统</p>
<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><p>使用 mount 命令挂载到 /mnt 目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t ext4 /dev/sdb1 /mnt/</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416153731.png"></p>
<p>此时就可以直接对这块磁盘进行操作了</p>
<p>通过 umount 命令进行卸载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/</span><br></pre></td></tr></table></figure>

<p>再次查看 /mnt/ 目录，就会看到原来显示的内容</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416154248.png"></p>
<h2 id="实验：恢复删除的文件"><a href="#实验：恢复删除的文件" class="headerlink" title="实验：恢复删除的文件"></a>实验：恢复删除的文件</h2><h3 id="rm-命令…"><a href="#rm-命令…" class="headerlink" title="rm 命令…."></a>rm 命令….</h3><p>文件删除的背后</p>
<ul>
<li>并没有真正删除数据，当 inode 链接计数 &gt; 1时</li>
<li>仅删除了文件名和 inode 之间的关联：清除了目录项中 inode 指针信息 </li>
</ul>
<h3 id="真正的文件删除"><a href="#真正的文件删除" class="headerlink" title="真正的文件删除"></a>真正的文件删除</h3><ul>
<li>当 inode 的链接计数为1时</li>
<li>将目录项中的文件名和 inode 对应关系删除</li>
<li>将该文件 inode 的 block 指针删除</li>
<li>在 inode bitmap 中将文件 inode 标记为 未用</li>
<li>将 block bitmap 中将文件的 data block 标记为 未用</li>
<li>ext 日志文件系统：把删除文件的 inode 信息和 文件名 写入日志</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416155813.png"></p>
<p>如果 data block 还没有被其它文件占用，还是可以恢复的</p>
<h3 id="删除恢复的文件"><a href="#删除恢复的文件" class="headerlink" title="删除恢复的文件"></a>删除恢复的文件</h3><p>基本步骤</p>
<p>• $ apt-get install extundelete</p>
<p>• $ extundelete –inode 2 /dev/sdb1</p>
<p>• $ extundelete /dev/sdb1 –restore-file /home/wit/hello.c</p>
<p>• $ extundelete /dev/sda1 –restore-inode 1122</p>
<p>• $ extundelete /dev/sdb1 –restore-directory /home/wit/test</p>
<h1 id="文件IO编程实战"><a href="#文件IO编程实战" class="headerlink" title="文件IO编程实战"></a>文件IO编程实战</h1><h2 id="文件的打开模式"><a href="#文件的打开模式" class="headerlink" title="文件的打开模式"></a>文件的打开模式</h2><h3 id="文件的基本操作"><a href="#文件的基本操作" class="headerlink" title="文件的基本操作"></a>文件的基本操作</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416164036.png"></p>
<h3 id="系统调用open"><a href="#系统调用open" class="headerlink" title="系统调用open"></a>系统调用open</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416173031.png"></p>
<h3 id="文件的打开模式-1"><a href="#文件的打开模式-1" class="headerlink" title="文件的打开模式"></a>文件的打开模式</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416173244.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416173307.png"></p>
<p>主参数和副参数可以通过 | 组合使用</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416174832.png"></p>
<h3 id="文件的关闭"><a href="#文件的关闭" class="headerlink" title="文件的关闭"></a>文件的关闭</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416174844.png"></p>
<h3 id="当创建不存在的文件时"><a href="#当创建不存在的文件时" class="headerlink" title="当创建不存在的文件时"></a>当创建不存在的文件时</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416175302.png"></p>
<h2 id="文件的读写权限"><a href="#文件的读写权限" class="headerlink" title="文件的读写权限"></a>文件的读写权限</h2><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416193724.png"></p>
<h3 id="修改读写权限"><a href="#修改读写权限" class="headerlink" title="修改读写权限"></a>修改读写权限</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416194911.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416200954.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416201007.png"></p>
<h2 id="文件的读写函数"><a href="#文件的读写函数" class="headerlink" title="文件的读写函数"></a>文件的读写函数</h2><h3 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416201222.png"></p>
<h3 id="read函数解析"><a href="#read函数解析" class="headerlink" title="read函数解析"></a>read函数解析</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416201408.png"></p>
<h3 id="编程实战实现cat功能"><a href="#编程实战实现cat功能" class="headerlink" title="编程实战实现cat功能"></a>编程实战实现cat功能</h3><ol>
<li>打开一个文本文件</li>
<li>读取文本文件的内容，保存到一个内存缓冲区内</li>
<li>打印缓冲区里的数据到标准输出终端</li>
<li>循环第二步，直到文件末尾</li>
<li>关闭打开的文件</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage:\n cat filename\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> srcfd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (srcfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">512</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> ((len = read(srcfd, buffer, <span class="number">512</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (len != <span class="number">512</span>) buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);pGt</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(srcfd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="文件的读写位置和定位"><a href="#文件的读写位置和定位" class="headerlink" title="文件的读写位置和定位"></a>文件的读写位置和定位</h2><h3 id="文件的读写位置"><a href="#文件的读写位置" class="headerlink" title="文件的读写位置"></a>文件的读写位置</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416204430.png"></p>
<h3 id="改变文件偏移量"><a href="#改变文件偏移量" class="headerlink" title="改变文件偏移量"></a>改变文件偏移量</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416204941.png"></p>
<h3 id="文件空洞"><a href="#文件空洞" class="headerlink" title="文件空洞"></a>文件空洞</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416205538.png"></p>
<p>有文件空洞的文件称为稀疏文件</p>
<p>• 字符设备、Socket、终端设备等流式设备不支持lseek</p>
<p>• 管道、FIFO不支持lseek</p>
<h2 id="获取文件的属性信息"><a href="#获取文件的属性信息" class="headerlink" title="获取文件的属性信息"></a>获取文件的属性信息</h2><h3 id="文件属性"><a href="#文件属性" class="headerlink" title="文件属性"></a>文件属性</h3><p>文件数据的存储</p>
<ul>
<li>纯数据：存储在 datablock 中</li>
<li>元数据：存储在 inode table 中</li>
<li>文件名：存储在目录文件的目录项中</li>
</ul>
<p>元数据：</p>
<ul>
<li>文件时间戳</li>
<li>文件权限</li>
<li>文件所有权</li>
<li>文件存储地址</li>
<li>链接数</li>
</ul>
<h3 id="获取文件的元数据"><a href="#获取文件的元数据" class="headerlink" title="获取文件的元数据"></a>获取文件的元数据</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230416211921.png"></p>
<p>结构体：stat</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">    <span class="keyword">dev_t</span> st_dev; <span class="comment">/* ID of device containing file */</span></span><br><span class="line">    <span class="keyword">ino_t</span> st_ino; <span class="comment">/* inode number */</span></span><br><span class="line">    <span class="keyword">mode_t</span> st_mode; <span class="comment">/* protection */</span></span><br><span class="line">    <span class="keyword">nlink_t</span> st_nlink; <span class="comment">/* number of hard links */</span></span><br><span class="line">    <span class="keyword">uid_t</span> st_uid; <span class="comment">/* user ID of owner */</span></span><br><span class="line">    <span class="keyword">gid_t</span> st_gid; <span class="comment">/* group ID of owner */</span></span><br><span class="line">    <span class="keyword">dev_t</span> st_rdev; <span class="comment">/* device ID (if special file) */</span></span><br><span class="line">    <span class="keyword">off_t</span> st_size; <span class="comment">/* total size, in bytes */</span></span><br><span class="line">    <span class="keyword">blksize_t</span> st_blksize; <span class="comment">/* blocksize for filesystem I/O */</span></span><br><span class="line">    <span class="keyword">blkcnt_t</span> st_blocks; <span class="comment">/* number of 512B blocks allocated */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_atim</span>;</span> <span class="comment">/* time of last access */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_mtim</span>;</span> <span class="comment">/* time of last modification */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_ctim</span>;</span> <span class="comment">/* time of last status change */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="实现shell命令-ll"><a href="#实现shell命令-ll" class="headerlink" title="实现shell命令: ll"></a>实现shell命令: ll</h2><h3 id="getpwuid函数"><a href="#getpwuid函数" class="headerlink" title="getpwuid函数"></a>getpwuid函数</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417091909.png"></p>
<h3 id="getgrgid函数"><a href="#getgrgid函数" class="headerlink" title="getgrgid函数"></a>getgrgid函数</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417091934.png"></p>
<h3 id="文件元数据"><a href="#文件元数据" class="headerlink" title="文件元数据"></a>文件元数据</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417092000.png"></p>
<h3 id="文件类型-权限"><a href="#文件类型-权限" class="headerlink" title="文件类型+权限"></a>文件类型+权限</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417092026.png"></p>
<h3 id="测试宏"><a href="#测试宏" class="headerlink" title="测试宏"></a>测试宏</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417092103.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;grp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">find_user_name_by_uid</span><span class="params">(<span class="keyword">uid_t</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> * <span class="title">passwd_ptr</span>;</span></span><br><span class="line">    passwd_ptr = getpwuid (uid);</span><br><span class="line">    <span class="keyword">if</span> (passwd_ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> uid_string[<span class="number">10</span>];</span><br><span class="line">        <span class="built_in">sprintf</span>(uid_string, <span class="string">&quot;%d&quot;</span>, uid);</span><br><span class="line">        <span class="keyword">return</span> uid_string;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> passwd_ptr-&gt;pw_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">find_group_name_by_gid</span> <span class="params">(<span class="keyword">gid_t</span> gid)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">    group_ptr = getgrgid(gid);</span><br><span class="line">    <span class="keyword">if</span> (group_ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> gid_string[<span class="number">10</span>];</span><br><span class="line">        <span class="built_in">sprintf</span>(gid_string, <span class="string">&quot;%d&quot;</span>, gid);</span><br><span class="line">        <span class="keyword">return</span> gid_string;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> group_ptr-&gt;gr_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">change_mode_to_string</span> <span class="params">(<span class="keyword">mode_t</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> mode_string[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span> (mode_string, <span class="string">&quot;----------&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;d&#x27;</span>;    </span><br><span class="line">    <span class="keyword">if</span> (S_ISCHR(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;c&#x27;</span>;    </span><br><span class="line">    <span class="keyword">if</span> (S_ISBLK(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;b&#x27;</span>;    </span><br><span class="line">    <span class="keyword">if</span> (S_ISLNK(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;l&#x27;</span>;    </span><br><span class="line">    <span class="keyword">if</span> (S_ISFIFO(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;f&#x27;</span>;    </span><br><span class="line">    <span class="keyword">if</span> (S_ISSOCK(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;s&#x27;</span>;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IRUSR) mode_string[<span class="number">1</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IWUSR) mode_string[<span class="number">2</span>] = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IXUSR) mode_string[<span class="number">3</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IRGRP) mode_string[<span class="number">4</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IWGRP) mode_string[<span class="number">5</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IXGRP) mode_string[<span class="number">6</span>] = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IROTH) mode_string[<span class="number">7</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IWOTH) mode_string[<span class="number">8</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IXOTH) mode_string[<span class="number">9</span>] = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mode_string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat (argv[<span class="number">1</span>], &amp;buf) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;stat&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, change_mode_to_string(buf.st_mode));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu &quot;</span>, buf.st_nlink);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, find_user_name_by_uid (buf.st_uid));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, find_group_name_by_gid (buf.st_gid));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%ld &quot;</span>, buf.st_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, ctime (&amp;buf.st_atime) );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417110711.png"></p>
<h2 id="读取目录文件"><a href="#读取目录文件" class="headerlink" title="读取目录文件"></a>读取目录文件</h2><p>文件存储</p>
<p>• 文件数据：存放在data block中</p>
<p>• 文件属性：存放在inode中</p>
<p>• 文件名：若干目录项组成的表格，存放在目录块中(data block)</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417145407.png"></p>
<h3 id="打开目录文件"><a href="#打开目录文件" class="headerlink" title="打开目录文件"></a>打开目录文件</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417150041.png"></p>
<h3 id="目录项"><a href="#目录项" class="headerlink" title="目录项"></a>目录项</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417150334.png"></p>
<h3 id="编程实现ls命令"><a href="#编程实现ls命令" class="headerlink" title="编程实现ls命令"></a>编程实现ls命令</h3><p>实现ls 命令，显示当前目录下的所有文件(普通文件、目录)</p>
<p>• 第1步：打开一个目录文件</p>
<p>• 第2步：读取目录文件，返回一个目录项</p>
<p>• 第3步：显示这个目录项</p>
<p>• 第4步：循环第2、3步，直到读取文件末尾</p>
<p>• 第5步：关闭这个目录文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    DIR * dir_ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">entry_ptr</span>;</span> </span><br><span class="line">    dir_ptr = opendir(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((entry_ptr = readdir (dir_ptr)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (++ count % <span class="number">10</span> == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%6s&quot;</span>, entry_ptr-&gt;d_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现ls命令：支持多个目录"><a href="#实现ls命令：支持多个目录" class="headerlink" title="实现ls命令：支持多个目录"></a>实现ls命令：支持多个目录</h2><p>实现思路</p>
<p>• 当ls命令无参数时，默认显示当前目录的内容</p>
<p>• 当有参数时，显示指定目录的内容</p>
<p>• 支持多个目录参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_ls</span> <span class="params">(<span class="keyword">char</span> pathname[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;   </span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</span><br><span class="line">        do_ls(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> ( --argc) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, *++argv);</span><br><span class="line">            do_ls(*argv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_ls</span> <span class="params">(<span class="keyword">char</span> pathname[])</span> </span>&#123;</span><br><span class="line">    DIR * dir_ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">entry_ptr</span>;</span> </span><br><span class="line">    dir_ptr = opendir(pathname);</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((entry_ptr = readdir (dir_ptr)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (++ count % <span class="number">10</span> == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, entry_ptr-&gt;d_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    closedir (dir_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现ls命令：支持-c参数"><a href="#实现ls命令：支持-c参数" class="headerlink" title="实现ls命令：支持-c参数"></a>实现ls命令：支持-c参数</h2><p>实现思路</p>
<p>• 第1步：在main函数中解析命令行参数，看一下是否有-c这个参数</p>
<p>• 第2步：在do_ls函数中，增加对-c参数的支持</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_ls</span> <span class="params">(<span class="keyword">char</span> pathname[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> c_flag;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;   </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[i], <span class="string">&quot;-c&quot;</span>) == <span class="number">0</span>) c_flag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span> || (argc == <span class="number">2</span> &amp;&amp; c_flag == <span class="number">1</span>)) &#123;</span><br><span class="line">        do_ls(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> ( --argc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(*++argv, <span class="string">&quot;-c&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s:\n&quot;</span>, *argv);</span><br><span class="line">            do_ls(*argv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_ls</span> <span class="params">(<span class="keyword">char</span> pathname[])</span> </span>&#123;</span><br><span class="line">    DIR * dir_ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">entry_ptr</span>;</span> </span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    dir_ptr = opendir(pathname);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dir_ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;opendir&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((entry_ptr = readdir (dir_ptr)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span> (entry_ptr-&gt;d_name, <span class="string">&quot;.&quot;</span>) == <span class="number">0</span>) <span class="keyword">continue</span>; </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span> (entry_ptr-&gt;d_name, <span class="string">&quot;..&quot;</span>) == <span class="number">0</span>) <span class="keyword">continue</span>; </span><br><span class="line">        <span class="keyword">if</span> (c_flag == <span class="number">1</span> &amp;&amp; <span class="built_in">strcmp</span> (entry_ptr-&gt;d_name + <span class="built_in">strlen</span> (entry_ptr-&gt;d_name) - <span class="number">2</span>, <span class="string">&quot;.c&quot;</span>)) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (++ count % <span class="number">10</span> == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, entry_ptr-&gt;d_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    closedir (dir_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现ls命令：支持-l参数"><a href="#实现ls命令：支持-l参数" class="headerlink" title="实现ls命令：支持-l参数"></a>实现ls命令：支持-l参数</h2> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;grp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libgen.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_ls</span> <span class="params">(<span class="keyword">char</span> pathname[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_ll</span> <span class="params">(<span class="keyword">char</span> filename[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> c_flag;</span><br><span class="line"><span class="keyword">int</span> l_flag;</span><br><span class="line"><span class="keyword">int</span> dir_count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_param</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[i], <span class="string">&quot;-c&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            c_flag = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[i], <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span>) </span><br><span class="line">            l_flag = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            dir_count ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    check_param (argc, argv);</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span> || dir_count == <span class="number">0</span>)</span><br><span class="line">        do_ls (<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">while</span> (--argc)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span> (*++argv, <span class="string">&quot;-c&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span> (*argv, <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span>) </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;%s:\n&quot;</span>, *argv);</span><br><span class="line">            do_ls (*argv);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_ls</span> <span class="params">(<span class="keyword">char</span> pathname[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DIR *dir_ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry_ptr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    dir_ptr = opendir (pathname);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dir_ptr == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror (<span class="string">&quot;opendir&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((entry_ptr = readdir (dir_ptr)) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">strcmp</span> (entry_ptr-&gt;d_name, <span class="string">&quot;.&quot;</span>) &amp;&amp; <span class="built_in">strcmp</span> (entry_ptr-&gt;d_name, <span class="string">&quot;..&quot;</span>)) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (c_flag)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span> (entry_ptr-&gt;d_name + <span class="built_in">strlen</span> (entry_ptr-&gt;d_name) <span class="number">-2</span>, <span class="string">&quot;.c&quot;</span>))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (++count % <span class="number">10</span> == <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (l_flag) &#123;</span><br><span class="line">            <span class="keyword">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">            <span class="built_in">strcpy</span> (tmp, pathname);</span><br><span class="line">            <span class="built_in">strcat</span> (tmp, entry_ptr-&gt;d_name);</span><br><span class="line">            print_ll (tmp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;%s &quot;</span>, entry_ptr-&gt;d_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    closedir (dir_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">change_mode_to_string</span><span class="params">(<span class="keyword">mode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> mode_string[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">strcpy</span> (mode_string, <span class="string">&quot;----------&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISCHR(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISBLK(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISLNK(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISFIFO(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;f&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISSOCK(mode)) mode_string[<span class="number">0</span>] = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IRUSR) mode_string[<span class="number">1</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IWUSR) mode_string[<span class="number">2</span>] = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IXUSR) mode_string[<span class="number">3</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IRGRP) mode_string[<span class="number">4</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IWGRP) mode_string[<span class="number">5</span>] = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IXGRP) mode_string[<span class="number">6</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IROTH) mode_string[<span class="number">7</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IWOTH) mode_string[<span class="number">8</span>] = <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (mode &amp; S_IXOTH) mode_string[<span class="number">9</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mode_string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">find_user_name_by_uid</span> <span class="params">(<span class="keyword">uid_t</span> uid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">passwd_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">    passwd_ptr = getpwuid (uid);</span><br><span class="line">    <span class="keyword">if</span> (passwd_ptr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> uid_string[<span class="number">10</span>];</span><br><span class="line">        <span class="built_in">sprintf</span> (uid_string, <span class="string">&quot;%d&quot;</span>, uid);</span><br><span class="line">        <span class="keyword">return</span> uid_string;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> passwd_ptr-&gt;pw_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">find_group_name_by_gid</span> <span class="params">(<span class="keyword">gid_t</span> gid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">group_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">    group_ptr = getgrgid (gid);</span><br><span class="line">    <span class="keyword">if</span> (group_ptr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> gid_string[<span class="number">10</span>];</span><br><span class="line">        <span class="built_in">sprintf</span> (gid_string, <span class="string">&quot;%d&quot;</span>, gid);</span><br><span class="line">        <span class="keyword">return</span> gid_string;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> group_ptr-&gt;gr_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_ll</span> <span class="params">(<span class="keyword">char</span> filename[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat (filename, &amp;buf) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;stat&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%-6s &quot;</span>, basename(filename));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s &quot;</span>, change_mode_to_string (buf.st_mode));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%lu &quot;</span>, buf.st_nlink);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s &quot;</span>, find_user_name_by_uid (buf.st_uid));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s &quot;</span>, find_group_name_by_gid (buf.st_gid));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%ld &quot;</span>, buf.st_size);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s &quot;</span>, ctime (&amp;buf.st_atime));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="目录的其它相关操作"><a href="#目录的其它相关操作" class="headerlink" title="目录的其它相关操作"></a>目录的其它相关操作</h2><h3 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417202454.png"></p>
<h3 id="路径操作"><a href="#路径操作" class="headerlink" title="路径操作"></a>路径操作</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417202543.png"></p>
<h3 id="链接-1"><a href="#链接-1" class="headerlink" title="链接"></a>链接</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417202633.png"></p>
<h2 id="相对路径转绝对路径"><a href="#相对路径转绝对路径" class="headerlink" title="相对路径转绝对路径"></a>相对路径转绝对路径</h2><h3 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230417203325.png"></p>
<h3 id="实现shell命令：pwd"><a href="#实现shell命令：pwd" class="headerlink" title="实现shell命令：pwd"></a>实现shell命令：pwd</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">128</span>];</span><br><span class="line">    getcwd(buffer, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="将一个文件名转换为绝对路径-文件名的形式"><a href="#将一个文件名转换为绝对路径-文件名的形式" class="headerlink" title="将一个文件名转换为绝对路径+ 文件名的形式"></a>将一个文件名转换为绝对路径+ 文件名的形式</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">128</span>];</span><br><span class="line">    getcwd (buffer, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcat</span> (buffer, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span> (buffer, argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="编程实战：实现-wc-命令"><a href="#编程实战：实现-wc-命令" class="headerlink" title="编程实战：实现 wc 命令"></a>编程实战：实现 wc 命令</h2><h3 id="编程实战"><a href="#编程实战" class="headerlink" title="编程实战"></a>编程实战</h3><p>• 编写一个工具wc，统计Linux最新内核源码：</p>
<p>• 一共有多少个C文件？</p>
<p>• 一共有多少个H文件？</p>
<p>• 一共有多少个汇编文件？</p>
<p>• 一共有多少个words、行？</p>
<p>• 整个项目一共有多少行代码？</p>
<h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><p>实现思路</p>
<p>• 先统计单个C文件的字数、代码行数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_wc</span> <span class="params">(<span class="keyword">char</span> filename[])</span> </span>&#123;</span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="keyword">char</span> ch;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> lines = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> words = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> word_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    fp = fopen (filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((ch = fgetc(fp)) != EOF) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span>) lines ++;</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span> || ch == <span class="string">&#x27; &#x27;</span> || ch == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">            word_flag = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (word_flag == <span class="number">1</span>)&#123;</span><br><span class="line">                words ++;</span><br><span class="line">                word_flag = <span class="number">0</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lines: %d\n&quot;</span>, lines);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;words: %d\n&quot;</span>, words);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>• 然后遍历一个目录下的所有C文件</p>
<p>• 如果该目录下面还有子目录、递归遍历</p>
<p>• 统计、累加</p>
<p>• 打印输出</p>
<h3 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h3><p>文件遍历</p>
<p>• 各个目录、子目录递归遍历</p>
<p>• 当一个目录下面有文件、子目录时的处理</p>
<p>• 搜索指定格式的文件：C文件、H文件、汇编文件</p>
<p>改进后的完整代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_wc</span> <span class="params">(<span class="keyword">char</span> filename[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foreach_dir</span> <span class="params">(<span class="keyword">char</span> dirname[] )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    foreach_dir (argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foreach_dir</span> <span class="params">(<span class="keyword">char</span> dirname[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">//do_wc (argv[1]);</span></span><br><span class="line">    DIR * dir_ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">entry_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">    dir_ptr = opendir (dirname);</span><br><span class="line">    <span class="keyword">if</span> (dir_ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;opendir&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> full_path_name[<span class="number">128</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">while</span> ((entry_ptr = readdir (dir_ptr)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">strcmp</span> (entry_ptr-&gt;d_name, <span class="string">&quot;.&quot;</span>) &amp;&amp; <span class="built_in">strcmp</span> (entry_ptr-&gt;d_name, <span class="string">&quot;..&quot;</span>)) == <span class="number">0</span>) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">strcpy</span> (full_path_name, dirname);</span><br><span class="line">        <span class="keyword">if</span> (full_path_name[<span class="built_in">strlen</span> (full_path_name) - <span class="number">1</span>] != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">            <span class="built_in">strcat</span> (full_path_name, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span> (full_path_name, entry_ptr-&gt;d_name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (stat (full_path_name, &amp;buf) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;stat&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (S_ISDIR(buf.st_mode)) &#123;</span><br><span class="line">            foreach_dir (full_path_name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span> (entry_ptr-&gt;d_name + <span class="built_in">strlen</span>(entry_ptr-&gt;d_name) - <span class="number">2</span>, <span class="string">&quot;.c&quot;</span>) &amp;&amp; \</span><br><span class="line">                <span class="built_in">strcmp</span> (entry_ptr-&gt;d_name + <span class="built_in">strlen</span>(entry_ptr-&gt;d_name) - <span class="number">2</span>, <span class="string">&quot;.h&quot;</span>) &amp;&amp; \</span><br><span class="line">                <span class="built_in">strcmp</span> (entry_ptr-&gt;d_name + <span class="built_in">strlen</span>(entry_ptr-&gt;d_name) - <span class="number">2</span>, <span class="string">&quot;.S&quot;</span>)) </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                do_wc (full_path_name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    closedir (dir_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_wc</span> <span class="params">(<span class="keyword">char</span> filename[])</span> </span>&#123;</span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="keyword">char</span> ch;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> lines = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> words = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> files = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> word_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    fp = fopen (filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((ch = fgetc(fp)) != EOF) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span>) lines ++;</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span> || ch == <span class="string">&#x27; &#x27;</span> || ch == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">            word_flag = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (word_flag == <span class="number">1</span>)&#123;</span><br><span class="line">                words ++;</span><br><span class="line">                word_flag = <span class="number">0</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s\n&quot;</span>, filename);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;files: %d\n&quot;</span>, ++files);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;lines: %d\n&quot;</span>, lines);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;words: %d\n&quot;</span>, words);</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="文件IO缓存与内存映射"><a href="#文件IO缓存与内存映射" class="headerlink" title="文件IO缓存与内存映射"></a>文件IO缓存与内存映射</h1><h2 id="缓存的基本概念"><a href="#缓存的基本概念" class="headerlink" title="缓存的基本概念"></a>缓存的基本概念</h2><h3 id="计算机中的缓存"><a href="#计算机中的缓存" class="headerlink" title="计算机中的缓存"></a>计算机中的缓存</h3><p>无处不在的缓存</p>
<ul>
<li>CPU级别的缓存：cache、TLB、让 CPU 高效运行</li>
<li>操作系统的缓存：页缓存、slab、让系统更高效运行</li>
<li>应用层的缓存：内存管理、IO应用缓存，让应用更高效运行</li>
</ul>
<h3 id="I-O缓存"><a href="#I-O缓存" class="headerlink" title="I/O缓存"></a>I/O缓存</h3><p>提高文件I/O的性能</p>
<ul>
<li>操作系统级的缓存</li>
<li>应用层的缓存</li>
<li>内存映射</li>
<li>API系统调用、参数</li>
</ul>
<h2 id="页高速缓存-页缓存读写流程"><a href="#页高速缓存-页缓存读写流程" class="headerlink" title="页高速缓存-页缓存读写流程"></a>页高速缓存-页缓存读写流程</h2><h3 id="内核中的缓冲区"><a href="#内核中的缓冲区" class="headerlink" title="内核中的缓冲区"></a>内核中的缓冲区</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418144651.png"></p>
<h3 id="页高速缓存"><a href="#页高速缓存" class="headerlink" title="页高速缓存"></a>页高速缓存</h3><p>页缓存</p>
<p>• 通过Linux内核缓冲区实现了一种磁盘缓存机制</p>
<p>• 基本原理：局部原理、时间局部、空间局部</p>
<p>• 缓存基于页的对象：普通文件、块设备、内存映射</p>
<p>• 优点：一定程度上分离了应用程序空间和物理设备、减少IO读盘次数</p>
<h3 id="页缓存和读写"><a href="#页缓存和读写" class="headerlink" title="页缓存和读写"></a>页缓存和读写</h3><p>读流程</p>
<ul>
<li>先到缓存中看数据是否存在，存在直接读取返回到用户空间</li>
<li>若不存在，将磁盘数据缓存到page cache中</li>
<li>然后从page cache中读取数据到用户空间</li>
</ul>
<p>写流程</p>
<ul>
<li><p>将用户空间数据写到page cache中</p>
</li>
<li><p>当page cache数据达到阈值或时间超时，将数据回写到磁盘</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418145709.png"></p>
<h3 id="同步方式"><a href="#同步方式" class="headerlink" title="同步方式"></a>同步方式</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418150014.png"></p>
<h3 id="实验-页缓存读写实验"><a href="#实验-页缓存读写实验" class="headerlink" title="实验-页缓存读写实验"></a>实验-页缓存读写实验</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418150504.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418151220.png"></p>
<p>将10MB的空数据写到test.dat文件中</p>
<h2 id="页高速缓存-内存管理"><a href="#页高速缓存-内存管理" class="headerlink" title="页高速缓存-内存管理"></a>页高速缓存-内存管理</h2><h3 id="物理内存管理"><a href="#物理内存管理" class="headerlink" title="物理内存管理"></a>物理内存管理</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418190936.png"></p>
<p>ZONE_DMA : 存放连续的物理地址空间，用作设备 DMA</p>
<p>ZONE_NORMAL : Linux内核镜像、应用程序大部分都加载到这里</p>
<p>ZONE_HIGNMEM: 用作设备映射、临时映射等</p>
<h3 id="伙伴算法"><a href="#伙伴算法" class="headerlink" title="伙伴算法"></a>伙伴算法</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418191355.png"></p>
<p>为了防止内存碎片化，采用伙伴系统来申请释放内存</p>
<h3 id="内存申请"><a href="#内存申请" class="headerlink" title="内存申请"></a>内存申请</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418193438.png"></p>
<h3 id="Linux虚拟地址空间"><a href="#Linux虚拟地址空间" class="headerlink" title="Linux虚拟地址空间"></a>Linux虚拟地址空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418202227.png"></p>
<p>内核空间到物理地址的映射</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418202711.png"></p>
<p>用户空间到物理地址的映射</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418202958.png"></p>
<h2 id="页高速缓存-页缓存的实现"><a href="#页高速缓存-页缓存的实现" class="headerlink" title="页高速缓存-页缓存的实现"></a>页高速缓存-页缓存的实现</h2><h3 id="页缓存对象：属性"><a href="#页缓存对象：属性" class="headerlink" title="页缓存对象：属性"></a>页缓存对象：属性</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">host</span>;</span> <span class="comment">/* owner: inode, block_device */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">page_tree</span>;</span> <span class="comment">/* radix tree of all pages */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> tree_lock; <span class="comment">/* and lock protecting it */</span></span><br><span class="line">    <span class="keyword">atomic_t</span> i_mmap_writable;<span class="comment">/* count VM_SHARED mappings */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">i_mmap</span>;</span> <span class="comment">/* tree of private and shared mappings */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">i_mmap_rwsem</span>;</span> <span class="comment">/* protect tree, count, list */</span></span><br><span class="line">    <span class="comment">/* Protected by tree_lock together with the radix tree */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nrpages; <span class="comment">/* number of total pages */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nrshadows; <span class="comment">/* number of shadow entries */</span></span><br><span class="line">    <span class="keyword">pgoff_t</span> writeback_index;<span class="comment">/* writeback starts here */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> *<span class="title">a_ops</span>;</span> <span class="comment">/* methods */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags; <span class="comment">/* error bits/gfp mask */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> private_lock; <span class="comment">/* for use by the address_space */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">private_list</span>;</span> <span class="comment">/* ditto */</span></span><br><span class="line">    <span class="keyword">void</span> *private_data; <span class="comment">/* ditto */</span></span><br><span class="line">&#125; ; <span class="comment">//通过该对象，可以将文件系统、内存管理系统进行关联</span></span><br></pre></td></tr></table></figure>

<p>将文件系统和内存管理系统进行关联</p>
<ul>
<li><p><code>struct inode * host</code> :  指向所属的 <code>inode</code>对象或块设备对象，用于获取文件的元数据信息。</p>
</li>
<li><p><code>struct rb_root i_mmap</code> : 红黑树结构，用于管理私有映射和共享映射，每个映射对应一个vm_area_struct结构。</p>
</li>
<li><p><code>unsigned long nrpages</code> ：记录该address_space对象管理的页框数量。</p>
</li>
<li><p><code>const struct address_space_operations *a_ops;</code>：指向address_space_operations结构体，提供了对文件数据的读写、缓存、回写等操作。</p>
</li>
</ul>
<h3 id="页缓存对象：方法"><a href="#页缓存对象：方法" class="headerlink" title="页缓存对象：方法"></a>页缓存对象：方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> (*writepage)(struct page *page, struct writeback_control *wbc);</span><br><span class="line">    <span class="keyword">int</span> (*readpage)(struct file *, struct page *);</span><br><span class="line">    <span class="keyword">int</span> (*writepages)(struct address_space *, struct writeback_control *);</span><br><span class="line">    <span class="keyword">int</span> (*set_page_dirty)(struct page *page);</span><br><span class="line">    <span class="keyword">int</span> (*readpages)(struct file *filp, struct address_space *mapping,</span><br><span class="line">    struct list_head *pages, <span class="keyword">unsigned</span> nr_pages);</span><br><span class="line">    …</span><br><span class="line">    <span class="keyword">sector_t</span> (*bmap)(struct address_space *, <span class="keyword">sector_t</span>);</span><br><span class="line">    <span class="keyword">void</span> (*invalidatepage) (struct page *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">int</span> (*releasepage) (struct page *, <span class="keyword">gfp_t</span>);</span><br><span class="line">    <span class="keyword">void</span> (*freepage)(struct page *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*direct_IO)(struct kiocb *, struct iov_iter *iter, <span class="keyword">loff_t</span> offset);</span><br><span class="line">&#125;; <span class="comment">// 文件位置偏移 -&gt; 页偏移量 -&gt; 文件系统块号：block -&gt; 磁盘扇区号</span></span><br></pre></td></tr></table></figure>

<p>封装了读页缓存、写页缓存等方法</p>
<blockquote>
<p>来自GPT-4的讲解：</p>
<p><code>struct address_space_operations</code> 是一个结构体，定义了一组用于操作地址空间的函数指针。地址空间（<code>address_space</code>）是 Linux 内核中的一个关键概念，用于表示文件或设备的抽象内存映射。这个结构体在 Linux 的虚拟文件系统（VFS）中扮演着重要角色，它允许文件系统实现自己的操作函数，以便对文件或设备的内存映射进行管理。</p>
<p>下面是 <code>struct address_space_operations</code> 成员的简要说明：</p>
<ol>
<li><code>int (*writepage)(struct page *page, struct writeback_control *wbc);</code><br>写入一个内存中的脏页（包含未写入磁盘的修改数据）到底层存储设备。</li>
<li><code>int (*readpage)(struct file *, struct page *);</code><br>从底层存储设备读取一个页面到内存。</li>
<li><code>int (*writepages)(struct address_space *, struct writeback_control *);</code><br>将一个地址空间中的所有脏页（需要写回磁盘的页面）写入底层存储设备。</li>
<li><code>int (*set_page_dirty)(struct page *page);</code><br>将页面标记为脏（表示已被修改，需要写回磁盘）。</li>
<li><code>int (*readpages)(struct file *filp, struct address_space *mapping,  struct list_head *pages, unsigned nr_pages);</code><br>从底层存储设备读取多个页面到内存。</li>
<li><code>sector_t (*bmap)(struct address_space *, sector_t);</code><br>将文件位置偏移量映射到文件系统块号，再映射到磁盘扇区号。这个过程将逻辑地址转换为物理地址。</li>
<li><code>void (*invalidatepage) (struct page *, unsigned int, unsigned int);</code><br>使包含指定范围的页面无效，以便从缓存中删除它。</li>
<li><code>int (*releasepage) (struct page *, gfp_t);</code><br>释放一个页面，以便将其归还给内存分配器。</li>
<li><code>void (*freepage)(struct page *);</code><br>在页面被释放之前，对其进行清理操作。</li>
<li><code>ssize_t (*direct_IO)(struct kiocb *, struct iov_iter *iter, loff_t offset);</code><br>通过直接 I/O 访问文件，从而绕过页面缓存。</li>
</ol>
<p><code>struct address_space_operations</code> 提供了多种操作地址空间的方法，使得不同的文件系统可以实现自己的操作函数，以满足特定需求。</p>
</blockquote>
<h3 id="页缓存对象：物理页"><a href="#页缓存对象：物理页" class="headerlink" title="页缓存对象：物理页"></a>页缓存对象：物理页</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">        <span class="keyword">void</span> *s_mem; <span class="comment">/* slab first object */</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* slub per cpu partial pages */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span> <span class="comment">/* Next partial slab */</span></span><br><span class="line">        <span class="keyword">short</span> <span class="keyword">int</span> pages;</span><br><span class="line">        <span class="keyword">short</span> <span class="keyword">int</span> pobjects;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">        <span class="keyword">spinlock_t</span> ptl;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="comment">//一个页可以是文件页缓存、可以是交换缓存、也可以是普通内存</span></span><br></pre></td></tr></table></figure>

<p>一个页可以是文件页缓存、可以是交换缓存、也可以是普通内存</p>
<p>如果成员变量 <code>mapping</code> 指向 address_space ，则说明这个物理页是用来缓存文件的</p>
<h3 id="页缓存数据结构图"><a href="#页缓存数据结构图" class="headerlink" title="页缓存数据结构图"></a>页缓存数据结构图</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418210856.png"></p>
<h3 id="读文件-基本流程"><a href="#读文件-基本流程" class="headerlink" title="读文件-基本流程"></a>读文件-基本流程</h3><ul>
<li>数据结构关联：<code>inode-&gt;i_mapping</code> 指向 <code>address_space</code> 对象</li>
<li>数据结构关联：<code>address_space-&gt;host</code> 指向<code>inode</code></li>
<li>数据结构关联：<code>page-&gt;mapping</code>指向页缓存owner的<code>address_space</code></li>
<li>系统调用传参：文件描述符 + 文件位置偏移</li>
<li>系统找到文件的<code>address_space</code>，根据偏移量到页缓存中查找<code>page</code></li>
<li>若查找到，返回数据到用户空间</li>
<li>若没查到，内核新建一个<code>page</code>并加入页缓存，数据从磁盘载入该页</li>
<li>调用<code>readpage</code>方法将数据返回给用户空间</li>
</ul>
<h3 id="读文件实例"><a href="#读文件实例" class="headerlink" title="读文件实例"></a>读文件实例</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230418211750.png"></p>
<h3 id="写文件-基本流程"><a href="#写文件-基本流程" class="headerlink" title="写文件-基本流程"></a>写文件-基本流程</h3><p>• 数据结构关联：inode-&gt;i_mapping指向address_space对象</p>
<p>• 数据结构关联：address_space-&gt;host指向inode</p>
<p>• 数据结构关联：page-&gt;mapping指向页缓存owner的address_space</p>
<p>• 系统调用传参：文件描述符 + 文件位置偏移</p>
<p>• 系统找到文件的address_space，根据偏移量到页缓存中查找page</p>
<p>• 若查找到，将数据写入到该页缓存中，该页成为 <strong>脏页</strong></p>
<p>• 若没查到，从缓存中分配空闲页，数据从用户空间写入该页</p>
<p>• 当数据满足一定空间或时间阈值，将脏页中的数据回写到磁盘</p>
<p>• 守护进程：pdflush</p>
<h2 id="块设备驱动架构"><a href="#块设备驱动架构" class="headerlink" title="块设备驱动架构"></a>块设备驱动架构</h2><h3 id="块缓存"><a href="#块缓存" class="headerlink" title="块缓存"></a>块缓存</h3><p>Linux内核中的缓存</p>
<ul>
<li>早期使用块缓存，新的内核逐渐使用页缓存</li>
<li>块缓存：比页缓存小、长度可变，依赖于设备(或文件系统)</li>
<li>块缓存的实现：基于页缓存<ul>
<li>缓冲头：buffer_head，缓冲区的元数据信息：块号、块长度</li>
<li>每个buffer_head指向一个缓冲区，一个页可以细分为若干个缓冲区</li>
<li>内核物理页与磁盘物理块之间的桥梁</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419090553.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> b_state; <span class="comment">/* buffer state bitmap (see above) */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> *<span class="title">b_this_page</span>;</span> <span class="comment">/* circular list of page&#x27;s buffers */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">b_page</span>;</span> <span class="comment">/* the page this bh is mapped to */</span></span><br><span class="line">    <span class="keyword">sector_t</span> b_blocknr; <span class="comment">/* start block number */</span></span><br><span class="line">    <span class="keyword">size_t</span> b_size; <span class="comment">/* size of mapping */</span></span><br><span class="line">    <span class="keyword">char</span> *b_data; <span class="comment">/* pointer to data within the page */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">b_bdev</span>;</span></span><br><span class="line">    <span class="keyword">bh_end_io_t</span> *b_end_io; <span class="comment">/* I/O completion */</span></span><br><span class="line">    <span class="keyword">void</span> *b_private; <span class="comment">/* reserved for b_end_io */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_assoc_buffers</span>;</span> <span class="comment">/* associated with another mapping */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">b_assoc_map</span>;</span> <span class="comment">/* mapping this buffer is</span></span><br><span class="line"><span class="comment">     associated with */</span></span><br><span class="line">    <span class="keyword">atomic_t</span> b_count; <span class="comment">/* users using this buffer_head */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>b_this_page：由于一个页可能对应多个缓存页，因此这个字段用于将同一个页的所有缓存页串联起来，形成一个循环链表，即指向块缓存的指针</p>
<p>b_blocknr: 表示缓存页对应的磁盘块号</p>
<p>b_data：表示指向缓存页数据的指针</p>
<p>b_bdev：表示缓存页对应的块设备（文件）</p>
<h3 id="bio结构体"><a href="#bio结构体" class="headerlink" title="bio结构体"></a>bio结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bio</span> *<span class="title">bi_next</span>;</span> <span class="comment">/* request queue link */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">bi_bdev</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bi_flags; <span class="comment">/* status, command, etc */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> bi_rw;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bvec_iter</span> <span class="title">bi_iter</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bi_phys_segments;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bi_seg_front_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bi_seg_back_size;</span><br><span class="line">    <span class="keyword">atomic_t</span> __bi_remaining;</span><br><span class="line">    <span class="keyword">bio_end_io_t</span> *bi_end_io;</span><br><span class="line">    <span class="keyword">void</span> *bi_private;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> bi_vcnt; <span class="comment">/* how many bio_vec&#x27;s */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> bi_max_vecs; <span class="comment">/* max bvl_vecs we can hold */</span></span><br><span class="line">    <span class="keyword">atomic_t</span> __bi_cnt; <span class="comment">/* pin count */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> *<span class="title">bi_io_vec</span>;</span> <span class="comment">/* the actual vec list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bio_set</span> *<span class="title">bi_pool</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> <span class="title">bi_inline_vecs</span>[0];</span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>



<p>• main unit of I/O for the block layer and lower layers</p>
<p>• struct gendisk -&gt; block_device -&gt; /dev/sdax -&gt; inode</p>
<p>底层驱动可以接受的类型读写单元是 <code>bio</code>，通常需要将 <code>page cache</code>转化成 <code>bio</code></p>
<p>硬盘中使用 gendisk 表示一个硬盘，每个分区用<code>block_device</code> 来表示，对应在设备结点上，比如有 /dev/sda 表示代表 gendisk，sda1和sda2代表一个分区，只能对安装文件系统进行格式化的分区进行读写；每一个设备节点分区都有自己的 inode , 在 <code>bio</code>中有对应的 bi_bdev ，通过这个结构体将对应的设备进行封装</p>
<p>目前内核中块I/O操作的基本容器由 <code>bio</code> 结构体表示。该结构体代表了正在现场（活动）以片段链表形式组织的块I/O操作。一个片段是一小块连续的内存缓冲区。这样的话，就不需要保证单个缓冲区一定要连续。所以通过片段来描述缓冲区，即使一个缓冲区分散在内存的多个位置上，bio结构体也能对内核保证I/O操作的执行，像这样的向量 I/O 就是所谓的聚散I/O。</p>
<h3 id="块设备驱动架构-1"><a href="#块设备驱动架构-1" class="headerlink" title="块设备驱动架构"></a>块设备驱动架构</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419093403.png"></p>
<h4 id="各种各样的块设备"><a href="#各种各样的块设备" class="headerlink" title="各种各样的块设备"></a>各种各样的块设备</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419103032.png"></p>
<h2 id="用户空间的IO缓存"><a href="#用户空间的IO缓存" class="headerlink" title="用户空间的IO缓存"></a>用户空间的IO缓存</h2><p>系统调用的开销</p>
<ul>
<li>切换CPU到内核模式</li>
<li>数据拷贝</li>
<li>切换CPU到用户模式</li>
</ul>
<p>C标准库IO缓冲区</p>
<ul>
<li><p>在用户空间，为每个打开的文件</p>
<ul>
<li>分配一个I/O缓冲区</li>
<li>分配一个文件描述符</li>
<li>I/O缓冲区信息和文件描述符一起封装在FILE结构体中</li>
</ul>
</li>
<li><p>size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);</p>
</li>
<li><p>size_t fwrite(const void *ptr, size_t size, size_t nmemb,FILE *stream);</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">     <span class="keyword">int</span> _flags;</span><br><span class="line">     <span class="keyword">char</span>* _IO_read_ptr; <span class="comment">/* Current read pointer */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_read_end; <span class="comment">/* End of get area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_read_base; <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_write_ptr; <span class="comment">/* Current put pointer. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_write_end; <span class="comment">/* End of put area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_buf_base; <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">     <span class="keyword">char</span>* _IO_buf_end; <span class="comment">/* End of reserve area. */</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">     <span class="keyword">int</span> _fileno;</span><br><span class="line">     _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small. */</span></span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">     <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">     <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">     _IO_lock_t *_lock;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> <span class="title">FILE</span>;</span></span><br></pre></td></tr></table></figure>

<p>_fileno ： 文件描述符</p>
<h3 id="文件读写流程"><a href="#文件读写流程" class="headerlink" title="文件读写流程"></a>文件读写流程</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419110902.png"></p>
<h3 id="三种模式"><a href="#三种模式" class="headerlink" title="三种模式"></a>三种模式</h3><p>块缓冲(block_buffered)：</p>
<ul>
<li><p>固定字节的缓冲区大小，比如跟文件相关的流都是块缓冲</p>
</li>
<li><p>标准IO称块缓冲为完全缓冲(full buffering)</p>
</li>
</ul>
<p>行缓冲(line_buffered)：</p>
<ul>
<li>遇到换行符，缓冲区的数据会拷贝到内核缓冲区</li>
</ul>
<p>无缓冲(unbuffered)：</p>
<ul>
<li><p>数据直接拷贝到内核缓冲区</p>
</li>
<li><p>如：标准错误stderr采用无缓冲模式</p>
</li>
</ul>
<h3 id="自定义缓冲区"><a href="#自定义缓冲区" class="headerlink" title="自定义缓冲区"></a>自定义缓冲区</h3><p>C标准库函数</p>
<ul>
<li><p>int setvbuf (FILE *stream, char *buf, int mode, size_t size);</p>
</li>
<li><p>stream：指向流的指针</p>
</li>
<li><p>buf：缓冲区地址</p>
</li>
<li><p>mode：缓冲区类型</p>
<ul>
<li>__IOFBF：当缓冲区为空，从流中读入数据；缓冲区满时向流写入数据</li>
<li>__IOLBF：每次从流中读入一行数据或向流中写入一行数据</li>
<li>__IONBF：直接从流中读入数据或直接向流中写入数据，无缓冲区</li>
</ul>
</li>
<li><p>size：缓冲区内字节的数量</p>
</li>
</ul>
<h2 id="Scatter-gather-I-O"><a href="#Scatter-gather-I-O" class="headerlink" title="Scatter-gather I/O"></a>Scatter-gather I/O</h2><h3 id="分散-聚集IO"><a href="#分散-聚集IO" class="headerlink" title="分散/聚集IO"></a>分散/聚集IO</h3><ul>
<li><p>优点：更进一步减少了系统调用的次数</p>
</li>
<li><p>单个向量I/O操作取代多个线性I/O操作，效率更高</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419153233.png"></p>
<h3 id="系统调用函数原型"><a href="#系统调用函数原型" class="headerlink" title="系统调用函数原型"></a>系统调用函数原型</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readv</span> <span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writev</span> <span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *iov_base; <span class="comment">/* Pointer to data. */</span></span><br><span class="line">    <span class="keyword">size_t</span> iov_len; <span class="comment">/* Length of data. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="writev"><a href="#writev" class="headerlink" title="writev()"></a>writev()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line">    <span class="keyword">ssize_t</span> count;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf[] = &#123;</span><br><span class="line">        <span class="string">&quot;hello world!\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hello Ubuntu\n&quot;</span>, </span><br><span class="line">        <span class="string">&quot;hello Linux\n&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    fd = open (argv[<span class="number">1</span>], O_WRONLY | O_CREAT | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i ++) &#123;</span><br><span class="line">        iov[i].iov_base = buf[i];</span><br><span class="line">        iov[i].iov_len = <span class="built_in">strlen</span> (buf[i]) + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;iov[%d] size: %d\n&quot;</span>, i, iov[i].iov_len);</span><br><span class="line">    &#125;</span><br><span class="line">    count = writev (fd, iov, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;writev&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close (fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="readv"><a href="#readv" class="headerlink" title="readv()"></a>readv()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">14</span>], buf2[<span class="number">14</span>], buf3[<span class="number">14</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line">    <span class="keyword">ssize_t</span> count;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    fd = open (argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = buf1;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span> (buf1);</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = buf2;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span> (buf2);</span><br><span class="line">    iov[<span class="number">2</span>].iov_base = buf3;</span><br><span class="line">    iov[<span class="number">2</span>].iov_len = <span class="keyword">sizeof</span> (buf3);</span><br><span class="line"></span><br><span class="line">    count = readv (fd, iov, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;readv&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    for (int i = 0; i &lt; 3; i ++) &#123;</span></span><br><span class="line"><span class="comment">        printf (&quot;%s&quot;, (char *) iov[i].iov_base);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s&quot;</span>, (<span class="keyword">char</span>*) &amp;buf1);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s&quot;</span>, (<span class="keyword">char</span>*) &amp;buf2);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s&quot;</span>, (<span class="keyword">char</span>*) &amp;buf3);</span><br><span class="line">    close (fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="直接I-O"><a href="#直接I-O" class="headerlink" title="直接I/O"></a>直接I/O</h2><h3 id="用户空间的IO缓存-1"><a href="#用户空间的IO缓存-1" class="headerlink" title="用户空间的IO缓存"></a>用户空间的IO缓存</h3><p>优缺点：</p>
<p>• 优点：减少了系统调用的次数，减少了系统开销</p>
<p>• 缺点：增加了数据拷贝次数，增大了CPU和内存开销</p>
<p>读：数据从内核页缓存拷贝到标准IO缓存，再拷贝到用户的buffer</p>
<p>写：数据从用户的buffer拷贝到标准IO缓存，再拷贝到内核缓冲区</p>
<h3 id="飞跃缓冲区"><a href="#飞跃缓冲区" class="headerlink" title="飞跃缓冲区"></a>飞跃缓冲区</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419193408.png"></p>
<p>可以使用 setbuf(fp, NULL) 直接将数据拷贝到页缓存不经过IO缓冲区</p>
<p>使用 open (file, flags, O_DIRECT) 可以直接写入磁盘、</p>
<h3 id="自缓存应用程序"><a href="#自缓存应用程序" class="headerlink" title="自缓存应用程序"></a>自缓存应用程序</h3><p>数据库</p>
<ul>
<li>采用直接IO，绕过缓冲区，直接读写磁盘</li>
<li>对用户空间对IO进行缓存和读写优化</li>
<li>频繁读写、小批量处理</li>
</ul>
<h3 id="直接IO"><a href="#直接IO" class="headerlink" title="直接IO"></a>直接IO</h3><p>遵守的原则</p>
<ul>
<li>用于传递数据的缓冲区，其内存边界必须对齐：块的整数倍</li>
<li>数据传递的开始点，即文件和设备的偏移量，必须是块大小的整数倍</li>
<li>待传递数据的长度必须是块大小的整数倍</li>
<li>如果用户空间不优化的话，可能会降低系统性能</li>
</ul>
<h2 id="将文件映射到内存"><a href="#将文件映射到内存" class="headerlink" title="将文件映射到内存"></a>将文件映射到内存</h2><h3 id="用户的IO缓存"><a href="#用户的IO缓存" class="headerlink" title="用户的IO缓存"></a>用户的IO缓存</h3><p>优缺点：</p>
<p>优点：减少了系统调用的次数，减少了系统开销</p>
<p>缺点：增加了数据拷贝次数，增大了CPU和内存开销</p>
<ul>
<li><p>读：数据从内核页缓存拷贝到标准IO缓存，再拷贝到用户的buffer</p>
</li>
<li><p>写：数据从用户的buffer拷贝到标准IO缓存，再拷贝到内核缓冲区</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419200106.png"></p>
<h3 id="将文件映射到内存-1"><a href="#将文件映射到内存-1" class="headerlink" title="将文件映射到内存"></a>将文件映射到内存</h3><ul>
<li>内存地址与文件数据一一对应</li>
<li>通过内存代替 read/write 等I/O系统调用接口来访问文件</li>
<li>减少内存拷贝、减少系统调用次数，提高系统性能</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419200138.png"></p>
<h3 id="系统调用接口"><a href="#系统调用接口" class="headerlink" title="系统调用接口"></a>系统调用接口</h3><p>void *mmap(void *addr, size_t length, int prot, int flags,int fd, off_t offset);</p>
<ul>
<li><p>addr：进程中要映射的虚拟内存起始地址，一般为NULL</p>
</li>
<li><p>length：要映射的内存区域大小</p>
</li>
<li><p>prot：内存保护标志： PROT_EXEC、 PROT_READ、 PROT_WRITE</p>
</li>
<li><p>flags：映射对象类型： MAP_FIXED、 MAP_SHARED、MAP_PRIVATE</p>
</li>
<li><p>fd：要映射文件的文件描述符</p>
</li>
<li><p>offset：文件位置偏移</p>
</li>
<li><p>mmap以页为单位操作：参数addr和offset必须按页对齐</p>
</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>mmap_write.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span>* p_map;</span><br><span class="line">    fd = open (argv[<span class="number">1</span>], O_CREAT | O_RDWR | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">    write (fd, <span class="string">&quot;&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    p_map = (<span class="keyword">char</span> *) mmap (<span class="literal">NULL</span>, <span class="number">20</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p_map == MAP_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close (fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span> (p_map, <span class="string">&quot;hello world!\n&quot;</span>, <span class="number">14</span>);</span><br><span class="line">    sleep (<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> (munmap (p_map, <span class="number">20</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;munmap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mmap_read.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span>* p_map;</span><br><span class="line">    fd = open (argv[<span class="number">1</span>], O_CREAT | O_RDWR, <span class="number">0666</span>);</span><br><span class="line">    p_map = (<span class="keyword">char</span> *) mmap (<span class="literal">NULL</span>, <span class="number">20</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p_map == MAP_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close (fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s&quot;</span>, p_map);</span><br><span class="line">    <span class="keyword">if</span> (munmap (p_map, <span class="number">20</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;munmap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="文件映射的内存实现"><a href="#文件映射的内存实现" class="headerlink" title="文件映射的内存实现"></a>文件映射的内存实现</h2><h3 id="Linux进程虚拟地址空间"><a href="#Linux进程虚拟地址空间" class="headerlink" title="Linux进程虚拟地址空间"></a>Linux进程虚拟地址空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419205055.png"></p>
<h3 id="Linux进程虚拟地址描述"><a href="#Linux进程虚拟地址描述" class="headerlink" title="Linux进程虚拟地址描述"></a>Linux进程虚拟地址描述</h3><p>结构体：task_struct</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> state;</span><br><span class="line">    <span class="keyword">void</span> *<span class="built_in">stack</span>;</span><br><span class="line">    <span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> <span class="title">se</span>;</span></span><br><span class="line">    <span class="keyword">cpumask_t</span> cpus_allowed;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tasks</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>, *<span class="title">active_mm</span>;</span></span><br><span class="line">    u32 vmacache_seqnum;</span><br><span class="line">    <span class="keyword">int</span> exit_state;</span><br><span class="line">    <span class="keyword">int</span> exit_code, exit_signal;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">mmap</span>;</span> <span class="comment">/* list of VMAs */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">mm_rb</span>;</span></span><br><span class="line">    u32 vmacache_seqnum; <span class="comment">/* per-thread vmacache */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> mmap_base; <span class="comment">/* base of mmap area */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> mmap_legacy_base; <span class="comment">/* base of mmap area in bottom-up allocations */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> task_size; <span class="comment">/* size of task vm space */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> highest_vm_end; <span class="comment">/* highest vma end address */</span></span><br><span class="line">    <span class="keyword">pgd_t</span> * pgd;</span><br><span class="line">    <span class="keyword">atomic_t</span> mm_users; <span class="comment">/* How many users with user space? */</span></span><br><span class="line">    <span class="keyword">atomic_t</span> mm_count; <span class="comment">/* How many references to &quot;struct mm_struct&quot; (users count as 1) */</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span> nr_ptes; <span class="comment">/* PTE page table pages */</span></span><br><span class="line">    <span class="keyword">int</span> map_count; <span class="comment">/* number of VMAs */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> page_table_lock; <span class="comment">/* Protects page tables and some counters */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">mmap_sem</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* The first cache line has the info for VMA tree walking. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_start; <span class="comment">/* Our start address within vm_mm. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_end; <span class="comment">/* The first byte after our end address</span></span><br><span class="line"><span class="comment">     within vm_mm. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vm_next</span>, *<span class="title">vm_prev</span>;</span> <span class="comment">/* linked list of VM areas per task*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">vm_rb</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rb_subtree_gap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span> <span class="comment">/* The address space we belong to. */</span></span><br><span class="line">    <span class="keyword">pgprot_t</span> vm_page_prot; <span class="comment">/* Access permissions of this VMA. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_flags; <span class="comment">/* Flags, see mm.h. */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_pgoff; <span class="comment">/* Offset (within vm_file) in PAGE_SIZE</span></span><br><span class="line"><span class="comment">     units, *not* PAGE_CACHE_SIZE */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span> <span class="comment">/* File we map to (can be NULL). */</span></span><br><span class="line">    <span class="keyword">void</span> * vm_private_data; <span class="comment">/* was vm_pte (shared mem) */</span></span><br><span class="line">    …</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果内存区域用来映射文件，则vm_file 指向打开的文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419205233.png"></p>
<h3 id="Linux虚拟地址到文件的映射"><a href="#Linux虚拟地址到文件的映射" class="headerlink" title="Linux虚拟地址到文件的映射"></a>Linux虚拟地址到文件的映射</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419205840.png"></p>
<h3 id="内存物理地址与Linux进程虚拟地址建立关联"><a href="#内存物理地址与Linux进程虚拟地址建立关联" class="headerlink" title="内存物理地址与Linux进程虚拟地址建立关联"></a>内存物理地址与Linux进程虚拟地址建立关联</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419210013.png"></p>
<p>并不是直接对磁盘进行读写，还是要缓存到页缓存中，用户是直接对页缓存进行读写，通过内存映射，减少了页缓存往用户空间拷贝，但是从磁盘空间到页缓存这个过程还是有的。</p>
<p><font color='9900CC'>mmap 即减少了系统调用的次数也减少了数据拷贝的次数</font></p>
<h2 id="将设备映射到内存"><a href="#将设备映射到内存" class="headerlink" title="将设备映射到内存"></a>将设备映射到内存</h2><h3 id="LCD显示原理"><a href="#LCD显示原理" class="headerlink" title="LCD显示原理"></a>LCD显示原理</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419211128.png"></p>
<h3 id="Frambuffer设备"><a href="#Frambuffer设备" class="headerlink" title="Frambuffer设备"></a>Frambuffer设备</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419211614.png"></p>
<h3 id="将设备映射到内存-1"><a href="#将设备映射到内存-1" class="headerlink" title="将设备映射到内存"></a>将设备映射到内存</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419211627.png"></p>
<h3 id="共享文件映射"><a href="#共享文件映射" class="headerlink" title="共享文件映射"></a>共享文件映射</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230419212231.png"></p>
<h1 id="进程与终端"><a href="#进程与终端" class="headerlink" title="进程与终端"></a>进程与终端</h1><h2 id="进程：程序运行的“牌照”"><a href="#进程：程序运行的“牌照”" class="headerlink" title="进程：程序运行的“牌照”"></a>进程：程序运行的“牌照”</h2><h3 id="进程与程序的区别"><a href="#进程与程序的区别" class="headerlink" title="进程与程序的区别"></a>进程与程序的区别</h3><ul>
<li><p>程序：二进制文件，存储在磁盘上</p>
</li>
<li><p>进程：process，一个程序运行实例</p>
<ul>
<li>将程序从磁盘加载到内存并分配对应的资源、调度运行</li>
</ul>
</li>
<li><p>进程实例</p>
<ul>
<li><p>汇编指令代码、数据、资源、状态</p>
</li>
<li><p>一个虚拟计算机(进程上下文环境、CPU状态寄存器)</p>
</li>
<li><p>进程资源：虚拟内存、打开的文件描述符表、信号、工作目录…</p>
</li>
</ul>
</li>
</ul>
<h2 id="创建一个进程-fork"><a href="#创建一个进程-fork" class="headerlink" title="创建一个进程:fork"></a>创建一个进程:fork</h2><h3 id="创建一个子进程"><a href="#创建一个子进程" class="headerlink" title="创建一个子进程"></a>创建一个子进程</h3><p>系统调用：fork()</p>
<ul>
<li><p>函数原型：pid_t fork(void);</p>
</li>
<li><p>函数作用：创建一个新进程</p>
</li>
<li><p>返回值：</p>
<ul>
<li><p>-1 ：创建子进程失败</p>
</li>
<li><p>0 ：在子进程中返回0</p>
</li>
<li><p>&gt; 0 ：在父进程中返回的是子进程的PID</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420091125.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line"></span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;ret_from_fork = %d\n&quot;</span>, ret_from_fork);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;ret_from_fork = %d\n&quot;</span>, ret_from_fork);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="子进程的运行：“借壳上市”"><a href="#子进程的运行：“借壳上市”" class="headerlink" title="子进程的运行：“借壳上市”"></a>子进程的运行：“借壳上市”</h2><h3 id="执行一个二进制程序文件"><a href="#执行一个二进制程序文件" class="headerlink" title="执行一个二进制程序文件"></a>执行一个二进制程序文件</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420183955.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420184858.png"> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* arglist[argc];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc - <span class="number">1</span>; i ++) &#123;</span><br><span class="line">        arglist[i] = argv[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    arglist[i] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;Hello!\n&quot;</span>);</span><br><span class="line">    execvp (arglist[<span class="number">0</span>], arglist);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;World!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420211427.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230420211440.png"></p>
<h2 id="写时复制（COW）与vfork"><a href="#写时复制（COW）与vfork" class="headerlink" title="写时复制（COW）与vfork"></a>写时复制（COW）与vfork</h2><h3 id="一个新进程的诞生：虚拟空间"><a href="#一个新进程的诞生：虚拟空间" class="headerlink" title="一个新进程的诞生：虚拟空间"></a>一个新进程的诞生：虚拟空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421083247.png"></p>
<h3 id="一个新进程的诞生：物理空间"><a href="#一个新进程的诞生：物理空间" class="headerlink" title="一个新进程的诞生：物理空间"></a>一个新进程的诞生：物理空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421083611.png"></p>
<p>如果这样的话，多了一次复制，因此不可取</p>
<h3 id="写时复制-copy-on-write"><a href="#写时复制-copy-on-write" class="headerlink" title="写时复制(copy-on-write)"></a>写时复制(copy-on-write)</h3><p>对fork-exec流程的改进</p>
<ul>
<li><p>对于代码段、数据段等，父子进程可以共享，节省拷贝开销</p>
</li>
<li><p>父子进程的页表项均指向同一块物理内存页帧</p>
</li>
<li><p>当子进程进程空间的内容要修改时，才会真正将段复制到子进程</p>
</li>
<li><p>写时复制：</p>
<ul>
<li>仅仅为子进程复制父进程的虚拟页表项</li>
<li>对将要修改的页面修改页表项</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421084728.png"></p>
<h3 id="系统调用：vfork"><a href="#系统调用：vfork" class="headerlink" title="系统调用：vfork"></a>系统调用：vfork</h3><p>对fork的改进</p>
<ul>
<li><p>对fork的改进更为彻底、简单粗暴</p>
</li>
<li><p>vfork是为子进程立即执行exec的程序而专门设计的</p>
<ul>
<li>无需为子进程复制虚拟内存页或页表，子进程直接共享父进程的资源，直到其成功执行exec或是调用exit退出</li>
<li><font color='9900CC'>在子进程调用exec之前，将暂停执行父进程</font></li>
</ul>
</li>
</ul>
<h2 id="进程的退出：exit"><a href="#进程的退出：exit" class="headerlink" title="进程的退出：exit"></a>进程的退出：exit</h2><h3 id="终止当前进程"><a href="#终止当前进程" class="headerlink" title="终止当前进程"></a>终止当前进程</h3><p>exit函数</p>
<ul>
<li><p>POSIX标准和ANSI C定义的标准函数</p>
<ul>
<li>#include &lt;stdlib.h&gt;</li>
<li>其实是对系统调用<font color='red'>_exit</font>的封装</li>
</ul>
</li>
<li><p>函数原型：void exit (int status);</p>
</li>
<li><p>函数功能：终止当前进程</p>
</li>
<li><p>参数说明：用于标识进程的退出状态，shell或父进程可以获取该值</p>
<ul>
<li>0：表示进程正常退出</li>
<li>-1/1：表示进程退出异常</li>
<li>2~n：用户可自定义</li>
</ul>
</li>
</ul>
<h3 id="exit函数的背后"><a href="#exit函数的背后" class="headerlink" title="exit函数的背后"></a>exit函数的背后</h3><p>执行流程</p>
<ul>
<li>调用退出处理程序（通过atexit、on_exit注册的程序）</li>
<li>刷新 stdio 流缓冲区</li>
<li>使用由status提供的值执行 <code>_exit</code>系统调用函数<ul>
<li>关闭进程打开的文件描述符、释放进程持有的文件锁</li>
<li>关闭进程打开的信号量、消息队列</li>
<li>取消该进程通过 mmap 创建的内存映射</li>
</ul>
</li>
</ul>
<h3 id="atexit-on-exit"><a href="#atexit-on-exit" class="headerlink" title="atexit/on_exit"></a>atexit/on_exit</h3><p>退出处理程序</p>
<p>• 在exit退出后可以自动执行<font color='red'>用户注册的退出处理程序</font></p>
<p>• 执行顺序与注册顺序相反</p>
<p>• 函数原型：int atexit (void (*function)(void));</p>
<p>• 函数原型：int on_exit (void (*function)(int , void *), void *arg);</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exit_process1</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;exit process func1\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exit_process2</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;exit process func2\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">on_exit_process</span> <span class="params">(<span class="keyword">int</span> exit_status, <span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;on_exit_process called: status = %d, args=%d\n&quot;</span>, exit_status, (<span class="keyword">int</span>) arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (atexit (exit_process1) != <span class="number">0</span>) </span><br><span class="line">        perror (<span class="string">&quot;atexit 1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (atexit (exit_process2) != <span class="number">0</span>)</span><br><span class="line">        perror (<span class="string">&quot;atexit 2&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (on_exit (on_exit_process, (<span class="keyword">void</span> *) <span class="number">20</span>) != <span class="number">0</span>) </span><br><span class="line">        perror (<span class="string">&quot;on_exit&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span> (<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="return与exit的区别"><a href="#return与exit的区别" class="headerlink" title="return与exit的区别"></a>return与exit的区别</h3><ul>
<li><p>exit用来终止当前进程，将控制权交给操作系统</p>
</li>
<li><p>return用来退出当前函数，销毁栈帧，返回到上级函数执行</p>
</li>
<li><p>终止进程：</p>
<ul>
<li>正常退出：exit、_exit、从main函数return</li>
<li>异常退出：调用abort、信号ctrl + C</li>
</ul>
</li>
</ul>
<h3 id="exit-group函数"><a href="#exit-group函数" class="headerlink" title="exit_group函数"></a>exit_group函数</h3><p>• 函数原型：void exit_group (int status);</p>
<p>• exit：退出当前进程process</p>
<p>• exit_group：退出一个进程中所有threads</p>
<p>• Linux系统特有的系统调用，不属于POSIX标准</p>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><p>fork之后、exec之前，使用exit是不安全的，因为很多资源还是共享的(如文件描述符、缓冲区)</p>
<h2 id="进程的退出：exit与-exit"><a href="#进程的退出：exit与-exit" class="headerlink" title="进程的退出：exit与_exit"></a>进程的退出：exit与_exit</h2><h3 id="两者的区别"><a href="#两者的区别" class="headerlink" title="两者的区别"></a>两者的区别</h3><ul>
<li><p>exit是库函数是对_exit系统调用的封装</p>
</li>
<li><p>在调用_exit <strong>之前</strong>，它会执行各种动作</p>
<ul>
<li><p>调用退出处理程序(通过atexit和on_exit注册的回调函数)</p>
</li>
<li><p>刷新stdio流缓冲区</p>
</li>
<li><p>使用由status提供的值执行_exit系统调用</p>
</li>
</ul>
</li>
</ul>
<h3 id="exit的执行流程"><a href="#exit的执行流程" class="headerlink" title="_exit的执行流程"></a>_exit的执行流程</h3><p>• 关闭进程打开的文件描述符、释放该进程持有的文件锁</p>
<p>• 关闭该进程打开的信号量、消息队列</p>
<p>• 取消该进程通过mmap()创建的内存映射</p>
<p>• 将该进程的所有子进程交给init托管</p>
<p>• 给父进程发送一个SIGCHLD信号</p>
<p>• ……</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    write (<span class="number">1</span>, <span class="string">&quot;hahaha\n&quot;</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork () == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421104914.png"></p>
<p>观察这样一段程序，打印到终端和log文件打印顺序相反而且多了一行</p>
<p><code>printf</code> 在终端为行缓存，遇到换行符就将数据拷贝到内核缓冲区，而 write 系统调用没有采用用户IO缓存，直接写到内核缓冲区，因此在终端打印正常。</p>
<p>当重定向到文件时，文件采用完全缓存，即块缓存（和文件相关的都是块缓存），此时 printf 输出到用户块缓存，还没有满，没有写到内核页缓冲区，而<code>write</code>是直接写到内核页缓存，所以文件里先打印hahaha</p>
<p>当运行到 fork 时，子进程完全复制父进程的数据代码、各种状态、父进程的用户IO缓存也会保存，接下来退出的时候，调用 exit 都会刷新 stdout 流缓冲区，因此在 log 文件有两个 Hello World!</p>
<p>如果我们不想将用户IO缓存数据复制给子进程，可以提前进行 fflush() 刷新到文件里面 ，也可以在子进程使用_exit()，即 退出时不刷新 stdout</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">   <span class="comment">// fflush(stdout);</span></span><br><span class="line">    write (<span class="number">1</span>, <span class="string">&quot;hahaha\n&quot;</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        _exit (<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="关于-exit和exit总结"><a href="#关于-exit和exit总结" class="headerlink" title="关于_exit和exit总结"></a>关于_exit和exit总结</h3><ul>
<li><p>在一个进程中，直接调用_exit终止进程，缓冲区的数据可能会丢失</p>
</li>
<li><p>在创建子进程的应用中，只应有一个进程(一般为父进程)调用exit终止，而其他进程应调用_exit()终止。从而确保只有一个进程调用退出处理程序并刷新stdio缓冲区</p>
</li>
<li><p>如果一个进程使用atexit/on_exit注册了退出管理程序，则应使用exit终止程序的运行，否则注册的回调函数无法执行</p>
</li>
</ul>
<p> 终止进程的各种方法</p>
<p>• 从main函数return</p>
<p>• 调用库函数：exit</p>
<p>• 调用系统调用：_exit/_Exit</p>
<p>• 调用abort：_exit的内部实现(POSIX)</p>
<p>• 信号：Ctrl+C</p>
<p>• …</p>
<h2 id="进程的退出：vfork与exit"><a href="#进程的退出：vfork与exit" class="headerlink" title="进程的退出：vfork与exit"></a>进程的退出：vfork与exit</h2><h3 id="vfork函数"><a href="#vfork函数" class="headerlink" title="vfork函数"></a>vfork函数</h3><p>系统调用vfork</p>
<ul>
<li><font color='9900CC'>子进程共享父进程的代码、数据、堆栈资源</font></li>
<li>使用 vfork 后，<font color='9900CC'>直接运行 exec</font>，节省了资源拷贝的时间</li>
<li>使用 vfork ，创建子进程后直接运行子进程、<font color='9900CC'>父进程被阻塞</font></li>
</ul>
<h3 id="使用vfork创建子进程的退出"><a href="#使用vfork创建子进程的退出" class="headerlink" title="使用vfork创建子进程的退出"></a>使用vfork创建子进程的退出</h3><ul>
<li><p>vfork创建的子进程共享父进程的代码段、数据段、堆栈，子进程退出时使用 _exit/exit，使用 return 会破坏<font color='9900CC'>父进程的堆栈环境</font>、产生段错误</p>
</li>
<li><p>父进程退出一般使用 exit ，而子进程退出使用 _exit</p>
<ul>
<li>子进程 exit  ，输出不确定，依赖于IO库的实现</li>
<li>子进程： __exit + fflush = exit ? </li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = vfork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;vfork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Segmentation fault (core dumped)</span></span><br><span class="line">        <span class="comment">// exit (0); // ok</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;father process\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="等待子进程终止：wait"><a href="#等待子进程终止：wait" class="headerlink" title="等待子进程终止：wait"></a>等待子进程终止：wait</h2><p>wait()函数</p>
<ul>
<li><p>函数原型：pid_t wait(int *status);</p>
</li>
<li><p>函数功能：等待子进程的终止及信息</p>
</li>
<li><p>参数说明：子进程调用exit/_exit时的status</p>
</li>
<li><p>返回值</p>
<ul>
<li>wait调用成功，会返回已终止子进程的pid</li>
<li>wait调用失败，返回-1，设置errno值</li>
<li>若子进程没有终止，<font color='9900CC'>wait调用会阻塞父进程</font>，直到子进程终止，子进程终止后，该调用立即返回</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">child_process</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;child process (pid %d) start\n&quot;</span>, getpid());</span><br><span class="line">    ;</span><br><span class="line">    ;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;child process exit&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span> (<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> wait_return_pid;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process(pid:%d) start\n&quot;</span>, getpid());</span><br><span class="line">        wait_return_pid = wait (<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (wait_return_pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;wait&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;wait child process(pid:%d) exit success!\n&quot;</span>, \</span><br><span class="line">                wait_return_pid);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        child_process ();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="子进程的返回状态"><a href="#子进程的返回状态" class="headerlink" title="子进程的返回状态"></a>子进程的返回状态</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421204440.png"></p>
<h3 id="通过宏来解析返回状态"><a href="#通过宏来解析返回状态" class="headerlink" title="通过宏来解析返回状态"></a>通过宏来解析返回状态</h3><p>• WEXITSTATUS(status)：返回子进程的退出状态</p>
<p>• WTERMSIG(status)：子进程因未捕捉的信号而终止，此宏返回true</p>
<p>• WSTOPSIG(status)：子进程因信号暂停，此宏返回true</p>
<p>• WIFEXITED(status)：若子进程正常结束，返回true</p>
<p>• WIFSIGNALED(status)：若通过信号杀掉子进程，此宏返回true</p>
<p>• WIFSTOPPED(status)：若子进程因信号而停止，此宏返回true</p>
<p>• WIFCONTINUED(status)：若子进程收到SIGCONT恢复运行，返回true</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">child_process</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;child process (pid: %d) start\n&quot;</span>, getpid());</span><br><span class="line">    ;</span><br><span class="line">    ;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;child process exit\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span> (<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> wait_return_pid;</span><br><span class="line">        <span class="keyword">int</span> status = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process(pid: %d) start\n&quot;</span>, getpid() );</span><br><span class="line">        wait_return_pid = wait (&amp;status);</span><br><span class="line">        <span class="keyword">if</span> (wait_return_pid == <span class="number">-1</span>) </span><br><span class="line">            perror (<span class="string">&quot;wait&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED (status) ) &#123;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;wait child process(pid: %d) return sucess, exit value: %d\n&quot;</span>, \</span><br><span class="line">                wait_return_pid, WEXITSTATUS (status));</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process (pid: %d) exit\n&quot;</span>, getpid ());</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        child_process ();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421210752.png"></p>
<h3 id="等待特定子进程运行终止"><a href="#等待特定子进程运行终止" class="headerlink" title="等待特定子进程运行终止"></a>等待特定子进程运行终止</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230421210931.png"></p>
<h2 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h2><h3 id="操作系统的核心：任务管理"><a href="#操作系统的核心：任务管理" class="headerlink" title="操作系统的核心：任务管理"></a>操作系统的核心：任务管理</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422083730.png"></p>
<h3 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h3><p>任务调度</p>
<ul>
<li><p>将有限的CPU资源分配给多个进程</p>
</li>
<li><p>目的：最大化处理器效率，让多个进程同时运行、互不影响</p>
</li>
<li><p>实现：</p>
<ul>
<li>协同式：一个进程运行完自己的时间片，主动退出，CPU无权过问</li>
<li>抢占式：时间片到了或有更高优先级、调度器抢占CPU进行任务切换</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422084438.png"></p>
<h3 id="Linux进程管理"><a href="#Linux进程管理" class="headerlink" title="Linux进程管理"></a>Linux进程管理</h3><h4 id="进程分类"><a href="#进程分类" class="headerlink" title="进程分类"></a>进程分类</h4><p>处理器消耗型</p>
<ul>
<li><p>渴望获取更多的CPU时间，并消耗掉调度器分配的全部时间片</p>
</li>
<li><p>常见例子：无限死循环、科学计算、影视特效渲染</p>
</li>
</ul>
<p>I/O消耗型</p>
<ul>
<li><p>由于等待某种资源通常处于阻塞状态，不需要较长的时间片</p>
</li>
<li><p>常见例子：等待用户输入、GUI程序、文件读写I/O程序</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422085001.png"></p>
<h4 id="Linux调度策略"><a href="#Linux调度策略" class="headerlink" title="Linux调度策略"></a>Linux调度策略</h4><p>对不同进程采取不同调度策略、实现多个调度器</p>
<ul>
<li><p>完全公平调度CFS</p>
</li>
<li><p>实时进程调度RT</p>
</li>
<li><p>最终期限调度DL</p>
</li>
<li><p>IDLE类调度器、STOP类调度器</p>
</li>
</ul>
<p>不同进程由不同的调度器管理，彼此之间互不干扰</p>
<ul>
<li><p>处理器消耗型进程：减少优先级、分配尽可能长的时间片</p>
</li>
<li><p>I/O消耗进程：增加优先级、增加实时性、增强用户体验</p>
</li>
<li><p>两者混合型</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    <span class="keyword">int</span> child_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> father_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">200000000</span>; i ++) ;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;father process! %d\n&quot;</span>, father_count ++);</span><br><span class="line">            <span class="comment">// sleep (1);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000</span>; i ++) ;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;child process! %d\n&quot;</span>, child_count++);</span><br><span class="line">            <span class="comment">// sleep (1);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="进程的优先级"><a href="#进程的优先级" class="headerlink" title="进程的优先级"></a>进程的优先级</h3><p>进程的nice值和优先级</p>
<ul>
<li><p>$ nice -n 5 top </p>
</li>
<li><p>NI [-20,19] ：进程的NICE值，也叫静态优先级，nice值越小，抢占CPU能力越强，nice会影响进程的优先级</p>
</li>
<li><p>PRI[0,139]：进程的优先级，也叫动态优先级，值越小，优先级越高</p>
</li>
<li><p>进程默认优先级：#defineDEFAULT_PRIO (MAX_RT_PRIO + NICE_WIDTH / 2)</p>
</li>
<li><p>实时进程与非实时进程</p>
<ul>
<li>实时进程：优先级[0,99]，采用实时进程的调度算法</li>
<li>非实时进程：优先级[100,139]，采用O1/CFS等调度算法</li>
</ul>
</li>
</ul>
<h3 id="并发与并行区别"><a href="#并发与并行区别" class="headerlink" title="并发与并行区别"></a>并发与并行区别</h3><ul>
<li><p>并发：concurrency，CPU通过时间片轮转同时做多件事情</p>
</li>
<li><p>并行：parallellism，很多事情在多个CPU上同时进行</p>
</li>
<li><p>并发可以看做并行的一个“子集”</p>
</li>
<li><p>一个应用程序</p>
<ul>
<li><p>可以是并发的，但不是并行的</p>
</li>
<li><p>可以是并行的，但不是并发的</p>
</li>
<li><p>既是并发的，又是并行的</p>
</li>
<li><p>既不是并发的，又不是并行的</p>
</li>
</ul>
</li>
</ul>
<h2 id="Linux进程状态"><a href="#Linux进程状态" class="headerlink" title="Linux进程状态"></a>Linux进程状态</h2><h3 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h3><ul>
<li>TASK_RUNNING: 就绪/可运行状态</li>
<li>TASK_INTERRUPTIBLE：进程被挂起（睡眠/被阻塞），直到等待条件为真被唤醒，处于此状态的进程也会因为接收到信号而提前被唤醒并随时准备投入运行。</li>
<li>TASK_UNINTERRUPTIBLE: 深度睡眠，睡眠期间不响应信号</li>
<li>TASK_STOPPED: 进程的执行被暂停；（通常这种状态在接收到 SIGSTOP等信号时候发生，在调试期间接受到的任何信号，都会使进程进入这种状态）</li>
<li>TASK_TRACED: 被其他进程跟踪，常用于调试</li>
<li>EXIT_ZOMBIE: 僵死状态，进程的执行被终止</li>
<li>EXIT_DEAD: 僵死撤销状态，防止wait类系统调用的竞争状态发生</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422101044.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422101437.png"></p>
<p>​    </p>
<h2 id="进程的UID和GID"><a href="#进程的UID和GID" class="headerlink" title="进程的UID和GID"></a>进程的UID和GID</h2><h3 id="进程的PID"><a href="#进程的PID" class="headerlink" title="进程的PID"></a>进程的PID</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422102810.png"></p>
<h3 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422103613.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422104838.png"></p>
<h3 id="进程UID和GID"><a href="#进程UID和GID" class="headerlink" title="进程UID和GID"></a>进程UID和GID</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422104854.png"></p>
<h2 id="通过proc查看进程资源"><a href="#通过proc查看进程资源" class="headerlink" title="通过proc查看进程资源"></a>通过proc查看进程资源</h2><h3 id="进程资源：task-struct"><a href="#进程资源：task-struct" class="headerlink" title="进程资源：task_struct"></a>进程资源：task_struct</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *<span class="built_in">stack</span>; </span><br><span class="line">    <span class="keyword">atomic_t</span> usage;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_</span> <span class="keyword">class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tasks</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>, *<span class="title">active_mm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vmacache</span>[<span class="title">VMACACHE_SIZE</span>];</span></span><br><span class="line">    <span class="keyword">int</span> exit_state;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">pid_t</span> tgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">parent</span>;</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bio_list</span> *<span class="title">bio_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">reclaim_state</span> *<span class="title">reclaim_state</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> pagefault_disabled;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> <span class="title">thread</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="通过ps命令查看进程资源"><a href="#通过ps命令查看进程资源" class="headerlink" title="通过ps命令查看进程资源"></a>通过ps命令查看进程资源</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422110920.png"></p>
<h3 id="通过proc查看进程资源-1"><a href="#通过proc查看进程资源-1" class="headerlink" title="通过proc查看进程资源"></a>通过proc查看进程资源</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422112041.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422112249.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422112305.png"></p>
<h2 id="与进程通信：信号"><a href="#与进程通信：信号" class="headerlink" title="与进程通信：信号"></a>与进程通信：信号</h2><h3 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h3><ul>
<li><p>信号是一种异步通信的IPC</p>
</li>
<li><p>可以给一个指定进程发送一个信号</p>
</li>
<li><p>进程根据接收信号类型作相应的处理</p>
</li>
<li><p>系统调用接口：signal、kill</p>
</li>
</ul>
<h3 id="一个进程对信号的处理"><a href="#一个进程对信号的处理" class="headerlink" title="一个进程对信号的处理"></a>一个进程对信号的处理</h3><p>三种处理方式</p>
<ul>
<li><p>如果注册信号处理回调函数的话，会调用注册的信号处理回调函数</p>
</li>
<li><p>如果没有注册的话，按照该信号在系统中的默认处理方式</p>
<ul>
<li>忽略</li>
<li>终止进程</li>
</ul>
</li>
</ul>
<h3 id="信号与其对应的系统事件"><a href="#信号与其对应的系统事件" class="headerlink" title="信号与其对应的系统事件"></a>信号与其对应的系统事件</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422153132.png"></p>
<h3 id="终端驱动支持的信号"><a href="#终端驱动支持的信号" class="headerlink" title="终端驱动支持的信号"></a>终端驱动支持的信号</h3><p>• CTRL + Z：SIGTSTP</p>
<p>• CTRL + \：SIGQUIT</p>
<p>• CTRL + C：SIGINT</p>
<h2 id="终端与控制台"><a href="#终端与控制台" class="headerlink" title="终端与控制台"></a>终端与控制台</h2><h3 id="终端的演变"><a href="#终端的演变" class="headerlink" title="终端的演变"></a>终端的演变</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422154316.png"></p>
<h3 id="控制台的概念"><a href="#控制台的概念" class="headerlink" title="控制台的概念"></a>控制台的概念</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422154333.png"></p>
<h3 id="虚拟终端"><a href="#虚拟终端" class="headerlink" title="虚拟终端"></a>虚拟终端</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422154825.png"></p>
<h3 id="伪终端"><a href="#伪终端" class="headerlink" title="伪终端"></a>伪终端</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422155417.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422155646.png"></p>
<h3 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h3><p>• 终端与控制台的界限正越来越模糊…</p>
<p>• $ tty：显示当前用户所在终端的文件名</p>
<h2 id="进程组与会话"><a href="#进程组与会话" class="headerlink" title="进程组与会话"></a>进程组与会话</h2><h3 id="进程组"><a href="#进程组" class="headerlink" title="进程组"></a>进程组</h3><p>什么是进程组</p>
<ul>
<li><p>进程组：一组协同工作或关联进程的组合，每个进程组有ID(PGID)</p>
</li>
<li><p>每个进程属于一个进程组，每个进程组有一个进程组长，该进程组长ID(PID)与进程组ID(PGID)相同</p>
</li>
<li><p>一个信号可以发送给进程组的所有进程、让所有进程终止、暂停或继续运行</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422161650.png"></p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>什么是会话？</p>
<ul>
<li>会话是一个或多个进程组的集合<ul>
<li>当用户登录系统时，登录进程会为这个用户创建一个新的会话(session)</li>
<li>shell进程(如bash)作为会话的第一个进程，称为<font color='9900CC'>会话首进程</font>(session leader)</li>
<li>会话的ID(SID)：等于会话首进程的PID</li>
<li>会话会分配给用户一个<font color='9900CC'>控制终端(只能有1个)</font>，用于处理用户的输入输出</li>
<li>一个会话包括了该登录用户的所有活动</li>
<li>会话中的进程组由一个前台进程组和N个后台进程组构成</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422161954.png"></p>
<p>进程与终端的关系</p>
<p>控制终端：跟会话关联的终端，每个会话会分配0或1个控制终端</p>
<ul>
<li><p><font color='red'>控制进程</font>：建立与控制终端连接的会话首进程称为控制进程</p>
</li>
<li><p>终端的输入和控制信号会发送给前台进程组中的每一个进程</p>
</li>
<li><p>控制终端与后台进程之间通过信号通信</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422163241.png"></p>
<h3 id="会话与shell"><a href="#会话与shell" class="headerlink" title="会话与shell"></a>会话与shell</h3><p>Shell解释器(bash)</p>
<ul>
<li><p>进程组和会话都是为支持shell工作而存在</p>
<ul>
<li>用户登录login、登录进程login为用户创建一个login session</li>
<li>我们登录的这个终端设备为该会话的控制终端</li>
<li>Shell进程为该会话首进程、控制进程</li>
<li>Shell进程ID为会话的ID</li>
</ul>
</li>
<li><p>为了完成一项任务、shell会启动多个进程(脚本、管道命令)，这些进程会构成一个进程组</p>
</li>
<li><p>会话的意义在于将很多一起协同工作或相关联的进程、进程组囊括在一个shell内，方便管理(如信号管理、资源管理等)</p>
</li>
</ul>
<h3 id="shell-解释器"><a href="#shell-解释器" class="headerlink" title="shell 解释器"></a>shell 解释器</h3><p>什么是shell？</p>
<ul>
<li><p>一个读取用户命令、执行命令的程序，也被称为命令解释器</p>
<ul>
<li><p>用于人机交互、对shell脚本进行解释、执行</p>
</li>
<li><p>内置环境变量、循环、条件语句、I/O命令、函数等</p>
</li>
<li><p>shell可以集成在OS内核中，也可以作为一个独立的应用进程运行</p>
</li>
</ul>
</li>
<li><p>登录shell进程：用户刚登录系统时，由系统创建来运行shell的进程</p>
<ul>
<li><p>Sh：bourne shell, UNIX标配shell,支持管道、重定向、环境变量、后台执行</p>
</li>
<li><p>Csh：脚本语言语法与C语言类似，支持历史记录、命令行编辑等</p>
</li>
<li><p>Ksh：兼容sh，并吸取了csh的一些交互式特性</p>
</li>
<li><p>Bash：GNU项目，目前Linux上使用最广泛的shell</p>
</li>
</ul>
</li>
</ul>
<h3 id="shell的工作流程"><a href="#shell的工作流程" class="headerlink" title="shell的工作流程"></a>shell的工作流程</h3><p>• Linux内核启动后启动init进程、解析/etc/inittab 登录信息启动getty进程</p>
<p>• getty进程调用setsid创建新的session和process group、提示用户登录</p>
<p>• 登录后调用exec加载login程序(/bin/login)(继承getty的PID、PGID、SID)</p>
<p>• Login进程对用户输入的用户名、密码进行验证</p>
<p>• Login根据用户输入到/etc/passwd 查找成功后，找出对应UID、GID，并与/etc/shadow文件中对应账号的UID进行匹配验证</p>
<p>• 验证成功后接着会设置该用户相关的主文件夹、启动shell交互环境</p>
<p>• 验证成功后会fork子进程并通过exec执行shell(如bash\csh等)</p>
<p>• 此时login和shell两个进程同属前台进程组、共享虚拟终端</p>
<p>• Shell进程通过setpgid创建新的进程组、分道扬镳、并将自己设置为前台进程组，跟用户交互</p>
<p>• 用户输入命令$ c1 | c2 |c3，shell会fork 3个子进程</p>
<p>• 为这3个进程创建新的进程组，并将该进程组推向前台</p>
<p>• 3个子进程执行：通过虚拟终端处理输入输出</p>
<p>• 子进程执行完毕、退出，shell进程又重新回到前台，等待用户新命令</p>
<h2 id="前台进程与后台进程"><a href="#前台进程与后台进程" class="headerlink" title="前台进程与后台进程"></a>前台进程与后台进程</h2><h3 id="进程的前后台"><a href="#进程的前后台" class="headerlink" title="进程的前后台"></a>进程的前后台</h3><ul>
<li><p>前台进程：占有控制终端的进程，其它称为后台进程</p>
</li>
<li><p>后台进程：</p>
<ul>
<li><p>shell中耗时较久的命令可以通过$ command &amp; 后台运行</p>
</li>
<li><p>好处：下一个命令不必等到上一个进程运行完才能运行</p>
</li>
<li><p>一个子进程在创建时若没指定进程组，系统自动创建一个进程组、该子进程为进程组的组长，若该进程后台执行，该进程组为后台进程组</p>
</li>
<li><p>会话将这些进程组囊括在一个shell终端内，选取其中一个进程组用来接收终端的输入或信号，这个进程组成为前台进程组</p>
</li>
<li><p>一个会话可以有多个后台进程组，但只能有一个前台进程组</p>
</li>
</ul>
</li>
</ul>
<h3 id="Shell与前后台"><a href="#Shell与前后台" class="headerlink" title="Shell与前后台"></a>Shell与前后台</h3><p>• Shell进程一开始工作在前台，等待用户输入命令</p>
<p>• 用户输入命令，shell进程通过fork &amp; exec执行命令</p>
<p>• shell被提到后台，运行的命令提到前台，接受用户输入</p>
<p>• 前台进程运行结束退出，shell自动被提到前台，等待用户输入</p>
<p>• …</p>
<h3 id="进程的前后台转换"><a href="#进程的前后台转换" class="headerlink" title="进程的前后台转换"></a>进程的前后台转换</h3><p>• Shell：前台进程+ 任意多个后台进程</p>
<p>• Ctrl + C：终止并退出前台进程，回到SHELL</p>
<p>• Ctrl + Z：暂停前台命令执行，放到后台，回到SHELL</p>
<p>• jobs：查看当前在后台执行的命令</p>
<p>• &amp;：在后台执行命令</p>
<p>• fg N：将进程号码为 N 的命令放到前台执行</p>
<p>• bg N：将进程号码为 N 的命令放到后台执行</p>
<p>– 注：该号码不是PID，是通过命令jobs看到的后台命令序号</p>
<h3 id="Android中的进程"><a href="#Android中的进程" class="headerlink" title="Android中的进程"></a>Android中的进程</h3><p>应用进程的淘汰机制</p>
<p>• 前台进程</p>
<p>• 可见进程</p>
<p>• 服务进程</p>
<p>• 后台进程</p>
<h2 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h2><h3 id="守护进程的概念"><a href="#守护进程的概念" class="headerlink" title="守护进程的概念"></a>守护进程的概念</h3><ul>
<li><p>Daemon：运行在后台的服务程序，周期性执行系统级任务或等待处理某些发生的事件(热插拔事件、信号等)</p>
</li>
<li><p>独立于终端，不与任何控制终端相关联</p>
</li>
<li><p>打印信息不会打印到终端上</p>
</li>
<li><p>守护进程会创建自己新的会话，避免与其它会话产生关系</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422192045.png"></p>
<h3 id="守护进程的特点"><a href="#守护进程的特点" class="headerlink" title="守护进程的特点"></a>守护进程的特点</h3><p>• 后台运行，不与控制终端相连</p>
<p>• 不受用户登录或注销的影响，一直在运行，一般为系统服务进程</p>
<p>• 生命周期较长，一般随系统启动和关闭，一直运行系统退出</p>
<p>• 不受SIGINT、SIGQUIT、SIGTSTP跟终端相关的信号影响</p>
<p>• 关闭终端不会影响daemon进程的运行</p>
<p>• 守护进程命名：sshd、inetd、httpd (命名不是绝对的、通用的</p>
<h3 id="查看守护进程"><a href="#查看守护进程" class="headerlink" title="查看守护进程"></a>查看守护进程</h3><p>$ ps –axj | more </p>
<ul>
<li><p>参数a：列出所有用户的进程</p>
</li>
<li><p>参数x：不仅列出控制终端的进程，还列出所有无控制终端的进程</p>
</li>
<li><p>参数j：列出与作业控制相关的信息</p>
</li>
</ul>
<h3 id="守护进程的应用"><a href="#守护进程的应用" class="headerlink" title="守护进程的应用"></a>守护进程的应用</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422193844.png"></p>
<h3 id="守护进程的启动"><a href="#守护进程的启动" class="headerlink" title="守护进程的启动"></a>守护进程的启动</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230422194027.png"></p>
<h3 id="后台进程与守护进程的区别"><a href="#后台进程与守护进程的区别" class="headerlink" title="后台进程与守护进程的区别"></a>后台进程与守护进程的区别</h3><p>• 守护进程已经完全脱离终端控制</p>
<p>• 后台程序没有脱离终端控制，一些信息会输出到终端</p>
<p>• 关闭终端时，后台进程会随之终止，而守护进程可以继续运行</p>
<p>• 守护进程有独立的会话、文件描述符、工作目录，而后台进程是继承父进程的</p>
<h3 id="编写一个守护进程并运行"><a href="#编写一个守护进程并运行" class="headerlink" title="编写一个守护进程并运行"></a>编写一个守护进程并运行</h3><ul>
<li><p>屏蔽一些控制终端操作的信号</p>
</li>
<li><p>调用fork，父进程退出</p>
</li>
<li><p>setsid创建一个新会话</p>
</li>
<li><p>禁止进程重新打开控制终端</p>
</li>
<li><p>关闭打开的文件描述符</p>
</li>
<li><p>改变当前工作目录</p>
</li>
<li><p>重设文件创建掩模</p>
</li>
<li><p>处理SIGCHLD信号</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    signal (SIGTTOU, SIG_IGN); <span class="comment">// umask signal from terminal</span></span><br><span class="line">    signal (SIGTTIN, SIG_IGN);</span><br><span class="line">    signal (SIGTSTP, SIG_IGN);</span><br><span class="line">    signal (SIGHUP, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    umask (<span class="number">0</span>); <span class="comment">// umask file mode inheriting from father process</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> ret_id = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>); <span class="comment">// father process exit</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid (); <span class="comment">// run child process in a new session</span></span><br><span class="line"></span><br><span class="line">    signal (SIGCHLD, SIG_IGN); <span class="comment">// ignore SIGCHID from child process when exited</span></span><br><span class="line"></span><br><span class="line">    ret_id = fork (); <span class="comment">// fork again</span></span><br><span class="line">    <span class="keyword">if</span> (ret_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>); <span class="comment">// forbidden connect to terminal</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chdir (<span class="string">&quot;/&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;chdir&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close (<span class="number">0</span>);</span><br><span class="line">    close (<span class="number">1</span>);</span><br><span class="line">    close (<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h2><h3 id="父进程和子进程的关联"><a href="#父进程和子进程的关联" class="headerlink" title="父进程和子进程的关联"></a>父进程和子进程的关联</h3><ul>
<li><p>在父进程中使用fork创建子进程、在调度器调度下分别调度运行</p>
</li>
<li><p>子进程运行结束退出，内核释放相关资源</p>
<ul>
<li>释放占用的内存、打开的文件</li>
<li>仍保留一定的信息：进程ID、退出状态、运行时间等</li>
</ul>
</li>
<li><p>父进程会调用wait/waitid 获取子进程的退出状态，释放最后的资源</p>
</li>
</ul>
<h3 id="什么是僵尸进程？"><a href="#什么是僵尸进程？" class="headerlink" title="什么是僵尸进程？"></a>什么是僵尸进程？</h3><ul>
<li><p>如果子进程exit退出，父进程没有调用wait获取子进程状态，那么子进程的相关资源仍然保存在系统中，这种进程称为僵尸进程</p>
</li>
<li><p>僵尸进程会占用PID等资源，如果系统中存在大量僵尸进程，会影响fork子进程</p>
</li>
</ul>
<h3 id="创建一个僵尸进程，并观察进程的状态"><a href="#创建一个僵尸进程，并观察进程的状态" class="headerlink" title="创建一个僵尸进程，并观察进程的状态"></a>创建一个僵尸进程，并观察进程的状态</h3><p>进程的不同状态</p>
<p>• R：task_running，可执行状态</p>
<p>• S：task_interruptible，可中断的睡眠状态</p>
<p>• D：task_uninterruptible，不可中断的睡眠状态</p>
<p>• T：task_stopped、task_traced，暂停状态或跟踪状态</p>
<p>• Z：task_dead、exit_zombie，退出状态，进程成为僵尸进程</p>
<p>• X：task_dead、exit_dead，退出状态，进程即将被销毁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork ();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process, pid: %d piid:%d\n&quot;</span>, getpid (), getppid ());</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process exit. \n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;father process sleep 5 seconds\n&quot;</span>);</span><br><span class="line">    sleep (<span class="number">5</span>);</span><br><span class="line">    system (<span class="string">&quot;ps -o pid,ppid,state,tty,command &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;father process exited.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="孤儿进程"><a href="#孤儿进程" class="headerlink" title="孤儿进程"></a>孤儿进程</h2><h3 id="什么是孤儿进程？"><a href="#什么是孤儿进程？" class="headerlink" title="什么是孤儿进程？"></a>什么是孤儿进程？</h3><p>• 每一个进程都是从父进程fork出来的</p>
<p>• 一般情况下父进程会通过wait/waitid系统调用等待子进程退出，获取到子进程状态，释放相关资源后才会退出</p>
<p>• 若父进程退出时，子进程还没退出，会将进程托管给init进程，则子进程就变成了孤儿进程</p>
<h3 id="编程示例"><a href="#编程示例" class="headerlink" title="编程示例"></a>编程示例</h3><p>• 创建一个孤儿进程</p>
<p>• 观察孤儿进程的pid 和 ppid 变化情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork ();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process run pid: %d ppid %d\n&quot;</span>, getpid (), getppid() );</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process sleep 5 seconds\n&quot;</span>);</span><br><span class="line">        sleep (<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process wake pid: %d ppid: %d\n&quot;</span>, getpid (), getppid ());</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process run pid: %d ppid: %d\n&quot;</span>, getpid(), getppid());</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process sleep 1 seconds\n&quot;</span>);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;father process exited!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>• 在图形模式下，孤儿进程的托管进程为upstart，pid不为1</p>
<p>• 在文本模式虚拟终端下，孤儿进程的托管进程init的pid为1</p>
<p>• 为什么？</p>
<h3 id="init服务进程的演变"><a href="#init服务进程的演变" class="headerlink" title="init服务进程的演变"></a>init服务进程的演变</h3><p>• Sysvinit</p>
<p>• Upstart </p>
<p>• Systemd</p>
<h2 id="0号进程和1号进程"><a href="#0号进程和1号进程" class="headerlink" title="0号进程和1号进程"></a>0号进程和1号进程</h2><h3 id="Linux进程的起源"><a href="#Linux进程的起源" class="headerlink" title="Linux进程的起源"></a>Linux进程的起源</h3><p>0号进程：</p>
<ul>
<li><p>即idle进程，Linux内核启动后创建的第一个进程</p>
</li>
<li><p>唯一没有 通过fork或者kernel_thread创建的进程</p>
</li>
</ul>
<p>1号进程：即init进程</p>
<ul>
<li><p>由idle进程通过kernel_thread创建，在内核空间完成初始化后，加载init程序，转变为用户空间的第一个进程</p>
</li>
<li><p>Linux所有用户进程都是由init进程fork创建的，init是用户进程的“祖先”</p>
</li>
<li><p>Init进程在系统启动后会转变为守护进程，托管孤儿进程，变为“孤儿院”</p>
</li>
</ul>
<p>2号进程</p>
<ul>
<li><p>即kthreadd内核线程，由kernel_thread创建，运行在内核空间</p>
</li>
<li><p>负责内核线程的调度和管理</p>
</li>
</ul>
<h3 id="0号进程"><a href="#0号进程" class="headerlink" title="0号进程"></a>0号进程</h3><p>从0到1</p>
<ul>
<li><code>start_kernel</code>: 初始化内核的各个组件，包括调度器，调用 <code>init_task</code></li>
<li><code>init_task</code>，内核中所有进程、线程的<code>task_struct</code>的雏形</li>
<li><code>init_task</code> 调用 <code>kernel_thread</code>创建内核 <code>init</code>进程、<code>kthreadadd</code>内核进程</li>
<li>内核初始化后，<code>init_task</code>最终演变为 0号进程 idle</li>
<li>内核开始调度执行，当无进程运行时，会调度 idle 进程运行</li>
</ul>
<h3 id="1号进程"><a href="#1号进程" class="headerlink" title="1号进程"></a>1号进程</h3><p>从1到用户空间进程</p>
<ul>
<li><p>Start_kernel-&gt;rest_init-&gt;kernel_thread(kernel_init, NULL, CLONE_FS);</p>
</li>
<li><p>若用户通过init启动参数显式指定，运行用户指定的程序</p>
</li>
<li><p>若没指定：kernel_init-&gt;execve(/sbin/init) 运行init进程</p>
<ul>
<li>/sbin/init</li>
<li>/etc/init</li>
<li>/bin/init</li>
<li>/bin/sh</li>
</ul>
</li>
<li><p>1号init进程从内核态转换为用户态，变为用户进程的“祖先”</p>
</li>
<li><p>用户态init进程从/etc/inittab中完成各种初始化</p>
<ul>
<li>初始化系统、启动各种服务    </li>
<li>启动登录服务</li>
<li>用户态init进程接着执行/bin/bash启动shell进程</li>
<li>0号进程-&gt;init内核进程-&gt;1号init用户进程-&gt;getty进程-&gt;shell进程</li>
</ul>
</li>
</ul>
<h3 id="Linux操作系统的init服务进程"><a href="#Linux操作系统的init服务进程" class="headerlink" title="Linux操作系统的init服务进程"></a>Linux操作系统的init服务进程</h3><p>init服务进程的演变</p>
<ul>
<li><p>sysvinit</p>
<ul>
<li>通过runlevel预定义运行模式：<ul>
<li>runlevel 3为命令行模式，5为图形界面模式，0是关机，6是重启。提供各种命令：reboot、shutdown等</li>
<li>运行位于/etc/rc*.d(一般链接到/etc/init.d)的脚本来启动各种系统服务</li>
</ul>
</li>
<li>缺点：按脚本顺序启动服务，耗时较长，不适用消费电子</li>
</ul>
</li>
<li><p>upstart</p>
<ul>
<li>基于事件驱动机制，动态开启、关闭相关服务</li>
<li>并行启动各种服务，启动速度快，适用于便携式设备</li>
</ul>
</li>
<li><p>systemd</p>
<ul>
<li>Linux桌面系统最新的初始化系统(init)、功能更强大</li>
<li>采用socket与总线激活式提高各个服务的并行运行性能</li>
<li>在Ubuntu等桌面操作系统中广泛使用</li>
</ul>
</li>
</ul>
<h3 id="嵌入式中的init服务进程"><a href="#嵌入式中的init服务进程" class="headerlink" title="嵌入式中的init服务进程"></a>嵌入式中的init服务进程</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423101900.png"></p>
<h2 id="Linux进程全景图"><a href="#Linux进程全景图" class="headerlink" title="Linux进程全景图"></a>Linux进程全景图</h2><p> pstree</p>
<p>• 查看当前系统所有进程的关系</p>
<p>• -a：显示系统所有的进程</p>
<p>• -A：使用ASCII字符格式显示</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">sineagle@VM-20-16-ubuntu:~/study/zhaixue/program-linux/chap4/19$ pstree</span></span><br><span class="line"><span class="xml">systemd─┬─YDLive─┬─YDService─┬─sh───8*[</span><span class="template-variable">&#123;sh&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        │        │           └─23*[</span><span class="template-variable">&#123;YDService&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        │        └─9*[</span><span class="template-variable">&#123;YDLive&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─accounts-daemon───2*[</span><span class="template-variable">&#123;accounts-daemon&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─acpid</span></span><br><span class="line"><span class="xml">        ├─2*[agetty]</span></span><br><span class="line"><span class="xml">        ├─atd</span></span><br><span class="line"><span class="xml">        ├─barad_agent─┬─barad_agent</span></span><br><span class="line"><span class="xml">        │             └─barad_agent───3*[</span><span class="template-variable">&#123;barad_agent&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─bash</span></span><br><span class="line"><span class="xml">        ├─cron</span></span><br><span class="line"><span class="xml">        ├─dbus-daemon</span></span><br><span class="line"><span class="xml">        ├─2*[iscsid]</span></span><br><span class="line"><span class="xml">        ├─multipathd───6*[</span><span class="template-variable">&#123;multipathd&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─named───7*[</span><span class="template-variable">&#123;named&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─networkd-dispat</span></span><br><span class="line"><span class="xml">        ├─ntpd───</span><span class="template-variable">&#123;ntpd&#125;</span></span><br><span class="line"><span class="xml">        ├─polkitd───2*[</span><span class="template-variable">&#123;polkitd&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─rpcbind</span></span><br><span class="line"><span class="xml">        ├─rsyslogd───3*[</span><span class="template-variable">&#123;rsyslogd&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─sgagent───</span><span class="template-variable">&#123;sgagent&#125;</span></span><br><span class="line"><span class="xml">        ├─sshd─┬─sshd───sshd───bash─┬─sh───node─┬─node───10*[</span><span class="template-variable">&#123;node&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        │      │                    │           ├─node───11*[</span><span class="template-variable">&#123;node&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        │      │                    │           ├─node───12*[</span><span class="template-variable">&#123;node&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        │      │                    │           └─10*[</span><span class="template-variable">&#123;node&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        │      │                    └─sleep</span></span><br><span class="line"><span class="xml">        │      └─sshd───sshd───bash───tmux: client</span></span><br><span class="line"><span class="xml">        ├─systemd─┬─(sd-pam)</span></span><br><span class="line"><span class="xml">        │         └─dbus-daemon</span></span><br><span class="line"><span class="xml">        ├─systemd-journal</span></span><br><span class="line"><span class="xml">        ├─systemd-logind</span></span><br><span class="line"><span class="xml">        ├─systemd-network</span></span><br><span class="line"><span class="xml">        ├─systemd-resolve</span></span><br><span class="line"><span class="xml">        ├─systemd-udevd</span></span><br><span class="line"><span class="xml">        ├─tat_agent───6*[</span><span class="template-variable">&#123;tat_agent&#125;</span><span class="xml">]</span></span><br><span class="line"><span class="xml">        ├─tmux: server─┬─4*[bash]</span></span><br><span class="line"><span class="xml">        │              └─bash───pstree</span></span><br><span class="line"><span class="xml">        └─unattended-upgr───</span><span class="template-variable">&#123;unattended-upgr&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">systemd</span>(<span class="number">1</span>)─┬─<span class="selector-tag">YDLive</span>(<span class="number">6932</span>)─┬─<span class="selector-tag">YDService</span>(<span class="number">2199463</span>)─┬─<span class="selector-tag">sh</span>(<span class="number">2204018</span>)─┬─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204020</span>)</span><br><span class="line">           │              │                    │             ├─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204021</span>)</span><br><span class="line">           │              │                    │             ├─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204022</span>)</span><br><span class="line">           │              │                    │             ├─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204023</span>)</span><br><span class="line">           │              │                    │             ├─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204024</span>)</span><br><span class="line">           │              │                    │             ├─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204025</span>)</span><br><span class="line">           │              │                    │             ├─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2204026</span>)</span><br><span class="line">           │              │                    │             └─&#123;<span class="selector-tag">sh</span>&#125;(<span class="number">2248543</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199464</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199465</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199466</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199467</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199468</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199476</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199483</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199484</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199485</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199668</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199669</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199670</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199679</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199680</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199681</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199682</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199690</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199691</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199692</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199693</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199705</span>)</span><br><span class="line">           │              │                    ├─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">2199709</span>)</span><br><span class="line">           │              │                    └─&#123;<span class="selector-tag">YDService</span>&#125;(<span class="number">1793109</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">6934</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">6935</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">6936</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">6937</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">6938</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">6941</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">11986</span>)</span><br><span class="line">           │              ├─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">3990932</span>)</span><br><span class="line">           │              └─&#123;<span class="selector-tag">YDLive</span>&#125;(<span class="number">2763089</span>)</span><br><span class="line">           ├─<span class="selector-tag">accounts-daemon</span>(<span class="number">752</span>)─┬─&#123;<span class="selector-tag">accounts-daemon</span>&#125;(<span class="number">757</span>)</span><br><span class="line">           │                      └─&#123;<span class="selector-tag">accounts-daemon</span>&#125;(<span class="number">907</span>)</span><br><span class="line">           ├─<span class="selector-tag">acpid</span>(<span class="number">753</span>)</span><br><span class="line">           ├─<span class="selector-tag">agetty</span>(<span class="number">1080</span>)</span><br><span class="line">           ├─<span class="selector-tag">agetty</span>(<span class="number">1082</span>)</span><br><span class="line">           ├─<span class="selector-tag">atd</span>(<span class="number">894</span>)</span><br><span class="line">           ├─<span class="selector-tag">barad_agent</span>(<span class="number">2288632</span>)─┬─<span class="selector-tag">barad_agent</span>(<span class="number">2288633</span>)</span><br><span class="line">           │                      └─<span class="selector-tag">barad_agent</span>(<span class="number">2288634</span>)─┬─&#123;<span class="selector-tag">barad_agent</span>&#125;(<span class="number">2288679</span>)</span><br><span class="line">           │                                             ├─&#123;<span class="selector-tag">barad_agent</span>&#125;(<span class="number">2288699</span>)</span><br><span class="line">           │                                             └─&#123;<span class="selector-tag">barad_agent</span>&#125;(<span class="number">2839931</span>)</span><br><span class="line">           ├─<span class="selector-tag">bash</span>(<span class="number">1869207</span>)</span><br><span class="line">           ├─<span class="selector-tag">cron</span>(<span class="number">882</span>)</span><br><span class="line">           ├─<span class="selector-tag">dbus-daemon</span>(<span class="number">755</span>)</span><br><span class="line">           ├─<span class="selector-tag">iscsid</span>(<span class="number">814</span>)</span><br><span class="line">           ├─<span class="selector-tag">iscsid</span>(<span class="number">815</span>)</span><br><span class="line">           ├─<span class="selector-tag">multipathd</span>(<span class="number">640</span>)─┬─&#123;<span class="selector-tag">multipathd</span>&#125;(<span class="number">641</span>)</span><br><span class="line">           │                 ├─&#123;<span class="selector-tag">multipathd</span>&#125;(<span class="number">642</span>)</span><br><span class="line">           │                 ├─&#123;<span class="selector-tag">multipathd</span>&#125;(<span class="number">643</span>)</span><br><span class="line">           │                 ├─&#123;<span class="selector-tag">multipathd</span>&#125;(<span class="number">644</span>)</span><br><span class="line">           │                 ├─&#123;<span class="selector-tag">multipathd</span>&#125;(<span class="number">645</span>)</span><br><span class="line">           │                 └─&#123;<span class="selector-tag">multipathd</span>&#125;(<span class="number">646</span>)</span><br><span class="line">           ├─<span class="selector-tag">named</span>(<span class="number">1866449</span>)─┬─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866460</span>)</span><br><span class="line">           │                ├─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866461</span>)</span><br><span class="line">           │                ├─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866462</span>)</span><br><span class="line">           │                ├─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866463</span>)</span><br><span class="line">           │                ├─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866464</span>)</span><br><span class="line">           │                ├─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866465</span>)</span><br><span class="line">           │                └─&#123;<span class="selector-tag">named</span>&#125;(<span class="number">1866466</span>)</span><br><span class="line">           ├─<span class="selector-tag">networkd-dispat</span>(<span class="number">773</span>)</span><br><span class="line">           ├─<span class="selector-tag">ntpd</span>(<span class="number">1871186</span>)───&#123;<span class="selector-tag">ntpd</span>&#125;(<span class="number">1871187</span>)</span><br><span class="line">           ├─<span class="selector-tag">polkitd</span>(<span class="number">989</span>)─┬─&#123;<span class="selector-tag">polkitd</span>&#125;(<span class="number">1010</span>)</span><br><span class="line">           │              └─&#123;<span class="selector-tag">polkitd</span>&#125;(<span class="number">1013</span>)</span><br><span class="line">           ├─<span class="selector-tag">rpcbind</span>(<span class="number">665</span>)</span><br><span class="line">           ├─<span class="selector-tag">rsyslogd</span>(<span class="number">1866787</span>)─┬─&#123;<span class="selector-tag">rsyslogd</span>&#125;(<span class="number">1866798</span>)</span><br><span class="line">           │                   ├─&#123;<span class="selector-tag">rsyslogd</span>&#125;(<span class="number">1866799</span>)</span><br><span class="line">           │                   └─&#123;<span class="selector-tag">rsyslogd</span>&#125;(<span class="number">1866800</span>)</span><br><span class="line">           ├─<span class="selector-tag">sgagent</span>(<span class="number">1195</span>)───&#123;<span class="selector-tag">sgagent</span>&#125;(<span class="number">1196</span>)</span><br><span class="line">           ├─<span class="selector-tag">sshd</span>(<span class="number">1866708</span>)─┬─<span class="selector-tag">sshd</span>(<span class="number">2807412</span>)───<span class="selector-tag">sshd</span>(<span class="number">2807541</span>)───<span class="selector-tag">bash</span>(<span class="number">2807542</span>)─┬─<span class="selector-tag">sh</span>(<span class="number">2807586</span>)───<span class="selector-tag">node</span>(<span class="number">2807596</span>)─┬─<span class="selector-tag">node</span>(<span class="number">2807633</span>)─┬─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807636</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807637</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807638</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807639</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807640</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807651</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807653</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807654</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807655</span>)</span><br><span class="line">           │               │                                               │                             │               └─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807656</span>)</span><br><span class="line">           │               │                                               │                             ├─<span class="selector-tag">node</span>(<span class="number">2807657</span>)─┬─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807658</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807659</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807660</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807661</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807662</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807663</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807664</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807665</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807666</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807667</span>)</span><br><span class="line">           │               │                                               │                             │               └─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807682</span>)</span><br><span class="line">           │               │                                               │                             ├─<span class="selector-tag">node</span>(<span class="number">2807668</span>)─┬─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807669</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807670</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807671</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807672</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807673</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807674</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807675</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807676</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807677</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807678</span>)</span><br><span class="line">           │               │                                               │                             │               ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807679</span>)</span><br><span class="line">           │               │                                               │                             │               └─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807680</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807597</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807598</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807599</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807600</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807601</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807602</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807609</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807610</span>)</span><br><span class="line">           │               │                                               │                             ├─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807611</span>)</span><br><span class="line">           │               │                                               │                             └─&#123;<span class="selector-tag">node</span>&#125;(<span class="number">2807612</span>)</span><br><span class="line">           │               │                                               └─<span class="selector-tag">sleep</span>(<span class="number">2839834</span>)</span><br><span class="line">           │               └─<span class="selector-tag">sshd</span>(<span class="number">2807749</span>)───<span class="selector-tag">sshd</span>(<span class="number">2807821</span>)─┬─<span class="selector-tag">bash</span>(<span class="number">2807822</span>)───<span class="selector-tag">pstree</span>(<span class="number">2839932</span>)</span><br><span class="line">           │                                               └─<span class="selector-tag">sftp-server</span>(<span class="number">2839467</span>)</span><br><span class="line">           ├─<span class="selector-tag">systemd</span>(<span class="number">9749</span>)─┬─(sd-pam)(<span class="number">9751</span>)</span><br><span class="line">           │               └─<span class="selector-tag">dbus-daemon</span>(<span class="number">18835</span>)</span><br><span class="line">           ├─<span class="selector-tag">systemd-journal</span>(<span class="number">1863978</span>)</span><br><span class="line">           ├─<span class="selector-tag">systemd-logind</span>(<span class="number">798</span>)</span><br><span class="line">           ├─<span class="selector-tag">systemd-network</span>(<span class="number">1863951</span>)</span><br><span class="line">           ├─<span class="selector-tag">systemd-resolve</span>(<span class="number">1863974</span>)</span><br><span class="line">           ├─<span class="selector-tag">systemd-udevd</span>(<span class="number">1865863</span>)</span><br><span class="line">           ├─<span class="selector-tag">tat_agent</span>(<span class="number">3398784</span>)─┬─&#123;<span class="selector-tag">tat_agent</span>&#125;(<span class="number">3398785</span>)</span><br><span class="line">           │                    ├─&#123;<span class="selector-tag">tat_agent</span>&#125;(<span class="number">3398786</span>)</span><br><span class="line">           │                    ├─&#123;<span class="selector-tag">tat_agent</span>&#125;(<span class="number">3398787</span>)</span><br><span class="line">           │                    ├─&#123;<span class="selector-tag">tat_agent</span>&#125;(<span class="number">3398788</span>)</span><br><span class="line">           │                    ├─&#123;<span class="selector-tag">tat_agent</span>&#125;(<span class="number">3398789</span>)</span><br><span class="line">           │                    └─&#123;<span class="selector-tag">tat_agent</span>&#125;(<span class="number">3398790</span>)</span><br><span class="line">           ├─<span class="selector-tag">tmux</span>: <span class="selector-tag">server</span>(<span class="number">175001</span>)─┬─<span class="selector-tag">bash</span>(<span class="number">175002</span>)</span><br><span class="line">           │                      ├─<span class="selector-tag">bash</span>(<span class="number">175010</span>)</span><br><span class="line">           │                      ├─<span class="selector-tag">bash</span>(<span class="number">1525958</span>)</span><br><span class="line">           │                      ├─<span class="selector-tag">bash</span>(<span class="number">2618846</span>)</span><br><span class="line">           │                      └─<span class="selector-tag">bash</span>(<span class="number">2819679</span>)</span><br><span class="line">           └─<span class="selector-tag">unattended-upgr</span>(<span class="number">958</span>)───&#123;<span class="selector-tag">unattended-upgr</span>&#125;(<span class="number">1075</span>)</span><br></pre></td></tr></table></figure>







<h1 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h1><h2 id="进程间通信IPC"><a href="#进程间通信IPC" class="headerlink" title="进程间通信IPC"></a>进程间通信IPC</h2><h3 id="进程的地址空间"><a href="#进程的地址空间" class="headerlink" title="进程的地址空间"></a>进程的地址空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423161811.png"></p>
<h3 id="进程的物理空间"><a href="#进程的物理空间" class="headerlink" title="进程的物理空间"></a>进程的物理空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423164212.png"></p>
<h3 id="进程间通信-1"><a href="#进程间通信-1" class="headerlink" title="进程间通信"></a>进程间通信</h3><ul>
<li>通过文件</li>
<li>通过内核</li>
<li>共享内存</li>
<li>实验：两个进程通过磁盘文件交换数据</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423164532.png"></p>
<h3 id="使用文件实现两个进程通讯"><a href="#使用文件实现两个进程通讯" class="headerlink" title="使用文件实现两个进程通讯"></a>使用文件实现两个进程通讯</h3><h4 id="sender"><a href="#sender" class="headerlink" title="sender"></a>sender</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;write process pid: %d\n&quot;</span>, getpid() );</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (n = read (STDIN_FILENO, buf, <span class="number">64</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> fd = open (<span class="string">&quot;data.txt&quot;</span>, O_WRONLY | O_CREAT, <span class="number">0664</span>);</span><br><span class="line">            <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buf[n] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            write (fd, buf, n + <span class="number">1</span>);</span><br><span class="line">            close (fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="receiver"><a href="#receiver" class="headerlink" title="receiver"></a>receiver</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;read process pid: %d\n&quot;</span>, getpid ());</span><br><span class="line">    <span class="keyword">int</span> fd = open (<span class="string">&quot;data.txt&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> last_len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((len = read (fd, buf, <span class="number">64</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            close (fd);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">        lseek (fd, SEEK_SET, <span class="number">0</span>);</span><br><span class="line">        sleep (<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close (fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Linux-进程间通信"><a href="#Linux-进程间通信" class="headerlink" title="Linux 进程间通信"></a>Linux 进程间通信</h3><h4 id="什么是IPC？"><a href="#什么是IPC？" class="headerlink" title="什么是IPC？"></a>什么是IPC？</h4><p>• IPC：inter-process communication</p>
<p>• Pipe、FIFO</p>
<p>• System V IPC： message queue、semaphore、share-memory</p>
<p>• POSIX IPC ： message queue、semaphore、share-memory</p>
<p>• Signal</p>
<p>• Socket IPC </p>
<p>• D-BUS</p>
<p>• …</p>
<h4 id="IPC工具的分类"><a href="#IPC工具的分类" class="headerlink" title="IPC工具的分类"></a>IPC工具的分类</h4><p>通信</p>
<ul>
<li><p>进程之间的数据传输、交换</p>
</li>
<li><p>管道、FIFO、socket、消息队列、共享内存、内存映射</p>
</li>
</ul>
<p>同步</p>
<ul>
<li><p>进程或线程操作之间的同步</p>
</li>
<li><p>信号量、条件变量、文件锁、读写锁</p>
</li>
</ul>
<p>异步通信</p>
<ul>
<li>信号</li>
</ul>
<h4 id="不同IPC的应用场合"><a href="#不同IPC的应用场合" class="headerlink" title="不同IPC的应用场合"></a>不同IPC的应用场合</h4><ul>
<li><p>无名管道：只能用于亲缘关系的进程</p>
</li>
<li><p>有名管道：任意两进程间通信</p>
</li>
<li><p>信号量：进程间同步，包括system V 信号量、POSIX信号量</p>
</li>
<li><p>消息队列：数据传输，包括system V 消息队列、POSIX消息队列</p>
</li>
<li><p>共享内存：数据传输，包括system V 共享内存、POSIX共享内存</p>
</li>
<li><p>信号：主要用于进程间异步通信</p>
</li>
<li><p>Linux新增API：signalfd、timerfd、eventfd</p>
</li>
<li><p>Socket IPC：不同主机不同进程之间的通信</p>
</li>
<li><p>D-BUS：用于桌面应用程序之间的通信</p>
</li>
</ul>
<h2 id="无名管道：PIPE"><a href="#无名管道：PIPE" class="headerlink" title="无名管道：PIPE"></a>无名管道：PIPE</h2><h3 id="Linux内核中的管道"><a href="#Linux内核中的管道" class="headerlink" title="Linux内核中的管道"></a>Linux内核中的管道</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423192753.png"></p>
<p>在内核空间开辟一个缓冲区，不同的进程就可以通过这个缓冲区进行读写达到通信的的目的</p>
<p>对于这样一个缓冲区，内核空间把它看成一个文件来对待，对于用户空间的进程来说，对这片缓冲区像文件一样进行读写，但是这个文件为管道文件，比较特殊是没有名字的，只能通过文件描述符对它进行读写，因此叫做无名管道</p>
<h3 id="PIPE的内核层实现"><a href="#PIPE的内核层实现" class="headerlink" title="PIPE的内核层实现"></a>PIPE的内核层实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $ locate pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> wait;</span><br><span class="line">    <span class="keyword">char</span> *base; <span class="comment">//指向管道缓存首地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len; <span class="comment">//管道缓存使用的长度</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> start; <span class="comment">//读缓存开始的位置</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> waiting_writers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423194935.png"></p>
<h4 id="通信原理"><a href="#通信原理" class="headerlink" title="通信原理"></a>通信原理</h4><p>管道是一个文件(pipefs)：</p>
<ul>
<li><p><font color='9900CC'>内核将一个缓冲区与管道文件进行关联、封装</font></p>
</li>
<li><p>用户可通过open/read/write/close等I/O接口进行读写</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423195441.png"></p>
<ul>
<li><p>像一个管道连接两个进程</p>
</li>
<li><p>一个进程的输出作为另一个进程的输入</p>
</li>
<li><p>用于亲缘进程之间的通信：共享资源</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423200020.png"></p>
<h3 id="PIPE管道编程"><a href="#PIPE管道编程" class="headerlink" title="PIPE管道编程"></a>PIPE管道编程</h3><h4 id="创建一个管道"><a href="#创建一个管道" class="headerlink" title="创建一个管道"></a>创建一个管道</h4><p>函数原型：</p>
<ul>
<li><p>int pipe (int pipefd[2]);</p>
</li>
<li><p>int pipe2(int pipefd[2], int flags);</p>
</li>
</ul>
<p>函数参数：管道的两个文件描述符：一个用来读、一个用来写</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423200348.png"></p>
<h4 id="编程实例"><a href="#编程实例" class="headerlink" title="编程实例"></a>编程实例</h4><ul>
<li>单向通信</li>
<li>双向通信</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230423200717.png"></p>
<h5 id="单向通信"><a href="#单向通信" class="headerlink" title="单向通信"></a>单向通信</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span>(EXIT_FAILURE);&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (pipe (pipe_fd) == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> str[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process: \n input string: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">        write (pipe_fd[<span class="number">1</span>], str, <span class="built_in">strlen</span> (str));</span><br><span class="line">        close (pipe_fd[<span class="number">1</span>]);</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read (pipe_fd[<span class="number">0</span>], buf, <span class="number">30</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;parent process: %s\n&quot;</span>, buf);</span><br><span class="line">        close (pipe_fd[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="双向通信"><a href="#双向通信" class="headerlink" title="双向通信"></a>双向通信</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd1[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> pipe_fd2[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe (pipe_fd1) == <span class="number">-1</span> || pipe (pipe_fd2) == <span class="number">-1</span>) handle_error (<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> read_buf1[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">char</span> write_buf1[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, write_buf1);</span><br><span class="line">        write (pipe_fd1[<span class="number">1</span>], write_buf1, <span class="built_in">strlen</span> (write_buf1));</span><br><span class="line">        close (pipe_fd1[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        read (pipe_fd2[<span class="number">0</span>], read_buf1, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;in child process %s\n&quot;</span>, read_buf1);</span><br><span class="line">        close (pipe_fd2[<span class="number">0</span>]);</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> read_buf2[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">char</span> write_buf2[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read (pipe_fd1[<span class="number">0</span>], read_buf2, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;in parent process: %s\n&quot;</span>, read_buf2);</span><br><span class="line">        close (pipe_fd1[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;parent process: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, write_buf2);</span><br><span class="line">        write (pipe_fd2[<span class="number">1</span>], write_buf2, <span class="built_in">strlen</span> (write_buf2));</span><br><span class="line">        close (pipe_fd2[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="shell管道的实现"><a href="#shell管道的实现" class="headerlink" title="shell管道的实现"></a>shell管道的实现</h3><h4 id="管道的作用"><a href="#管道的作用" class="headerlink" title="管道的作用"></a>管道的作用</h4><p>• Shell中具有亲缘关系的进程之间传递消息</p>
<p>• 管道的本质是一个字节流</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424084059.png"></p>
<h4 id="基本流程和重定向功能"><a href="#基本流程和重定向功能" class="headerlink" title="基本流程和重定向功能"></a>基本流程和重定向功能</h4><ul>
<li><p>封装成进程：fork/exec系统调用</p>
</li>
<li><p>该进程默认打开的stdin 、stdout 、stderr 连接在终端上</p>
</li>
<li><p>运行的命令从键盘读取数据并且把输出和错误消息写到屏幕上</p>
</li>
<li><p>通过重定向，可以从指定文件读取数据，或将数据输出到指定文件</p>
</li>
<li><p>重定向I/O的功能是由shell本身实现的：标准流与文件的连接</p>
</li>
<li><p>程序本身并不知道数据最后流向哪里：只跟标准流打交道</p>
</li>
<li><p>通过命令：cmd &gt; file 告诉shell将 stdout 定位到文件file，于是shell就将文件描述符与指定的文件连接起来，程序的输出到file，而不是默认的屏幕</p>
</li>
</ul>
<h4 id="输入输出重定向"><a href="#输入输出重定向" class="headerlink" title="输入输出重定向"></a>输入输出重定向</h4><p>dup函数和dup2函数</p>
<ul>
<li><p>将管道和输入输出设备联系起来</p>
</li>
<li><p>输入、输出重定向到某个设备、文件</p>
</li>
<li><p>#include &lt;unistd.h&gt;</p>
</li>
<li><p>int dup(int oldfd);</p>
</li>
<li><p>int dup2(int oldfd, int newfd);</p>
</li>
<li><p>int dup3(int oldfd, int newfd, int flags);</p>
</li>
</ul>
<p>dup</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main1</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, new_fd;</span><br><span class="line">    fd = open (<span class="string">&quot;write.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    new_fd = dup (fd);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;fd = %d\nnewfd = %d\n&quot;</span>, fd, new_fd);</span><br><span class="line">    write (fd, <span class="string">&quot;hello&quot;</span>, <span class="built_in">strlen</span> (<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    close (fd);</span><br><span class="line">    write (new_fd, <span class="string">&quot;world&quot;</span>, <span class="built_in">strlen</span> (<span class="string">&quot;world&quot;</span>));</span><br><span class="line">    close (new_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> new_fd;</span><br><span class="line">    new_fd = dup (<span class="number">1</span>);</span><br><span class="line">    write (<span class="number">1</span>, <span class="string">&quot;hello&quot;</span>, <span class="built_in">strlen</span> (<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    write (new_fd, <span class="string">&quot;world\n&quot;</span>, <span class="built_in">strlen</span> (<span class="string">&quot;world\n&quot;</span>));</span><br><span class="line">    close (new_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>dup2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handler_error(msg) \</span></span><br><span class="line">    &#123; perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, new_fd;</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="string">&quot;hello world\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fd = open (<span class="string">&quot;data.log&quot;</span>, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) </span><br><span class="line">        handler_error (<span class="string">&quot;open&quot;</span>);</span><br><span class="line"></span><br><span class="line">    new_fd = dup2 (fd, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (new_fd == <span class="number">-1</span>) </span><br><span class="line">        handler_error (<span class="string">&quot;dup2&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;fd: %d\n new_fd = %d\n&quot;</span>, fd, new_fd);</span><br><span class="line">    write (<span class="number">1</span>, buf, <span class="built_in">strlen</span> (buf));</span><br><span class="line">    close (fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="SHELL管道实现的原理"><a href="#SHELL管道实现的原理" class="headerlink" title="SHELL管道实现的原理"></a>SHELL管道实现的原理</h4><p>实现原理：</p>
<ul>
<li>复制文件描述符：dup2</li>
<li>一个程序的标准输出重定向到管道中</li>
<li>而另一个程序的标准输入从管道中读取</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424110437.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (pipe (pipe_fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">        ret_from_fork = fork ();</span><br><span class="line">        <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">            dup2 (pipe_fd[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">            execlp (<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;dup.c&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            dup2 (pipe_fd[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">            close (pipe_fd[<span class="number">1</span>]);</span><br><span class="line">            execlp (<span class="string">&quot;grep&quot;</span>, <span class="string">&quot;grep&quot;</span>, <span class="string">&quot;include&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="通过管道与shell命令进行通信"><a href="#通过管道与shell命令进行通信" class="headerlink" title="通过管道与shell命令进行通信"></a>通过管道与shell命令进行通信</h3><h4 id="popen函数"><a href="#popen函数" class="headerlink" title="popen函数"></a>popen函数</h4><ul>
<li><p>FILE *popen(const char *command, const char *type);</p>
</li>
<li><p>创建一个管道，并创建一个子进程来执行shell，shell会创建一个子进程来执行command</p>
</li>
<li><p>将父子进程的输入/输出重定向到管道，建立一个单向的数据流</p>
</li>
<li><p>返回一个fp文件指针给父进程，父进程可根据fp对管道进行读写</p>
</li>
<li><p>向管道中读数据：读命令的标准输出</p>
</li>
<li><p>向管道中写数据：写入该命令的标准输入</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424152349.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424152402.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424152413.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">popen_read</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    FILE* fp;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fp = popen (<span class="string">&quot;cat popen.c&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;popen&quot;</span>);</span><br><span class="line">    fread (buf, <span class="number">1</span>, <span class="number">1024</span>, fp);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">    pclose (fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">popen_write</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    FILE* fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fp = popen (<span class="string">&quot;cat &gt; write.log&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;popen&quot;</span>);</span><br><span class="line">    fwrite (<span class="string">&quot;hello world!\n&quot;</span>, <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="string">&quot;hello world!&quot;</span>), fp);</span><br><span class="line">    pclose (fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    popen_read ();</span><br><span class="line">    popen_write ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过管道同步进程"><a href="#通过管道同步进程" class="headerlink" title="通过管道同步进程"></a>通过管道同步进程</h3><h4 id="PIPE通信应用"><a href="#PIPE通信应用" class="headerlink" title="PIPE通信应用"></a>PIPE通信应用</h4><p>通过管道同步进程</p>
<ul>
<li><p>管道自带同步互斥机制：</p>
<ul>
<li>管道的内核实现：fs/pipe.c</li>
<li>通过内核的锁、等待队列等机制实现</li>
</ul>
</li>
<li><p>Write操作可能会阻塞进程</p>
<ul>
<li>当内存缓冲区已满或被读进程锁定</li>
<li>直到所有数据被写入到管道为止</li>
</ul>
</li>
<li><p>Read操作进程可能会阻塞进程</p>
<ul>
<li><p>读进程可以休眠在等待队列，</p>
</li>
<li><p>直到所有子进程都关闭了管道的写入端描述符为止</p>
</li>
<li><p>父进程的写入端描述符也要关闭，否则父进程读管道时也会被阻塞</p>
</li>
<li><p>只有当所有的写端描述符都已关闭，且管道中的数据都被读出，对读端描述符调用read函数才会返回0（即读到EOF标志）</p>
</li>
<li><p>所有的读取端和写入端都关闭后，管道才能被销毁</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handler_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> buf;</span><br><span class="line"></span><br><span class="line">    setbuf (<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;parent process(%d) run ... \n&quot;</span>, getpid() );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe (pipe_fd) == <span class="number">-1</span>) </span><br><span class="line">        handler_error (<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">        ret_from_fork = fork ();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) </span><br><span class="line">            handler_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (close (pipe_fd[<span class="number">0</span>]) == <span class="number">-1</span>)</span><br><span class="line">                handler_error (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">            sleep (i * i);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;child process(%d) closing pipe\n&quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">if</span> (close (pipe_fd[<span class="number">1</span>]) == <span class="number">1</span>) </span><br><span class="line">                handler_error (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">            _exit (EXIT_SUCCESS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (close (pipe_fd[<span class="number">1</span>]) == <span class="number">-1</span>) </span><br><span class="line">        handler_error (<span class="string">&quot;close&quot;</span>);    </span><br><span class="line">    <span class="keyword">if</span> (read (pipe_fd[<span class="number">0</span>], &amp;buf, <span class="number">1</span>) != <span class="number">0</span>) <span class="comment">// 父进程阻塞在这里</span></span><br><span class="line">        perror (<span class="string">&quot;parent read cant&#x27;t get EOF&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;parent process(%d) exit!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424163816.png"></p>
<h4 id="管道缓冲区的设置"><a href="#管道缓冲区的设置" class="headerlink" title="管道缓冲区的设置"></a>管道缓冲区的设置</h4><p>管道缓冲区</p>
<ul>
<li><p>管道对应的内存缓冲区大小</p>
<ul>
<li>PIPE_BUF的容量是有限的：默认是65536字节</li>
<li>在不同OS下的PIPE_BUF大小设置不同：在 limits.h 头文件中定义</li>
<li>写入管道的数据超过PIPE_BUF大小，内核会分割几块传输</li>
<li>最大值 <code>/proc/sys/fs/pipe-maxsize</code></li>
<li>查看打开的管道文件：$ <code>cat /proc/PID/fd</code></li>
</ul>
</li>
<li><p>设置缓冲区大小</p>
<ul>
<li>特权用户：可以修改上限值</li>
<li>设置缓冲区大小：<code>fcntl (fd, F_SETPIPE_SZ, size)</code></li>
</ul>
</li>
</ul>
<p>查看上述程序父进程打开的文件描述符，进入到 /proc/xxx 目录下</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424170325.png"></p>
<p>更改上述程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handler_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> buf;</span><br><span class="line"></span><br><span class="line">    setbuf (<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;parent process(%d) run ... \n&quot;</span>, getpid() );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe (pipe_fd) == <span class="number">-1</span>) </span><br><span class="line">        handler_error (<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">        ret_from_fork = fork ();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) </span><br><span class="line">            handler_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (close (pipe_fd[<span class="number">0</span>]) == <span class="number">-1</span>)</span><br><span class="line">                handler_error (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">            sleep (i * i);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;child process(%d) closing pipe\n&quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (close (pipe_fd[<span class="number">1</span>]) == <span class="number">1</span>) </span><br><span class="line">                handler_error (<span class="string">&quot;close&quot;</span>);</span><br><span class="line">            _exit (EXIT_SUCCESS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (close (pipe_fd[<span class="number">1</span>]) == <span class="number">-1</span>) </span><br><span class="line">        handler_error (<span class="string">&quot;close&quot;</span>);    </span><br><span class="line">    <span class="keyword">if</span> (read (pipe_fd[<span class="number">0</span>], &amp;buf, <span class="number">1</span>) != <span class="number">0</span>) <span class="comment">// 父进程阻塞在这里</span></span><br><span class="line">        perror (<span class="string">&quot;parent read cant&#x27;t get EOF&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;parent process(%d) exit!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424171047.png"></p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>PIPE通信特点</p>
<ul>
<li><p>无名管道(匿名管道)是一个字节流</p>
</li>
<li><p>可通过文件I/O接口读写、但无法lseek</p>
</li>
<li><p>单向通信：一端用于写入、一端用于读出</p>
</li>
<li><p>通信简单、性能单一、只能在近亲进程间通信</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424171248.png"></p>
<h2 id="命名管道：FIFO-named-pipe"><a href="#命名管道：FIFO-named-pipe" class="headerlink" title="命名管道：FIFO(named pipe)"></a>命名管道：FIFO(named pipe)</h2><h3 id="FIFO通信特点"><a href="#FIFO通信特点" class="headerlink" title="FIFO通信特点"></a>FIFO通信特点</h3><p>FIFO文件，有文件名字</p>
<ul>
<li><p>可以像普通文件一样存储在文件系统之中</p>
</li>
<li><p>可以像普通文件一样使用open/read/write读写</p>
</li>
<li><p>跟PIPE一样，属于流式文件，不能使用lseek定位</p>
</li>
</ul>
<p>具有写入原子性、可同时对FIFO进行写操作，如日志系统/var/log</p>
<p>First In First Out：最先被写入FIFO的数据，最先被读出来</p>
<ul>
<li><p>默认阻塞读、阻塞写的特性，可以在open的时候进行设置</p>
</li>
<li><p><font color='9900CC'>当一个进程打开FIFO的一端时，如果另一端没有打开，该进程会被阻塞</font></p>
</li>
</ul>
<blockquote>
<p>来自GPT-4的回答：</p>
<p>命名管道（Named Pipe）又称为 FIFO（First In First Out，先进先出）文件，是一种特殊类型的文件，用于在不相关的进程之间进行通信。命名管道主要存储在内存中，但它们在文件系统中具有表示，即一个特殊的文件节点。这意味着命名管道可以像常规文件一样被创建、删除和引用。</p>
<p>通常情况下，当两个进程需要进行通信时，它们会创建一个命名管道。一个进程将以写模式打开管道，另一个进程将以读模式打开管道。写入管道的数据将被存储在内存中的缓冲区里，然后被读取进程接收。当管道不再需要时，它将被删除，从而释放内存。</p>
<p>这里需要注意的是，<font color='9900CC'>虽然命名管道在文件系统中具有表示，但实际上数据是存储在内存中的，而不是磁盘上</font>。因此，命名管道在性能方面通常优于将数据写入磁盘的其他通信方式。</p>
</blockquote>
<h3 id="FIFO编程实例"><a href="#FIFO编程实例" class="headerlink" title="FIFO编程实例"></a>FIFO编程实例</h3><h4 id="系统调用接口-1"><a href="#系统调用接口-1" class="headerlink" title="系统调用接口"></a>系统调用接口</h4><ul>
<li><p>shell命令：mkfifo pathname</p>
</li>
<li><p>函数接口：int mkfifo (const char *pathname, mode_t mode);</p>
</li>
<li><p>函数功能：创建一个FIFO有名管道</p>
</li>
<li><p>函数参数：</p>
<ul>
<li><p>pathname：FIFO管道文件名</p>
</li>
<li><p>mode：读写权限</p>
</li>
</ul>
</li>
</ul>
<h4 id="进程通信示例"><a href="#进程通信示例" class="headerlink" title="进程通信示例"></a>进程通信示例</h4><ul>
<li>亲缘关系进程之间通信</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    mkfifo (<span class="string">&quot;my_fifo&quot;</span>, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    <span class="keyword">int</span> fifo_fd;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        fifo_fd = open (<span class="string">&quot;my_fifo&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;child process(%d) input msg: &quot;</span>, getpid ());</span><br><span class="line">        fgets (buf, <span class="number">100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        <span class="keyword">int</span> write_len = write (fifo_fd, buf, <span class="built_in">strlen</span> (buf));</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;%d bytes hace been sent\n&quot;</span>, write_len);</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">        fifo_fd = open (<span class="string">&quot;my_fifo&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        read (fifo_fd, buf, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;parent process(%d) read msg from FIFO: %s\n&quot;</span>, getpid (), buf);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424205434.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424205450.png"></p>
<ul>
<li>非亲缘关系进程之间的通信</li>
</ul>
<p>write_fifo.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    mkfifo (<span class="string">&quot;my_fifo&quot;</span>, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">int</span> fifo_fd = open (<span class="string">&quot;my_fifo&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    fgets (buf, <span class="number">100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">int</span> write_len = write (fifo_fd, buf, <span class="built_in">strlen</span> (buf));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%d bytes have been sended to FIFO.\n&quot;</span>, write_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>read_fifo.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    mkfifo (<span class="string">&quot;my_fifo&quot;</span>, <span class="number">0644</span>); <span class="comment">// 如果存在则不创建</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fifo_fd = open (<span class="string">&quot;my_fifo&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    read (fifo_fd, buf, <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;Read from FIFO: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424211152.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230424211137.png"></p>
<h3 id="FIFO内核实现"><a href="#FIFO内核实现" class="headerlink" title="FIFO内核实现"></a>FIFO内核实现</h3><p>FIFO与PIPE的区别和联系</p>
<ul>
<li><p>联系</p>
<ul>
<li>在内核中的实现：fs/pipe.c，本质上都是内存中的一块page cache</li>
<li>通过向内核注册pipefs来实现，可以通过I/O接口read、write等访问</li>
</ul>
</li>
<li><p>区别</p>
<ul>
<li>匿名管道pipe通过自己的两端读写描述符进行读写操作</li>
<li>命名管道有自己的文件名，可以通过文件名直接进行读写操作</li>
<li>匿名管道pipe一般用于亲缘进程间通信</li>
<li>命名管道FIFO可用于非亲缘进程间通信</li>
</ul>
</li>
</ul>
<h2 id="FIFO应用：LOG日志系统的实现"><a href="#FIFO应用：LOG日志系统的实现" class="headerlink" title="FIFO应用：LOG日志系统的实现"></a>FIFO应用：LOG日志系统的实现</h2><h3 id="Log日志系统"><a href="#Log日志系统" class="headerlink" title="Log日志系统"></a>Log日志系统</h3><ul>
<li><p>各个进程往FIFO管道写入数据</p>
</li>
<li><p>守护进程使用FIFO接收各个进程的输出日志信息</p>
</li>
<li><p>并将FIFO中的数据写到对应的日志文件中</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425104513.png"></p>
<p>process.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_log_server&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    mkfifo (FIFO_SERVER, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">int</span> fifo_fd;</span><br><span class="line"></span><br><span class="line">    fifo_fd = open (FIFO_SERVER, O_WRONLY);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">sprintf</span> (buf, <span class="string">&quot;process %d: log ---\n&quot;</span>, getpid ());</span><br><span class="line">        write (fifo_fd, buf, <span class="built_in">strlen</span> (buf));</span><br><span class="line">        sleep (<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mylog-daemon.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_log_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_PATHNAME <span class="meta-string">&quot;/var/log/process.log&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    mkfifo (FIFO_SERVER, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    <span class="keyword">char</span> public_buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> fifo_fd;</span><br><span class="line"></span><br><span class="line">    fifo_fd = open (FIFO_SERVER, O_RDONLY);</span><br><span class="line">    <span class="built_in">memset</span> (public_buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    fd = open (LOG_PATHNAME, O_WRONLY | O_CREAT | O_APPEND);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> read_len;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        read_len = read (fifo_fd, public_buf, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">if</span> (read_len == <span class="number">-1</span>) &#123; </span><br><span class="line">            handle_error (<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (read_len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;%s\n&quot;</span>, public_buf);</span><br><span class="line">            write (fd, public_buf, <span class="built_in">strlen</span> (public_buf));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sleep (<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close (fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="FIFO应用：服务端与客户端通信"><a href="#FIFO应用：服务端与客户端通信" class="headerlink" title="FIFO应用：服务端与客户端通信"></a>FIFO应用：服务端与客户端通信</h2><p>服务器/客户端应用程序</p>
<h3 id="服务端、客户端进程通过FIFO实现双向通信"><a href="#服务端、客户端进程通过FIFO实现双向通信" class="headerlink" title="服务端、客户端进程通过FIFO实现双向通信"></a>服务端、客户端进程通过FIFO实现双向通信</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425192856.png"></p>
<p>client </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_CLIENT <span class="meta-string">&quot;fifo_client&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fd_fifo_write;</span><br><span class="line">        fd_fifo_write = open (FIFO_SERVER, O_WRONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">            write (fd_fifo_write, buf, <span class="built_in">strlen</span> (buf) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> fd_fifo_read;</span><br><span class="line">        fd_fifo_read = open (FIFO_CLIENT, O_RDONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">if</span> (read (fd_fifo_read, buf, <span class="number">100</span>) &gt; <span class="number">0</span>) </span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;server: %s\n&quot;</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_CLIENT <span class="meta-string">&quot;fifo_client&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    mkfifo (FIFO_SERVER, <span class="number">0644</span>);</span><br><span class="line">    mkfifo (FIFO_CLIENT, <span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fd_fifo_write;</span><br><span class="line">        fd_fifo_write = open (FIFO_CLIENT, O_WRONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">            write (fd_fifo_write, buf, <span class="built_in">strlen</span> (buf) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> fd_fifo_read;</span><br><span class="line">        fd_fifo_read = open (FIFO_SERVER, O_RDONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">if</span> (read (fd_fifo_read, buf, <span class="number">100</span>) &gt; <span class="number">0</span>) </span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;client: %s\n&quot;</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="2个客户端进程通过服务端实现双向通信"><a href="#2个客户端进程通过服务端实现双向通信" class="headerlink" title="2个客户端进程通过服务端实现双向通信"></a>2个客户端进程通过服务端实现双向通信</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425192907.png"></p>
<p>server</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_CLIENT_1 <span class="meta-string">&quot;fifo_client1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_CLIENT_2 <span class="meta-string">&quot;fifo_client2&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    mkfifo (FIFO_SERVER, <span class="number">0644</span>);</span><br><span class="line">    mkfifo (FIFO_CLIENT_1, <span class="number">0644</span>);</span><br><span class="line">    mkfifo (FIFO_CLIENT_2, <span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    <span class="keyword">int</span> buf_ready = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> public_buf[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fifo_fd_read;</span><br><span class="line">    fifo_fd_read = open (FIFO_SERVER, O_RDONLY);</span><br><span class="line">    <span class="built_in">memset</span> (public_buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fifo_fd_write1;</span><br><span class="line">    <span class="keyword">int</span> fifo_fd_write2;</span><br><span class="line">    fifo_fd_write1 = open (FIFO_CLIENT_1, O_WRONLY);</span><br><span class="line">    fifo_fd_write2 = open (FIFO_CLIENT_2, O_WRONLY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> read_len;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        read_len = read (fifo_fd_read, public_buf, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">if</span> (read_len == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (read_len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;%s\n&quot;</span>, public_buf);</span><br><span class="line">            <span class="keyword">if</span> (public_buf[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">                write (fifo_fd_write1, public_buf + <span class="number">1</span>, <span class="built_in">strlen</span> (public_buf + <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (public_buf[<span class="number">0</span>] == <span class="string">&#x27;2&#x27;</span>) </span><br><span class="line">                write (fifo_fd_write2, public_buf + <span class="number">1</span>, <span class="built_in">strlen</span> (public_buf + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_CLIENT_1 <span class="meta-string">&quot;fifo_client1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    mkfifo (FIFO_SERVER, <span class="number">0644</span>);</span><br><span class="line">    mkfifo (FIFO_CLIENT_1, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line"></span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fifo_fd_write;</span><br><span class="line">        fifo_fd_write = open (FIFO_SERVER, O_WRONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            buf[<span class="number">0</span>] = <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">            <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, buf + <span class="number">1</span>);</span><br><span class="line">            write (fifo_fd_write, buf, <span class="built_in">strlen</span> (buf) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> fifo_fd_read;</span><br><span class="line">        fifo_fd_read = open (FIFO_CLIENT_1, O_RDONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">if</span> (read (fifo_fd_read, buf, <span class="number">100</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;client2: %s\n&quot;</span>, buf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">&quot;fifo_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_CLIENT_2 <span class="meta-string">&quot;fifo_client2&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    mkfifo (FIFO_SERVER, <span class="number">0644</span>);</span><br><span class="line">    mkfifo (FIFO_CLIENT_2, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line"></span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fifo_fd_write;</span><br><span class="line">        fifo_fd_write = open (FIFO_SERVER, O_WRONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            buf[<span class="number">0</span>] = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">            <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, buf + <span class="number">1</span>);</span><br><span class="line">            write (fifo_fd_write, buf, <span class="built_in">strlen</span> (buf) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _exit (EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> fifo_fd_read;</span><br><span class="line">        fifo_fd_read = open (FIFO_CLIENT_2, O_RDONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">if</span> (read (fifo_fd_read, buf, <span class="number">100</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;client1: %s\n&quot;</span>, buf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>



<h3 id="不同客户端进程通过服务端实现通信"><a href="#不同客户端进程通过服务端实现通信" class="headerlink" title="不同客户端进程通过服务端实现通信"></a>不同客户端进程通过服务端实现通信</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230425192921.png"></p>
<h2 id="IPC对象和IPC-key"><a href="#IPC对象和IPC-key" class="headerlink" title="IPC对象和IPC key"></a>IPC对象和IPC key</h2><h3 id="进程间通信对象-IPC"><a href="#进程间通信对象-IPC" class="headerlink" title="进程间通信对象: IPC"></a>进程间通信对象: IPC</h3><p>什么是 IPC 对象？</p>
<ul>
<li>IPC: Inter-process communication</li>
<li>管道通信：FIFO、PIPE、流式数据</li>
<li>消息队列：message queue</li>
<li>信号量：semaphore</li>
<li>共享内存：share memory</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426152934.png"></p>
<h3 id="IPC分类"><a href="#IPC分类" class="headerlink" title="IPC分类"></a>IPC分类</h3><ul>
<li>System V IPC<ul>
<li>消息队列： system V message queue</li>
<li>信号量：system V semaphore</li>
<li>共享内存：system V share memory</li>
</ul>
</li>
</ul>
<ul>
<li>POSIX IPC<ul>
<li>消息队列：POSIX message queue</li>
<li>信号量：POSIX semaphore</li>
<li>共享内存：POSIX share memory</li>
</ul>
</li>
</ul>
<h3 id="IPC对象"><a href="#IPC对象" class="headerlink" title="IPC对象"></a>IPC对象</h3><ul>
<li>不同进程通过IPC对象通信，IPC对象存储在内核中，全局可见</li>
<li>每个IPC对象在内核中有自己的数据结构，定义在各自头文件中</li>
<li>对IPC对象的引用<ul>
<li>普通文件：文件名 – 文件描述符</li>
<li>IPC对象：IPC key – IPC标识符</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426162205.png"></p>
<h3 id="IPC标识符和IPC-key"><a href="#IPC标识符和IPC-key" class="headerlink" title="IPC标识符和IPC key"></a>IPC标识符和IPC key</h3><p>对IPC对象的标识</p>
<ul>
<li><p>类似于文件描述符，可通过一个IPC标识符来引用一个IPC对象</p>
</li>
<li><p>IPC标识符类似于文件描述符，是一个整数，是IPC对象的内部名</p>
</li>
<li><p>当多个进程引用同一个IPC对象时，需要一个统一的外部命名。</p>
</li>
<li><p>类似于文件名，每个IPC对象与一个键(key)相关联</p>
</li>
<li><p>IPC key，是IPC对象的外部名，是一个独一无二的整数，确保唯一性</p>
<ul>
<li>该键数据类型为key_t，在sys/types.h中被定义为长整型。</li>
<li>普通文件：通过open打开一个文件名，获得文件描述符</li>
<li>IPC对象：通过get可根据给定的key去创建一个IPC对象，并返回IPC标识符</li>
</ul>
</li>
</ul>
<h3 id="IPC-key"><a href="#IPC-key" class="headerlink" title="IPC key"></a>IPC key</h3><p>创建IPC key的三种方法</p>
<ul>
<li><p>随机选取一个整数值作为key值。</p>
<ul>
<li>所有整数放到一个头文件中，使用IPC对象的程序包含这个头文件即可。</li>
</ul>
</li>
<li><p>在get系统调用中将IPC_PRIVATE常量作为key值。</p>
<ul>
<li>每个调用都会创建一个全新的IPC对象</li>
<li>从而确保每个对象都拥有一个唯一的key</li>
</ul>
</li>
<li><p>使用ftok函数生成一个(接近唯一)key</p>
</li>
</ul>
<h3 id="IPC对象的引用"><a href="#IPC对象的引用" class="headerlink" title="IPC对象的引用"></a>IPC对象的引用</h3><p>使用基本流程</p>
<ul>
<li>通过 get 系统调用创建或打开一个 IPC 对象<ul>
<li>给定一个整数 key , get系统调用会返回一个整数标识符，即 IPC 标识符</li>
</ul>
</li>
<li>通过这个标识符来引用IPC对象、进行各种操作</li>
<li>通过 ctl 系统调用获取或设置IPC对象的属性，或者删除一个对象</li>
<li>IPC对象具有的权限定义在 <code>/Linux/ipc.h</code> 文件中</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426171025.png"></p>
<h3 id="各种IPC对象的标识符和句柄"><a href="#各种IPC对象的标识符和句柄" class="headerlink" title="各种IPC对象的标识符和句柄"></a>各种IPC对象的标识符和句柄</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426173807.png"></p>
<h2 id="System-V-消息队列"><a href="#System-V-消息队列" class="headerlink" title="System V 消息队列"></a>System V 消息队列</h2><h3 id="System-V-消息队列-1"><a href="#System-V-消息队列-1" class="headerlink" title="System V 消息队列"></a>System V 消息队列</h3><p>通信方法</p>
<ul>
<li><p>支持不同进程之间以消息(message)的形式交换数据。</p>
</li>
<li><p>发送者</p>
<ul>
<li>获取消息队列的ID(IPC标识符)</li>
<li>将数据放入一个<strong>带有标识</strong>的消息结构体，发送到消息队列</li>
</ul>
</li>
<li><p>接收者</p>
<ul>
<li>获取消息队列的ID</li>
<li>将<strong>指定标识</strong>的消息从消息队列中读出，然后进一步后续处理</li>
</ul>
</li>
</ul>
<h3 id="编程接口"><a href="#编程接口" class="headerlink" title="编程接口"></a>编程接口</h3><ul>
<li><p>key_t ftok (const char *pathname, int proj_id); </p>
<ul>
<li>用来生成一个key，类似于文件名</li>
</ul>
</li>
<li><p>int msgget(key_t key, int msgflg); </p>
<ul>
<li><p>创建或打开一个消息队列</p>
</li>
<li><p>首先从既有消息队列中搜索与指定key对应的队列，返回该对象的标识符</p>
</li>
<li><p>若没找到，msgflg指定了IPC_CREAT，则创建一个队列，并返回IPC标识符</p>
</li>
</ul>
</li>
<li><p>int msgsnd (int msqid, const void *msgp, size_t msgsz, int msgflg);</p>
<ul>
<li>发送消息到消息队列</li>
</ul>
</li>
<li><p>ssize_t msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp, int msgflg);</p>
<ul>
<li>从消息队列中接收信息</li>
</ul>
</li>
<li><p>int msgctl(int msqid, int cmd, struct msqid_ds *buf);</p>
<ul>
<li><p>IPC_STAT：获取消息队列的属性信息</p>
</li>
<li><p>IPC_SET：设置消息队列的属性</p>
</li>
<li><p>IPC_RMID：删除消息队列</p>
</li>
</ul>
</li>
</ul>
<p>通过<code>ipcs</code>命令可以查看内核中创建的消息队列在这里显示出来，以及共享内存和信号量</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426202918.png"></p>
<h3 id="编程实例-1"><a href="#编程实例-1" class="headerlink" title="编程实例"></a>编程实例</h3><p>发送消息: msg_snd.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE1 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE2 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">80</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = <span class="number">12345</span>;</span><br><span class="line">    <span class="keyword">int</span> msg_id = msgget (key, IPC_CREAT | <span class="number">0666</span>); <span class="comment">// IPC标识符</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">msg</span>;</span> </span><br><span class="line">    <span class="built_in">memset</span> (&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span> (msg));</span><br><span class="line">    msg.mtype = MSG_TYPE2;</span><br><span class="line">    <span class="built_in">strncpy</span> (msg.mtext, <span class="string">&quot;hello world\n&quot;</span>, <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgsnd (msg_id, (<span class="keyword">void</span> *)&amp;msg, <span class="built_in">strlen</span> (msg.mtext), <span class="number">0</span>) == <span class="number">-1</span> ) &#123;</span><br><span class="line">        perror (<span class="string">&quot;msgsnd&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>观察到内核中就有了一个消息队列</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230426205031.png"></p>
<p>通过 msg_rcv.c 接送消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE1 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE2 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">80</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = <span class="number">12345</span>;</span><br><span class="line">    <span class="keyword">int</span> msg_id = msgget (key, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="built_in">memset</span> (&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span> (msg));</span><br><span class="line">    <span class="keyword">if</span> (msgrcv (msg_id, (<span class="keyword">void</span>*)&amp;msg, <span class="keyword">sizeof</span>(msg.mtext), MSG_TYPE2, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;%s&quot;</span>, msg.mtext);</span><br><span class="line">    msgctl (msg_id, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Linux中的消息队列"><a href="#Linux中的消息队列" class="headerlink" title="Linux中的消息队列"></a>Linux中的消息队列</h3><p>内核实现：消息队列模型</p>
<ul>
<li><p>相关数据结构：/usr/include/linux/msg.h、/ipc/msg.c</p>
</li>
<li><p>msqid_ds：标识整个消息队列的基本情况：消息队列权限、所有者、操作权限，和2个指针，分别指向消息队列中的第一和最后一个消息</p>
</li>
<li><p>msg：整个消息队列的主体，一个消息队列有若干个消息，每个消息数据结构的基本信息包括消息类型、消息大小、消息内容指针和下一个消息数据结构位置</p>
</li>
<li><p>消息队列是消息的链表，存储在内核中，由消息队列标识符标识。</p>
</li>
<li><p>IPC标识符：消息队列的ID</p>
</li>
</ul>
<h2 id="消息队列的应用：点对点通信"><a href="#消息队列的应用：点对点通信" class="headerlink" title="消息队列的应用：点对点通信"></a>消息队列的应用：点对点通信</h2><p>不同进程之间的点对点通信</p>
<ul>
<li>不同进程之间通过各自指定的<font color='9900CC'>消息类型</font>进行点对点通信</li>
<li>不需要经过服务端“中转”分发，由内核充当“代理人”角色</li>
<li>不同的进程可以操作同一个消息队列</li>
<li>各自发送、接收自定义类型的消息，互不影响</li>
</ul>
<p>client1.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123; perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE1 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE2 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">80</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = <span class="number">511</span>;</span><br><span class="line">    <span class="keyword">int</span> msg_id = msgget (key, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">msg1</span>, <span class="title">msg2</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            gets (msg1.mtext);</span><br><span class="line">            msg1.mtype = MSG_TYPE1;</span><br><span class="line">            msgsnd (msg_id, &amp;msg1, <span class="number">80</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (&amp;msg2, <span class="number">0</span>, <span class="keyword">sizeof</span> (msg2));</span><br><span class="line">            <span class="keyword">if</span> (msgrcv (msg_id, (<span class="keyword">void</span> *)&amp;msg2, <span class="keyword">sizeof</span> (msg2.mtext), MSG_TYPE2, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                handle_error (<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;client2: %s\n&quot;</span>, msg2.mtext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    msgctl (msg_id, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>client2.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123; perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE1 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TYPE2 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">80</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = <span class="number">511</span>;</span><br><span class="line">    <span class="keyword">int</span> msg_id = msgget (key, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">msg1</span>, <span class="title">msg2</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            gets (msg2.mtext);</span><br><span class="line">            msg2.mtype = MSG_TYPE2;</span><br><span class="line">            msgsnd (msg_id, &amp;msg2, <span class="number">80</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (&amp;msg1, <span class="number">0</span>, <span class="keyword">sizeof</span> (msg1));</span><br><span class="line">            <span class="keyword">if</span> (msgrcv (msg_id, (<span class="keyword">void</span> *)&amp;msg1, <span class="keyword">sizeof</span> (msg1.mtext), MSG_TYPE1, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                handle_error (<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;client1: %s\n&quot;</span>, msg1.mtext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    msgctl (msg_id, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="消息队列的应用：多人聊天室"><a href="#消息队列的应用：多人聊天室" class="headerlink" title="消息队列的应用：多人聊天室"></a>消息队列的应用：多人聊天室</h2><h3 id="多用户本地聊天室实例"><a href="#多用户本地聊天室实例" class="headerlink" title="多用户本地聊天室实例"></a>多用户本地聊天室实例</h3><ul>
<li>支持多人同时聊天(3人以上、可以修改程序设置)</li>
<li>每个用户端进程以ID登录，ID作为服务端要发送的消息类型</li>
<li>服务端实现消息的广播转发功能</li>
</ul>
<p>server.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TO_SERVER_MSGTYPE 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_NUMBER 3</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">int</span> client_id;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">80</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = <span class="number">512</span>;</span><br><span class="line">    <span class="keyword">int</span> msg_id = msgget (key, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span> (&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span> (msg));</span><br><span class="line">        <span class="keyword">if</span> (msgrcv (msg_id, (<span class="keyword">void</span> *)&amp;msg, <span class="keyword">sizeof</span> (msg.mtext), TO_SERVER_MSGTYPE, <span class="number">0</span>) == <span class="number">-1</span> ) &#123;</span><br><span class="line">            perror (<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= CLIENT_NUMBER; i ++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == msg.client_id) <span class="keyword">continue</span>;</span><br><span class="line">                msg.mtype = i;</span><br><span class="line">                msgsnd (msg_id, &amp;msg, <span class="number">80</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;server: %s\n&quot;</span>, msg.mtext);</span><br><span class="line">    &#125;</span><br><span class="line">    msgctl (msg_id, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123; perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TO_SERVER_MSGTYPE 1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">int</span> client_id;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">80</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = <span class="number">512</span>;</span><br><span class="line">    <span class="keyword">int</span> msg_id = msgget (key, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">msg_snd</span>, <span class="title">msg_rcv</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;input guest ID:&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> client_id;</span><br><span class="line">    <span class="built_in">scanf</span> (<span class="string">&quot;%d&quot;</span>, &amp;client_id);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;client_id: %d\n&quot;</span>, client_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            gets (msg_snd.mtext);</span><br><span class="line">            msg_snd.mtype = TO_SERVER_MSGTYPE;</span><br><span class="line">            msg_snd.client_id = client_id;</span><br><span class="line">            msgsnd (msg_id, &amp;msg_snd, <span class="number">80</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span> (&amp;msg_rcv, <span class="number">0</span>, <span class="keyword">sizeof</span> (msg_rcv));</span><br><span class="line">            <span class="keyword">if</span> (msgrcv (msg_id, (<span class="keyword">void</span> *)&amp;msg_rcv, <span class="keyword">sizeof</span> (msg_rcv.mtext), client_id, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">                handle_error (<span class="string">&quot;msg_rcv&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;client %d: %s\n&quot;</span>, msg_rcv.client_id, msg_rcv.mtext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><h4 id="消息队列与FIFO比较"><a href="#消息队列与FIFO比较" class="headerlink" title="消息队列与FIFO比较"></a>消息队列与FIFO比较</h4><ul>
<li><p>引用方式</p>
<ul>
<li>用来标识消息队列的是一个key，而不是普通文件所用的pathname</li>
<li>用来引用消息队列的句柄是一个由msgget()调用返回的标识符。</li>
<li>这些标识符类似于普通文件I/O通过open返回的文件描述符。</li>
</ul>
</li>
<li><p>传输的数据</p>
<ul>
<li>FIFO发送的数据是流式数据、raw数据</li>
<li>通过消息队列进行的通信是面向消息的</li>
<li>除了包含数据之外，每条消息还有一个用整数表示的类型。</li>
</ul>
</li>
<li><p>消息队列比FIFO优越的地方</p>
<ul>
<li>消息队列双方通过消息通信，无需花费精力从字节流中解析出完整信息</li>
<li>每条消息都有type字段，read进程可通过消息类型选择自己感兴趣的消息</li>
</ul>
</li>
</ul>
<h4 id="消息队列的优点"><a href="#消息队列的优点" class="headerlink" title="消息队列的优点"></a>消息队列的优点</h4><ul>
<li><p>降低系统耦合：</p>
<ul>
<li>生产者-消费者模式，自助餐模式，多个读写进程通过容器建立联系、互不影响，实现解耦</li>
<li>消息是跟平台和语言无关的。</li>
</ul>
</li>
<li><p>提速系统性能：</p>
<ul>
<li>非核心流程异步化，非阻塞模式节省时间，不需要双方同时在线</li>
</ul>
</li>
<li><p>广播：</p>
<ul>
<li>一个消息可以发送给多个进程，只需要发送到队列就可以了</li>
</ul>
</li>
<li><p>削峰：</p>
<ul>
<li>生产者-消费者的负载平衡、秒杀活动</li>
</ul>
</li>
</ul>
<h4 id="消息队列的缺陷"><a href="#消息队列的缺陷" class="headerlink" title="消息队列的缺陷"></a>消息队列的缺陷</h4><ul>
<li><p>效率低：“代理人”通信机制</p>
</li>
<li><p>陷入内核：为使用者分配内存、检查边界、设置阻塞、权限监控</p>
</li>
<li><p>消息队列的的总数、消息的大小、单个队列的容量是有限制的</p>
<ul>
<li><p>注：Linux没有限制</p>
</li>
<li><p>MSGMNI：系统中所能创建的消息队列标识符</p>
</li>
<li><p>MSGMAX：单条消息中最多可写入的字节数</p>
</li>
<li><p>MSGMNB：一个消息队列中一次最多保存的字节数（mtext）</p>
</li>
<li><p>MSGTQL：系统中所有消息队列所能存放的消息总数</p>
</li>
<li><p>MSGPOOL：消息队列中用于存放数据的缓冲区的大小</p>
</li>
</ul>
</li>
<li><p>使用标识符而不是文件描述符来引用，使用键而不是文件名来标识消息队列，使用复杂</p>
</li>
<li><p>消息队列是无连接的，内核不会像对待管道、FIFO、socket那样维护引用队列的进程数</p>
</li>
</ul>
<h2 id="system-V-共享内存"><a href="#system-V-共享内存" class="headerlink" title="system V 共享内存"></a>system V 共享内存</h2><h3 id="通信原理-1"><a href="#通信原理-1" class="headerlink" title="通信原理"></a>通信原理</h3><ul>
<li>多个进程共享物理内存的同一块区域（通常称之为段：segment）</li>
<li>抛弃了内核 “代理人” 角色，让两个进程直接通过一块内存通信</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429164126.png"></p>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li>减少了内存拷贝（从用户拷贝到内核、从内核拷贝到用户空间）</li>
<li>减少了2次系统调用，提高了系统性能</li>
</ul>
<h3 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h3><ul>
<li>获取共享内存对象的ID</li>
<li>将共享内存映射到本进程虚拟地址空间的某个区域</li>
<li>不同进程对这块共享内存进行读写、传输数据</li>
<li>当进程不再使用这块共享内存时，解除映射关系</li>
<li>当没有进程再需要这块共享内存时，删除它 </li>
</ul>
<h3 id="相关API"><a href="#相关API" class="headerlink" title="相关API"></a>相关API</h3><ul>
<li><p>获取共享内存对象的ID： int shmget(key_t key, size_t size, int shmflg);</p>
</li>
<li><p>映射共享内存： void *shmat(int shmid, const void *shmaddr, int shmflg);</p>
</li>
<li><p>解除内存映射：int shmdt(const void *shmaddr);</p>
</li>
<li><p>设置内存对象：int shmctl(int shmid, int cmd, struct shmid_ds *buf);</p>
</li>
<li><p>查看IPC对象信息：$ ipcs -m</p>
</li>
</ul>
<h4 id="获取共享内存对象的ID"><a href="#获取共享内存对象的ID" class="headerlink" title="获取共享内存对象的ID"></a>获取共享内存对象的ID</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165517.png"></p>
<h4 id="attach共享内存"><a href="#attach共享内存" class="headerlink" title="attach共享内存"></a>attach共享内存</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165545.png"></p>
<h4 id="detach共享内存"><a href="#detach共享内存" class="headerlink" title="detach共享内存"></a>detach共享内存</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165714.png"></p>
<h4 id="设置共享内存的属性"><a href="#设置共享内存的属性" class="headerlink" title="设置共享内存的属性"></a>设置共享内存的属性</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165801.png"></p>
<h3 id="编程实例-2"><a href="#编程实例-2" class="headerlink" title="编程实例"></a>编程实例</h3><p>shm_read.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">514</span>);</span><br><span class="line">    <span class="keyword">int</span> shm_id = shmget (key, <span class="number">4096</span>, <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *shm_p = shmat (shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;from SHM: %s\n&quot;</span>, shm_p);</span><br><span class="line"></span><br><span class="line">    shmdt (shm_p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>shm_write.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">514</span>);</span><br><span class="line">    <span class="keyword">int</span> shm_id;</span><br><span class="line">    shm_id = shmget (key, <span class="number">4096</span>, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;========== shmid = %d ===========\n&quot;</span>, shm_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* shm_p = shmat (shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span> (shm_p, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line">    fgets (shm_p, <span class="number">4096</span>, <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">    sleep (<span class="number">30</span>);</span><br><span class="line">    shmctl (shm_id, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="共享内存的通信限制"><a href="#共享内存的通信限制" class="headerlink" title="共享内存的通信限制"></a>共享内存的通信限制</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165813.png"></p>
<h3 id="共享内存通信特点"><a href="#共享内存通信特点" class="headerlink" title="共享内存通信特点"></a>共享内存通信特点</h3><ul>
<li><p>共享内存抛弃了“内核代理人”角色，提升了系统性能</p>
</li>
<li><p>需要进程本身维护共享内存的各种问题：同步、互斥…</p>
</li>
<li><p>一般需要信号量、互斥锁、文件锁等配合使用，在各个进程之间在高效通信的同时，防止发生数据的践踏、破坏。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230429165856.png"></p>
<h3 id="内存映射mmap和共享内存shmat之间有什么关系？"><a href="#内存映射mmap和共享内存shmat之间有什么关系？" class="headerlink" title="内存映射mmap和共享内存shmat之间有什么关系？"></a>内存映射mmap和共享内存shmat之间有什么关系？</h3><ul>
<li>内存映射mmap可应用与IPC及其他很多方面</li>
</ul>
<h2 id="system-V-信号量"><a href="#system-V-信号量" class="headerlink" title="system V 信号量"></a>system V 信号量</h2><h3 id="信号量的基本概念"><a href="#信号量的基本概念" class="headerlink" title="信号量的基本概念"></a>信号量的基本概念</h3><ul>
<li>英文：semaphore，简称SEM，主要用于<font color='red'>进程间同步</font></li>
<li>本质：内核维护的一个整数值，可对其进行各种操作+/-操作</li>
<li>分类：system V信号量、POSIX有名信号量、POSIX无名信号量</li>
<li>用途：<font color='red'>用来标识系统中可用的共享资源的个数</font>，协调各进程有序的使用这些资源，防止发生冲突</li>
<li>信号量类似于酒店房间的房卡，房卡资源是有限的、房卡也是有限的</li>
<li>P操作：程序在进入临界区之前先要对资源进行申请</li>
<li>V操作：程序离开临界区后要释放相应的资源，如房卡交给房东</li>
</ul>
<h3 id="通信原理-2"><a href="#通信原理-2" class="headerlink" title="通信原理"></a>通信原理</h3><p>• 类似于房卡，不是单个值，而是一组(实际上是数组)信号量元素构成</p>
<p>• 将信号量设置成一个绝对值</p>
<p>• 在信号量当前值的基础上加上一个数量</p>
<p>• 在信号量当前值的基础上减去一个数量，降到0以下可能会引起阻塞</p>
<p>• 阻塞进程一直等待其它进程修改信号量的值，直到恢复正常运行</p>
<p>• 信号量本身无意义，通常会与一块临界资源(如共享内存)关联使用</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430103217.png"></p>
<h3 id="使用system-V-信号量"><a href="#使用system-V-信号量" class="headerlink" title="使用system V 信号量"></a>使用system V 信号量</h3><h4 id="相关API-1"><a href="#相关API-1" class="headerlink" title="相关API"></a>相关API</h4><ul>
<li>获取信号量ID：int semget (key_t key, int nsems, int semflg);</li>
<li>P/V操作：int semop (int semid, struct sembuf* sops, size_t nsops);<ul>
<li>操作术语：荷兰语中的首字母，由荷兰科学家Edsger Dijkstra确定</li>
<li>其它操作术语：down(减小信号量 )、up（增大信号量）</li>
<li>POSIX标准：wait 、post</li>
</ul>
</li>
<li>信号量设置： int semctl (int semid, int semnum, int cmd, ….);</li>
</ul>
<h4 id="创建或打开一个信号量"><a href="#创建或打开一个信号量" class="headerlink" title="创建或打开一个信号量"></a>创建或打开一个信号量</h4><ul>
<li><p>函数原型：int semget (key_t key, int nsems, int semflg);</p>
</li>
<li><p>包含头文件：sys/ipc.h sys/sem.h</p>
</li>
<li><p>函数参数：</p>
<ul>
<li><p>key：用来表示信号量的键，通常使用值IPC_PRIVATE或由ftok创建</p>
</li>
<li><p>nsems：信号的数量，所有的信号放在一个数组内</p>
</li>
<li><p>semflg：位掩码，用来设置信号量的权限或检查一个已有信号量的权限</p>
<ul>
<li>IPC_CREAT：如果找不到指定key相关联的信号量，创建一个新信号量集合</li>
<li>IPC_EXCL：若指定了IPC_CREAT且指定key关联的信号量存在，报EEXIST错误</li>
</ul>
</li>
</ul>
</li>
<li><p>函数返回值</p>
<ul>
<li>成功：返回用于操作信号量的句柄ID</li>
<li>失败：-1，并设置errno全局变量</li>
</ul>
</li>
</ul>
<h4 id="信号量设置"><a href="#信号量设置" class="headerlink" title="信号量设置"></a>信号量设置</h4><ul>
<li><p>函数原型：int semctl (int semid, int semnum, int cmd, …);</p>
</li>
<li><p>包含头文件：</p>
<ul>
<li>#include &lt;sys/ipc.h&gt; </li>
<li>#include &lt;sys/sem.h&gt;</li>
</ul>
</li>
<li><p>函数参数：</p>
<ul>
<li>semid ：用于操作信号量的句柄ID、标识符</li>
<li>semnum ：信号量集中信号量的编号</li>
<li>cmd：<ul>
<li>IPC_RMID：删除信号量集及相关联的内核semid_ds数据结构</li>
<li>IPC_STAT：获取semid_ds 副本</li>
<li>IPC_SET：设置semid_ds 数据结构</li>
<li>GETVAL：获取信号集中第semnum个信号量的值</li>
<li>GETALL：获取所有的信号量的值</li>
<li>SETVAL：设置信号集中的第semnum个信号量的值</li>
</ul>
</li>
</ul>
</li>
<li><p>函数返回值</p>
<ul>
<li>成功：根据cmd命令，返回不同的值</li>
<li>失败：-1，并设置errno全局变量</li>
</ul>
</li>
</ul>
<h4 id="信号量P-V操作"><a href="#信号量P-V操作" class="headerlink" title="信号量P/V操作"></a>信号量P/V操作</h4><ul>
<li><p>函数原型：int semop(int semid, struct sembuf *sops, size_t nsops);</p>
</li>
<li><p>包含头文件：</p>
<ul>
<li><p>#include &lt;sys/ipc.h&gt; </p>
</li>
<li><p>#include &lt;sys/sem.h&gt;</p>
</li>
</ul>
</li>
<li><p>函数参数：</p>
<ul>
<li><p>semid ：用于操作信号量的IPC标识符</p>
</li>
<li><p>sops ：指向数组的指针，数组中包含了需要执行的操作</p>
</li>
<li><p>nsops ：<code>sembuf</code>结构体数组的长度</p>
</li>
</ul>
</li>
<li><p>函数返回值</p>
<ul>
<li><p>成功：根据cmd命令，返回不同的值</p>
</li>
<li><p>失败：-1，并设置errno全局变量</p>
</li>
</ul>
</li>
</ul>
<h4 id="结构体：sembuf"><a href="#结构体：sembuf" class="headerlink" title="结构体：sembuf"></a>结构体：sembuf</h4><ul>
<li><p>sem_num：用来标识要操作的信号集中的信号量的编号</p>
</li>
<li><p>sem_op：</p>
<ul>
<li>若大于0：将sem_op的值加到信号量值上</li>
<li>若等于0：对信号量值进行检查，确定其当前值是否为0，若为0操作结束，若不为0，则一直阻塞，直到信号量的值变为0为止</li>
<li>若小于0：将信号量值减去sem_op。最后结果大于或等于0，操作立即结束；若最后结果小于0，则当前进程会阻塞</li>
</ul>
</li>
<li><p>sem_flag：</p>
<ul>
<li>SEM_UNDO</li>
<li>IPC_NOWAIT</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> sem_num; </span><br><span class="line">    <span class="comment">/* semaphore index in array */</span></span><br><span class="line">    <span class="keyword">short</span> sem_op; <span class="comment">/* semaphore operation */</span></span><br><span class="line">    <span class="keyword">short</span> sem_flg; <span class="comment">/* operation flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h3 id="使用流程"><a href="#使用流程" class="headerlink" title="使用流程"></a>使用流程</h3><ul>
<li>使用 <code>semget</code> 创建或打开一个信号量集</li>
<li>使用 <code>semctl SETVAL</code>或 <code>SETVAL</code>操作初始化集合中的信号量（其中一个进程操作即可，内核中维护，对其它进程全局可见）</li>
<li>使用 <code>semop</code> 操作信号量值。多个进程通过多信号量值的操作来表示一些临界资源的获取和释放</li>
<li>当所有的进程不再需要信号量集时，使用 <code>semctl IPC_RMID</code> 操作删除这个信号量集（其中一个进程操作即可）</li>
</ul>
<h3 id="编程实例-3"><a href="#编程实例-3" class="headerlink" title="编程实例"></a>编程实例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a semphore</span></span><br><span class="line"><span class="comment">// print and set semphore</span></span><br><span class="line"><span class="comment">// P/V sem value</span></span><br><span class="line"><span class="comment">// delete sem</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span>* <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span>* <span class="built_in">array</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>* __<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sem_id;</span><br><span class="line">    <span class="keyword">key_t</span> key;</span><br><span class="line">    <span class="keyword">if</span> ((key = ftok (<span class="string">&quot;.&quot;</span>, <span class="number">514</span>)) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;ftok&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((sem_id = semget (key, <span class="number">3</span>, IPC_CREAT | <span class="number">0770</span>)) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;semget&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem id: %d\n&quot;</span>, sem_id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get sem value</span></span><br><span class="line">    <span class="keyword">int</span> sem_value;</span><br><span class="line">    sem_value = semctl (sem_id, <span class="number">0</span>, GETVAL);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem value : %d\n&quot;</span>, sem_value);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">semun</span> <span class="title">sem_union</span>;</span></span><br><span class="line">    sem_union.val = <span class="number">2</span>;</span><br><span class="line">    semctl (sem_id, <span class="number">0</span>, SETVAL, sem_union);</span><br><span class="line">    sem_value = semctl (sem_id, <span class="number">0</span>, GETVAL);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem value : %d\n&quot;</span>, sem_value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sem p/v operations</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = <span class="number">0</span>; </span><br><span class="line">    sops.sem_op = <span class="number">-1</span>; <span class="comment">// if sem value = 0, block</span></span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;sem_op&quot;</span>);</span><br><span class="line">    sem_value = semctl (sem_id, <span class="number">0</span>, GETVAL);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem_value: %d\n&quot;</span>, sem_value);</span><br><span class="line"></span><br><span class="line">    sleep (<span class="number">30</span>);</span><br><span class="line">    semctl (sem_id, <span class="number">0</span>, IPC_RMID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430115857.png"></p>
<h2 id="信号量编程应用：对共享内存的同步访问"><a href="#信号量编程应用：对共享内存的同步访问" class="headerlink" title="信号量编程应用：对共享内存的同步访问"></a>信号量编程应用：对共享内存的同步访问</h2><p>对共享内存的同步访问</p>
<ul>
<li>通过读、写信号量实现对共享内存的同步互斥访问</li>
<li>实现一个二元信号量协议<ul>
<li>读信号量：当为1时，读进程才能进行P操作、读取数据，否则会阻塞</li>
<li>写信号量：当为1时，写进程才能进行P操作，写入数据，否则会阻塞</li>
</ul>
</li>
</ul>
<h3 id="shm-read-c"><a href="#shm-read-c" class="headerlink" title="shm_read.c"></a>shm_read.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semnu</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> * <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> * <span class="built_in">array</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>* __<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sem_id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_init</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum, <span class="keyword">int</span> sem_value)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">semnu</span> <span class="title">sem_union</span>;</span></span><br><span class="line">    sem_union.val = sem_value;</span><br><span class="line">    <span class="keyword">if</span> (semctl (semid, nsignum, SETVAL, sem_union) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semctl&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_p</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = nsignum;</span><br><span class="line">    sops.sem_op = <span class="number">-1</span>;</span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_v</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = nsignum;</span><br><span class="line">    sops.sem_op = <span class="number">1</span>;</span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_print</span> <span class="params">(<span class="keyword">int</span> sem_id, <span class="keyword">int</span> nsignum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sem_value;</span><br><span class="line">    sem_value = semctl (sem_id, nsignum, GETVAL);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem[%d] = %d\n&quot;</span>, nsignum, sem_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_id;</span><br><span class="line">    <span class="keyword">key_t</span> shm_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5151</span>);</span><br><span class="line">    <span class="keyword">key_t</span> sem_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5152</span>);</span><br><span class="line"></span><br><span class="line">    shm_id = shmget (shm_key, <span class="number">1028</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">char</span> * shm_addr = shmat (shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sem_id = semget (sem_key, <span class="number">2</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (sem_id == <span class="number">-1</span>) &#123;</span><br><span class="line">        sem_id = semget (sem_key, <span class="number">2</span>, <span class="number">0644</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sem_init (sem_id, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// sem[0]: for read</span></span><br><span class="line">        sem_init (sem_id, <span class="number">1</span>, <span class="number">1</span>); <span class="comment">// sem[1]: for write</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        sem_p (sem_id, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;from shm: %s&quot;</span>, shm_addr);</span><br><span class="line">        sem_v (sem_id, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="shm-write-c"><a href="#shm-write-c" class="headerlink" title="shm_write.c"></a>shm_write.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semnu</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> * <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> * <span class="built_in">array</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>* __<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sem_id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_init</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum, <span class="keyword">int</span> sem_value)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">semnu</span> <span class="title">sem_union</span>;</span></span><br><span class="line">    sem_union.val = sem_value;</span><br><span class="line">    <span class="keyword">if</span> (semctl (semid, nsignum, SETVAL, sem_union) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semctl&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_p</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = nsignum;</span><br><span class="line">    sops.sem_op = <span class="number">-1</span>;</span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_v</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = nsignum;</span><br><span class="line">    sops.sem_op = <span class="number">1</span>;</span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_print</span> <span class="params">(<span class="keyword">int</span> sem_id, <span class="keyword">int</span> nsignum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sem_value;</span><br><span class="line">    sem_value = semctl (sem_id, nsignum, GETVAL);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem[%d] = %d\n&quot;</span>, nsignum, sem_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_id;</span><br><span class="line">    <span class="keyword">key_t</span> shm_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5151</span>);</span><br><span class="line">    <span class="keyword">key_t</span> sem_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5152</span>);</span><br><span class="line"></span><br><span class="line">    shm_id = shmget (shm_key, <span class="number">1028</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">char</span> * shm_addr = shmat (shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sem_id = semget (sem_key, <span class="number">2</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (sem_id == <span class="number">-1</span>) &#123;</span><br><span class="line">        sem_id = semget (sem_key, <span class="number">2</span>, <span class="number">0644</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sem_init (sem_id, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// sem[0]: for read</span></span><br><span class="line">        sem_init (sem_id, <span class="number">1</span>, <span class="number">1</span>); <span class="comment">// sem[1]: for write</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        sem_p (sem_id, <span class="number">1</span>);</span><br><span class="line">        fgets (shm_addr, <span class="number">1028</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        sem_v (sem_id, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这样两个进程就可同步的对同一片共享内存进行读写了</p>
<h2 id="信号量编程应用：生产者-消费者模型"><a href="#信号量编程应用：生产者-消费者模型" class="headerlink" title="信号量编程应用：生产者-消费者模型"></a>信号量编程应用：生产者-消费者模型</h2><h3 id="编程实例-4"><a href="#编程实例-4" class="headerlink" title="编程实例"></a>编程实例</h3><p>生产者消费者模型</p>
<ul>
<li>若有若干个缓冲区，生产者不断往里填数据，消费者不断的从里面取数据</li>
<li>如何使两者不产生冲突呢？<ul>
<li>缓冲区只有若干个，且有固定大小，而生产者和消费者则有多个进程</li>
<li>生产者往缓冲区填数据前要判断缓冲区是否满了，满了就会等，直到有空间</li>
<li>消费者从缓冲区拿数据之前要判断缓冲区是否为空，空了就会等，直到缓冲区内有数据为止</li>
<li>在某个时刻，缓冲区只允许一个操作者进行读或写操作</li>
</ul>
</li>
</ul>
<p>生产消费者模型</p>
<ul>
<li><p>2个生产者，每1S、5S往缓冲区写一次数据</p>
</li>
<li><p>3个消费者，每2S、2S、5S往缓冲区读一次数据</p>
</li>
<li><p>2个写进程分别对写信号量做P操作、对读信号量做V操作</p>
</li>
<li><p>3个读进程分别对写信号量做V操作、对读信号量做P操作</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430173437.png"></p>
<h4 id="producer"><a href="#producer" class="headerlink" title="producer"></a>producer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_write</span> <span class="params">(<span class="keyword">int</span>* addr, <span class="keyword">int</span> data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    index = addr[<span class="number">0</span>];</span><br><span class="line">    index ++;</span><br><span class="line">    addr[index] = data;</span><br><span class="line">    addr[<span class="number">0</span>] = index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> * <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span>* <span class="built_in">array</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span> * __<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sem_id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_init</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum, <span class="keyword">int</span> sem_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">semun</span> <span class="title">sem_union</span>;</span></span><br><span class="line">    sem_union.val = sem_value;</span><br><span class="line">    <span class="keyword">if</span> (semctl (semid, nsignum, SETVAL, sem_union) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;semctl&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sem_p</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = nsignum;</span><br><span class="line">    sops.sem_op  = <span class="number">-1</span>;</span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sem_v</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">    sops.sem_num = nsignum;</span><br><span class="line">    sops.sem_op  = <span class="number">1</span>;</span><br><span class="line">    sops.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_print</span> <span class="params">(<span class="keyword">int</span> sem_id, <span class="keyword">int</span> nsignum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sem_value;</span><br><span class="line">    sem_value = semctl (sem_id, nsignum, GETVAL);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem[%d] = %d\n&quot;</span>, nsignum, sem_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_id;</span><br><span class="line">    <span class="keyword">key_t</span> shm_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5161</span>);</span><br><span class="line">    <span class="keyword">key_t</span> sem_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5162</span>);</span><br><span class="line"></span><br><span class="line">    shm_id = shmget (shm_key, <span class="number">1028</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">char</span> *shm_addr = shmat (shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span> (shm_addr, <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    sem_id = semget (sem_key, <span class="number">2</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (sem_id == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semget&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sem_init (sem_id, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        sem_init (sem_id, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    <span class="keyword">if</span> ((ret_from_fork = fork()) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> child_data = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            sleep (<span class="number">1</span>);</span><br><span class="line">            sem_p (sem_id, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;child data: %d\n&quot;</span>, child_data);</span><br><span class="line">            mem_write ((<span class="keyword">int</span> *) shm_addr, child_data);</span><br><span class="line">            child_data = child_data + <span class="number">2</span>;</span><br><span class="line">            sem_v (sem_id, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> parent_data = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            sleep (<span class="number">1</span>);</span><br><span class="line">            sem_p (sem_id, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;parent data: %d\n&quot;</span>, parent_data);</span><br><span class="line">            mem_write ((<span class="keyword">int</span> *) shm_addr, parent_data);</span><br><span class="line">            parent_data = parent_data + <span class="number">2</span>;</span><br><span class="line">            sem_v (sem_id, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="consumer"><a href="#consumer" class="headerlink" title="consumer"></a>consumer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mem_read</span> <span class="params">(<span class="keyword">int</span>* addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    index = addr[<span class="number">0</span>];</span><br><span class="line">    data = addr[index];</span><br><span class="line">    index --;</span><br><span class="line">    addr[<span class="number">0</span>] = index;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> * <span class="title">buf</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span>* <span class="built_in">array</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span> * __<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sem_id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_init</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum, <span class="keyword">int</span> sem_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">semun</span> <span class="title">sem_union</span>;</span></span><br><span class="line">        sem_union.val = sem_value;</span><br><span class="line">        <span class="keyword">if</span> (semctl (semid, nsignum, SETVAL, sem_union) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                perror (<span class="string">&quot;semctl&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sem_p</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">        sops.sem_num = nsignum;</span><br><span class="line">        sops.sem_op  = <span class="number">-1</span>;</span><br><span class="line">        sops.sem_flg = SEM_UNDO;</span><br><span class="line">        <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">sem_v</span> <span class="params">(<span class="keyword">int</span> semid, <span class="keyword">int</span> nsignum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sops</span>;</span></span><br><span class="line">        sops.sem_num = nsignum;</span><br><span class="line">        sops.sem_op  = <span class="number">1</span>;</span><br><span class="line">        sops.sem_flg = SEM_UNDO;</span><br><span class="line">        <span class="keyword">if</span> (semop (sem_id, &amp;sops, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                perror (<span class="string">&quot;semop&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sem_print</span> <span class="params">(<span class="keyword">int</span> sem_id, <span class="keyword">int</span> nsignum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sem_value;</span><br><span class="line">        sem_value = semctl (sem_id, nsignum, GETVAL);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sem[%d] = %d\n&quot;</span>, nsignum, sem_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_id;</span><br><span class="line">    <span class="keyword">key_t</span> shm_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5161</span>);</span><br><span class="line">    <span class="keyword">key_t</span> sem_key = ftok (<span class="string">&quot;./&quot;</span>, <span class="number">5162</span>);</span><br><span class="line"></span><br><span class="line">    shm_id = shmget (shm_key, <span class="number">1028</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">char</span> *shm_addr = shmat (shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span> (shm_addr, <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    sem_id = semget (sem_key, <span class="number">2</span>, IPC_CREAT | <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (sem_id == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;semget&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sem_init (sem_id, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        sem_init (sem_id, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">        <span class="keyword">if</span> ((ret_from_fork = fork()) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                sleep (<span class="number">2</span>);</span><br><span class="line">                sem_p (sem_id, <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;pid: %d data: %d\n&quot;</span>, getpid(), mem_read((<span class="keyword">int</span> *)shm_addr));</span><br><span class="line">                sem_v (sem_id, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        sleep (<span class="number">5</span>);</span><br><span class="line">        sem_p (sem_id, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;pid: %d data : %d\n&quot;</span>, getpid(), mem_read((<span class="keyword">int</span> *)shm_addr));</span><br><span class="line">        sem_v (sem_id, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><p>System V 信号量的通信特点</p>
<ul>
<li><p>信号量是通过标识符而不是常用的文件描述符来引用的</p>
</li>
<li><p>使用键而不是文件名来标识信号量</p>
</li>
<li><p>创建和初始化信号量需要使用单独的系统调用</p>
</li>
<li><p>内核不会维护引用一个信号量集的进程数量。很多操作需要开发者自己控制</p>
</li>
<li><p>信号量的操作存在诸多限制</p>
</li>
</ul>
<h2 id="POSIX-IPC"><a href="#POSIX-IPC" class="headerlink" title="POSIX IPC"></a>POSIX IPC</h2><h3 id="POSIX-IPC简介"><a href="#POSIX-IPC简介" class="headerlink" title="POSIX IPC简介"></a>POSIX IPC简介</h3><h4 id="POSIX-IPC对象编程接口"><a href="#POSIX-IPC对象编程接口" class="headerlink" title="POSIX IPC对象编程接口"></a>POSIX IPC对象编程接口</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230430210017.png"></p>
<h4 id="POSIX-与-system-V-IPC"><a href="#POSIX-与-system-V-IPC" class="headerlink" title="POSIX 与 system V IPC"></a>POSIX 与 system V IPC</h4><p>POSIX IPC</p>
<ul>
<li><p>POSIX接口更简单：使用类似于文件I/O的open、close、unlink等接口</p>
</li>
<li><p>POSIX使用名字代替键来标识IPC对象</p>
</li>
<li><p>对IPC 对象引用计数，简化了对 IPC 对象的删除</p>
<ul>
<li>跟文件类似，删除操作也仅仅是删除了IPC对象的名字</li>
<li>只有当IPC对象的引用计数变成0之后才真正销毁IPC对象</li>
</ul>
</li>
</ul>
<p>System V IPC</p>
<ul>
<li><p>System V IPC 可移植性更好：几乎所有的UNIX系统都支持system V，POSIX在UNIX系统中只是一个可选组件，有些UNIX系统并不支持</p>
</li>
<li><p>Linux系统一般都会支持system V</p>
</li>
<li><p>Linux 2.6开始陆续支持POSIX…</p>
</li>
</ul>
<h4 id="POSIX-编程注意事项"><a href="#POSIX-编程注意事项" class="headerlink" title="POSIX 编程注意事项"></a>POSIX 编程注意事项</h4><ul>
<li><p>使用POSIX 消息队列和共享内存时，需要实时库librt链接，编译时需指定$ -lrt</p>
</li>
<li><p>使用POSIX 信号量时，需要和线程库libpthread链接起来，编译时需指定$ -lpthread</p>
</li>
</ul>
<h3 id="POSIX消息队列上：API编程实例"><a href="#POSIX消息队列上：API编程实例" class="headerlink" title="POSIX消息队列上：API编程实例"></a>POSIX消息队列上：API编程实例</h3><h4 id="相关API-2"><a href="#相关API-2" class="headerlink" title="相关API"></a>相关API</h4><p>• mq_open： 创建或打开一个消息队列</p>
<p>• mq_send： 向消息队列写入一条消息</p>
<p>• mq_receive：从消息队列中读取一条消息</p>
<p>• mq_close： 关闭进程打开的消息队列</p>
<p>• mq_unlink：删除一个消息队列</p>
<p>• mq_setattr：设置消息队列一些额外的属性</p>
<p>• mq_getattr：获取消息队列一些额外的属性</p>
<p>• mq_nofity： 异步通知</p>
<h4 id="创建和打开IPC对象"><a href="#创建和打开IPC对象" class="headerlink" title="创建和打开IPC对象"></a>创建和打开IPC对象</h4><p>函数原型：</p>
<ul>
<li><p>mqd_t mq_open (const char *name, int oflag);</p>
</li>
<li><p>mqd_t mq_open (const char *name, int oflag, mode_t mode, struct mq_attr *attr);</p>
</li>
</ul>
<p>函数功能：使用指定名字创建或打开一个对象，返回该对象的句柄</p>
<p>函数参数:</p>
<ul>
<li><p>name：用来标识要创建或打开的对象</p>
</li>
<li><p>Oflag：O_CREAT/O_EXCL /O_RDONLY /O_WRONLY /O_RDWR /O_NONBLOCK</p>
</li>
<li><p>Mode：位掩码，权限设置</p>
</li>
<li><p>Attr：设置消息队列的属性，若为NULL，使用默认属性。Linux3.5以后版本也可通过/proc查看设置</p>
</li>
</ul>
<p>函数返回值</p>
<ul>
<li><p>成功：返回消息队列的IPC对象描述符</p>
</li>
<li><p>失败：返回-1，并设置errno</p>
</li>
</ul>
<h4 id="关闭POSIX消息队列"><a href="#关闭POSIX消息队列" class="headerlink" title="关闭POSIX消息队列"></a>关闭POSIX消息队列</h4><ul>
<li><p>函数原型：int mq_close(mqd_t mqdes);</p>
</li>
<li><p>函数功能：通过描述符关闭消息队列</p>
</li>
<li><p>TIPS：</p>
<ul>
<li>POSIX 消息队列在进程终止或执行exec()时会自动被关闭</li>
</ul>
</li>
</ul>
<h4 id="删除一个POSIX-消息队列"><a href="#删除一个POSIX-消息队列" class="headerlink" title="删除一个POSIX 消息队列"></a>删除一个POSIX 消息队列</h4><ul>
<li><p>函数原型：int mq_unlink (const char *name);</p>
</li>
<li><p>函数功能：</p>
<ul>
<li>删除通过 name 标识的消息队列</li>
<li>在所有进程使用完该队列之后销毁该队列。</li>
<li>若打开该队列的所有进程已经关闭该队列，立即删除</li>
</ul>
</li>
</ul>
<h4 id="向-POSIX-消息队列写入消息"><a href="#向-POSIX-消息队列写入消息" class="headerlink" title="向 POSIX 消息队列写入消息"></a>向 POSIX 消息队列写入消息</h4><ul>
<li><p>函数原型：int mq_send(mqd_t mqdes, const char *msg_ptr, size_t msg_len, unsigned int msg_prio);</p>
</li>
<li><p>函数功能：将msg_ptr指向的缓冲区中的消息添加到描述符mqdes所引 用的消息队列中</p>
</li>
<li><p>函数参数：</p>
<ul>
<li><p>mqdes： 消息队列描述符</p>
</li>
<li><p>msg_ptr：指向存放消息的缓冲区指针</p>
</li>
<li><p>msg_len：消息的长度[10,8192]</p>
</li>
<li><p>msg_prio：消息对队列中按优先级排列，设置为0表示无需优先级</p>
</li>
</ul>
</li>
</ul>
<h4 id="从-POSIX-消息队列读取消息"><a href="#从-POSIX-消息队列读取消息" class="headerlink" title="从 POSIX 消息队列读取消息"></a>从 POSIX 消息队列读取消息</h4><ul>
<li><p>ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, size_t msg_len, unsigned int *msg_prio);</p>
</li>
<li><p>函数功能：</p>
<ul>
<li>如果msg_prio设置为NULL，则从mqdes引用的消息队列中删除一条优先级最高、存放时间最长的消息</li>
<li>将删除的消息保存在msg_ptr指针指向的缓冲区</li>
</ul>
</li>
<li><p>函数参数：</p>
<ul>
<li><p>mqdes： 消息队列描述符</p>
</li>
<li><p>msg_ptr：指向存放消息的缓冲区指针</p>
</li>
<li><p>msg_len：msg_ptr所指向的缓冲区长度，要大于消息队列的mq_msgsize</p>
</li>
<li><p>msg_prio：如不为空，接收到的消息的优先级会被复制到指针指向处</p>
</li>
</ul>
</li>
<li><p>函数返回值</p>
<ul>
<li><p>成功：返回接收的消息的字节数</p>
</li>
<li><p>失败：-1，并设置errno</p>
</li>
</ul>
</li>
</ul>
<h4 id="编程实例-5"><a href="#编程实例-5" class="headerlink" title="编程实例"></a>编程实例</h4><h5 id="父子进程通过消息队列进行通信"><a href="#父子进程通过消息队列进行通信" class="headerlink" title="父子进程通过消息队列进行通信"></a>父子进程通过消息队列进行通信</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    <span class="keyword">do</span> &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mqd_t</span> mq_id;</span><br><span class="line">    <span class="keyword">if</span> ((mq_id = mq_open (<span class="string">&quot;/posix_msg_queue&quot;</span>, O_RDWR | O_CREAT, <span class="number">0644</span>, <span class="literal">NULL</span>)) == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;mq_open&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> <span class="title">mq_attribute</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (mq_getattr (mq_id, &amp;mq_attribute) == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;mq_getattr&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;mq_flags: %ld\n&quot;</span>, mq_attribute.mq_flags);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;mq_maxmsg: %ld\n&quot;</span>, mq_attribute.mq_maxmsg);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;mq_msgsize: %ld\n&quot;</span>, mq_attribute.mq_msgsize);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;mq_curmsgs: %ld\n&quot;</span>, mq_attribute.mq_curmsgs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret_from_fork;</span><br><span class="line">    ret_from_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_from_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> msg_buf[mq_attribute.mq_msgsize];</span><br><span class="line">        <span class="built_in">memset</span> (msg_buf, <span class="number">0</span>, mq_attribute.mq_msgsize);</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (count --) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mq_receive (mq_id, msg_buf, mq_attribute.mq_msgsize, <span class="literal">NULL</span>) == <span class="number">-1</span>) </span><br><span class="line">                handle_error (<span class="string">&quot;mq_receive&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;child process receive msg: %s\n&quot;</span>, msg_buf);</span><br><span class="line">            sleep (<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_from_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (count --) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mq_send (mq_id, <span class="string">&quot;hello world&quot;</span>, <span class="keyword">sizeof</span> (<span class="string">&quot;hello world&quot;</span>), <span class="number">1</span>) == <span class="number">-1</span>) </span><br><span class="line">                handle_error (<span class="string">&quot;msg_send&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;parent process: send msg to mqueue success\n&quot;</span>);</span><br><span class="line">            sleep (<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line">        handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mq_close (mq_id);</span><br><span class="line">    sleep (<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mq_unlink (<span class="string">&quot;/posix_msg_queue&quot;</span>) == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;mq_unlink&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="两个不相关的进程通过消息队列进行通信"><a href="#两个不相关的进程通过消息队列进行通信" class="headerlink" title="两个不相关的进程通过消息队列进行通信"></a>两个不相关的进程通过消息队列进行通信</h5><p>mq_send.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mqd_t</span> mq_id;</span><br><span class="line">    <span class="keyword">if</span> ((mq_id = mq_open (<span class="string">&quot;/posix_msg_queue&quot;</span>, O_WRONLY | O_CREAT, <span class="number">0644</span>, <span class="literal">NULL</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span> (count --) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mq_send (mq_id, <span class="string">&quot;hello world&quot;</span>, <span class="keyword">sizeof</span> (<span class="string">&quot;hello world&quot;</span>), <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;mq_receive&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;msg send success .......... \n&quot;</span>);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mq_close (mq_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>mq_rcv.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mqd_t</span> mq_id;</span><br><span class="line">    <span class="keyword">if</span> ((mq_id = mq_open (<span class="string">&quot;/posix_msg_queue&quot;</span>, O_RDONLY | O_CREAT, <span class="number">0644</span>, <span class="literal">NULL</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> <span class="title">mq_attribute</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (mq_getattr (mq_id, &amp;mq_attribute) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_getattr&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> msg_buf[mq_attribute.mq_msgsize];</span><br><span class="line">    <span class="built_in">memset</span> (msg_buf, <span class="number">0</span>, mq_attribute.mq_msgsize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span> (count --) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mq_receive (mq_id, msg_buf, mq_attribute.mq_msgsize, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;mq_receive&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;%s\n&quot;</span>, msg_buf);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mq_close (mq_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mq_unlink (<span class="string">&quot;/posix_msg_queue&quot;</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_unlink&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="POSIX消息队列中：异步通知"><a href="#POSIX消息队列中：异步通知" class="headerlink" title="POSIX消息队列中：异步通知"></a>POSIX消息队列中：异步通知</h3><h4 id="异步通知API介绍"><a href="#异步通知API介绍" class="headerlink" title="异步通知API介绍"></a>异步通知API介绍</h4><p>异步通知API介绍</p>
<ul>
<li><p>函数原型：int mq_notify(mqd_t mqdes, const struct sigevent * sevp);</p>
</li>
<li><p>函数功能：</p>
<ul>
<li>当空的消息队列到来消息时给进程发送一个通知</li>
<li>当执行完相关处理，通知机制结束，可以重新调用mq_notify注册</li>
</ul>
</li>
<li><p>函数参数：</p>
<ul>
<li>mqdes：消息队列的ID</li>
<li>sevp：通知方式设置</li>
</ul>
</li>
</ul>
<h4 id="关键结构体：sigevent"><a href="#关键结构体：sigevent" class="headerlink" title="关键结构体：sigevent"></a>关键结构体：sigevent</h4><ul>
<li><p>sigev_notify</p>
<ul>
<li>SIGEV_NONE：有通知时什么也不做</li>
<li>SIGEV_SIGNAL：给进程发送一个信号来通知进程</li>
<li>SIGEV_THREAD/ SIGEV_THREAD_ID</li>
</ul>
</li>
<li><p>sigev_signo：要发送的信号</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigevent</span> &#123;</span></span><br><span class="line">     <span class="keyword">int</span> sigev_notify; <span class="comment">/* Notification method */</span></span><br><span class="line">     <span class="keyword">int</span> sigev_signo; <span class="comment">/* Notification signal */</span></span><br><span class="line">     <span class="class"><span class="keyword">union</span> <span class="title">sigval</span> <span class="title">sigev_value</span>;</span> <span class="comment">/* Data passed with notification */</span></span><br><span class="line">     <span class="keyword">void</span> (*sigev_notify_function) (<span class="keyword">union</span> sigval);<span class="comment">/* Function used for thread notification (SIGEV_THREAD) */</span></span><br><span class="line">     <span class="keyword">void</span> *sigev_notify_attributes; <span class="comment">/* Attributes for notification thread (SIGEV_THREAD) */</span></span><br><span class="line">     <span class="keyword">pid_t</span> sigev_notify_thread_id; <span class="comment">/* ID of thread to signal (SIGEV_THREAD_ID) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="编程实例-6"><a href="#编程实例-6" class="headerlink" title="编程实例"></a>编程实例</h4><h5 id="mq-notify-c"><a href="#mq-notify-c" class="headerlink" title="mq_notify.c"></a>mq_notify.c</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mqd_t</span> mq_id;</span><br><span class="line"><span class="keyword">char</span> buff[<span class="number">8192</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigevent</span> <span class="title">sigev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">signal_handler</span> <span class="params">(<span class="keyword">int</span> signo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> receive_len;</span><br><span class="line">    mq_notify (mq_id, &amp;sigev);</span><br><span class="line">    <span class="built_in">memset</span> (buff, <span class="number">0</span>, <span class="keyword">sizeof</span> (buff));</span><br><span class="line">    receive_len = mq_receive (mq_id, buff, <span class="number">8192</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (receive_len == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_receive&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;read: %ld bytes: %s\n&quot;</span>, (<span class="keyword">long</span>) receive_len, buff);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    mq_id = mq_open (<span class="string">&quot;/notify_mqueue&quot;</span>, O_RDONLY | O_CREAT, <span class="number">0644</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (mq_id == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    signal (SIGUSR1, signal_handler);</span><br><span class="line">    sigev.sigev_notify = SIGEV_SIGNAL;</span><br><span class="line">    sigev.sigev_signo = SIGUSR1;</span><br><span class="line">    mq_notify (mq_id, &amp;sigev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;while loop %d\n&quot;</span>, count ++);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mq_close (mq_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="mq-send-c"><a href="#mq-send-c" class="headerlink" title="mq_send.c"></a>mq_send.c</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mqd_t</span> mq_id;</span><br><span class="line">    <span class="keyword">if</span> ((mq_id = mq_open (<span class="string">&quot;/notify_mqueue&quot;</span>, O_WRONLY | O_CREAT, <span class="number">0644</span>, <span class="literal">NULL</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mq_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> s[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">memset</span> (s, <span class="number">0</span>, <span class="keyword">sizeof</span> (s));</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;please input:&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span> (<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">        <span class="keyword">if</span> (mq_send (mq_id, s, <span class="built_in">strlen</span>(s), <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;msg_receive&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;msg send success....str:%s len = %ld\n&quot;</span>, s, <span class="built_in">strlen</span>(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="POSIX消息队列下-内核实现"><a href="#POSIX消息队列下-内核实现" class="headerlink" title="POSIX消息队列下:内核实现"></a>POSIX消息队列下:内核实现</h3><h4 id="POSIX消息队列内核实现"><a href="#POSIX消息队列内核实现" class="headerlink" title="POSIX消息队列内核实现"></a>POSIX消息队列内核实现</h4><ul>
<li><p>相关数据结构：/usr/include/linux/mqueue.h、/ipc/mqueue.c</p>
</li>
<li><p>消息队列是消息的链表，存储在内核中，由消息队列标识符标识。</p>
</li>
<li><p>标识符成为消息队列的ID，程序通过这个句柄可以操作消息队列</p>
</li>
<li><p>消息属性：</p>
<ul>
<li>一个无符号整数优先级 </li>
<li>消息的数据长度(可以为0)</li>
<li>消息的数据本身</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230504093705.png"></p>
<h4 id="system-V消息队列内核实现"><a href="#system-V消息队列内核实现" class="headerlink" title="system V消息队列内核实现"></a>system V消息队列内核实现</h4><ul>
<li><p>相关数据结构：msgid_ds 、/usr/include/linux/msg.h、/ipc/msg.c</p>
</li>
<li><p>消息队列是消息的链表，存储在内核中，由消息队列标识符标识。</p>
</li>
<li><p>标识符成为消息队列的ID，程序通过这个句柄可以操作消息队列</p>
</li>
<li><p>消息属性：</p>
<ul>
<li><p>一个长整数类型(System V)</p>
</li>
<li><p>消息的数据长度(可以为0)</p>
</li>
<li><p>消息的数据本身</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230504093807.png"></p>
<h4 id="内核中的POSIX消息队列描述符"><a href="#内核中的POSIX消息队列描述符" class="headerlink" title="内核中的POSIX消息队列描述符"></a>内核中的POSIX消息队列描述符</h4><ul>
<li><p>用来标识打开的消息队列，类似于文件描述符，用来标识打开的文件</p>
</li>
<li><p>是一个进程级句柄，在内核中实现类似于文件描述符</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230504094537.png"></p>
<h4 id="查看设置消息队列的属性"><a href="#查看设置消息队列的属性" class="headerlink" title="查看设置消息队列的属性"></a>查看设置消息队列的属性</h4><ul>
<li><p>通过proc文件系统</p>
<ul>
<li>$ cat /proc/sys/fs/mqueue/queues_max</li>
<li>$ cat /proc/sys/fs/mqueue/msg_max</li>
<li>$ cat /proc/sys/fs/mqueue/msgsize_max</li>
</ul>
</li>
<li><p>通过POSIX系统调用接口</p>
</li>
<li><p>mq_setattr：设置mq_flags</p>
</li>
<li><p>mq_open：设置mq_maxmsg、mq_msgsize</p>
</li>
</ul>
<h4 id="POSIX消息队列在Linux上实现的特性"><a href="#POSIX消息队列在Linux上实现的特性" class="headerlink" title="POSIX消息队列在Linux上实现的特性"></a>POSIX消息队列在Linux上实现的特性</h4><ul>
<li><p>提供了mqueue类型的虚拟文件系统</p>
</li>
<li><p>使用另一种I/O模型操作消息队列、获取消息队列的相关信息</p>
<ul>
<li>可通过挂载、ls、rm命令来列出和删除消息队列</li>
<li>$ mkdir /dev/mqueue</li>
<li>$ mount -t mqueue none /dev/queue</li>
<li>$ cat /dev/mqueue/my_mqueue</li>
<li>$ hexdump /dev/mqueue/my_mqueue</li>
</ul>
</li>
</ul>
<h4 id="POSIX与-system-V消息队列"><a href="#POSIX与-system-V消息队列" class="headerlink" title="POSIX与 system V消息队列"></a>POSIX与 system V消息队列</h4><p>区别和联系</p>
<ul>
<li><p>POSXI消息队列通过设置优先级，总是返回优先级最高的最早消息</p>
</li>
<li><p>System V 消息队列可以通过消息类型返回指定优先级的任意消息</p>
</li>
<li><p>POSIX消息队列可以实现异步事件通知</p>
<ul>
<li>当有一个消息放置到某个空消息队列中时，这种通知有两种方式可以选择：产生一个信号，或者创建一个线程来执行一个指定的函数</li>
<li>msgrcv函数接受信息时，若队列为空会阻塞，若设置了NOBLOCK标志，则会不停地调用msgrcv轮询是否有消息到来，非常消耗CPU资源</li>
</ul>
</li>
</ul>
<h4 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h4><p>POSIX消息队列的优势</p>
<ul>
<li>允许一个进程能够在一条消息进入之前的空队列时异步地通过信号或线程实例化来接受通知</li>
<li>在Linux上可以使用poll、select、epoll 来监控POSIX消息队列</li>
<li>POSIX可移植性很差</li>
<li>POSIX消息队列严格按照优先级排序，而system V可以根据类型来选择消息，灵活性更强</li>
</ul>
<h3 id="POSIX-信号量"><a href="#POSIX-信号量" class="headerlink" title="POSIX 信号量"></a>POSIX 信号量</h3><h4 id="相关的API"><a href="#相关的API" class="headerlink" title="相关的API"></a>相关的API</h4><p>• sem_t *sem_open (const char *name, int oflag);</p>
<p>• sem_t *sem_open (const char *name, int oflag,mode_t mode, unsigned </p>
<p>int value);</p>
<p>• int sem_close (sem_t *sem);</p>
<p>• int sem_post (sem_t *sem);</p>
<p>• int sem_wait (sem_t *sem);</p>
<p>• int sem_trywait (sem_t *sem);</p>
<p>• int sem_timedwait (sem_t *sem, const struct timespec *abs_timeout);</p>
<p>• int sem_unlink (const char *name);</p>
<p>• int sem_getvalue (sem_t *sem, int *sval);</p>
<h4 id="使用指南"><a href="#使用指南" class="headerlink" title="使用指南"></a>使用指南</h4><ul>
<li><p>包含头文件：#include &lt;semaphore.h&gt;</p>
</li>
<li><p>编译时要指定：-lpthread</p>
</li>
<li><p>Pthread：</p>
<ul>
<li>POSIX threads，操作线程的API标准</li>
<li>适用于 Unix、Linux、Mac OS</li>
</ul>
</li>
</ul>
<h4 id="编程实例-7"><a href="#编程实例-7" class="headerlink" title="编程实例"></a>编程实例</h4><h5 id="sem-demo-c"><a href="#sem-demo-c" class="headerlink" title="sem_demo.c"></a>sem_demo.c</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sem_value = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">sem_t</span> * sem = sem_open (<span class="string">&quot;posix_sem&quot;</span>, O_RDWR | O_CREAT | O_EXCL, <span class="number">0777</span>, sem_value);</span><br><span class="line">    <span class="keyword">if</span> (sem == SEM_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;sem_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sem_getvalue (sem, &amp;sem_value) != <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;the sem values: %d\n&quot;</span>, sem_value);</span><br><span class="line">    sem_wait (sem);</span><br><span class="line">    sem_wait (sem);</span><br><span class="line">    sem_wait (sem);</span><br><span class="line">    sem_wait (sem);</span><br><span class="line">    <span class="comment">// sem_wait (sem); // 加上这一行会阻塞</span></span><br><span class="line">    <span class="comment">// sem_try_wait (); // 不会阻塞</span></span><br><span class="line">    <span class="keyword">if</span> (sem_getvalue (sem, &amp;sem_value) != <span class="number">-1</span>) </span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;the sem value: %d\n&quot;</span>, sem_value);</span><br><span class="line">    sem_post (sem);</span><br><span class="line">    sem_post (sem);</span><br><span class="line">    sem_post (sem);</span><br><span class="line">    sem_post (sem);</span><br><span class="line">    sem_post (sem);</span><br><span class="line">    sem_post (sem);</span><br><span class="line">    <span class="keyword">if</span> (sem_getvalue (sem, &amp;sem_value) != <span class="number">-1</span>) </span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;the sem value: %d\n&quot;</span>, sem_value);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sem_close (sem) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sem close posix_sem success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;wait for sem_unlink, 10s\n&quot;</span>);</span><br><span class="line">    sleep (<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sem_unlink (<span class="string">&quot;posix_sem&quot;</span>) != <span class="number">-1</span>) </span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sem_unlink posix_sem success!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="sem-sync-c"><a href="#sem-sync-c" class="headerlink" title="sem_sync.c"></a>sem_sync.c</h5><p>父子进程通过信号量实现同步</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEM_NAME <span class="meta-string">&quot;/posix_sem_operation&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret_fork;</span><br><span class="line">    <span class="keyword">int</span> sem_val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">sem_t</span> *sem;</span><br><span class="line">    sem = sem_open (SEM_NAME, O_CREAT, <span class="number">0666</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    ret_fork = fork ();</span><br><span class="line">    <span class="keyword">if</span> (ret_fork == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        sem_close (sem);</span><br><span class="line">        sem_unlink (SEM_NAME);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret_fork == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (i ++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            sem_wait (sem);</span><br><span class="line">            sem_getvalue (sem, &amp;sem_val);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;child process: sem value = %d\n&quot;</span>, sem_val);</span><br><span class="line">            sleep (<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret_fork &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (j ++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            sem_post (sem);</span><br><span class="line">            sem_getvalue (sem, &amp;sem_val);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;parent process: sem value = %d\n&quot;</span>, sem_val);</span><br><span class="line">            sleep (<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sem_close (sem);</span><br><span class="line">    sem_unlink (SEM_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="sem-post-c和sem-wait-c"><a href="#sem-post-c和sem-wait-c" class="headerlink" title="sem_post.c和sem_wait.c"></a>sem_post.c和sem_wait.c</h5><p>P操作: sem_wait()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *name = <span class="string">&quot;/posix_sem&quot;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sem_value = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">sem_t</span> *sem = sem_open (name, O_RDWR | O_CREAT, <span class="number">0777</span>, sem_value);</span><br><span class="line">    <span class="keyword">if</span> (sem == SEM_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;sem_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem open %s success\n&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sem_wait (sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;sem_wait&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span> (sem_getvalue (sem, &amp;sem_value) != <span class="number">-1</span>) </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;wait process: sem value = %d\n&quot;</span>, sem_value);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep (<span class="number">10</span>);</span><br><span class="line">    sem_close (sem);</span><br><span class="line">    <span class="keyword">if</span> (sem_unlink (name) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sem_unlink %s success\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>V操作：sem_post()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *name = <span class="string">&quot;/posix_sem&quot;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sem_value = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">sem_t</span> *sem = sem_open (name, O_RDWR | O_CREAT, <span class="number">0777</span>, sem_value);</span><br><span class="line">    <span class="keyword">if</span> (sem == SEM_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;sem_open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sem_open %s success\n&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sem_post (sem) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;sem_post&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sem_getvalue (sem, &amp;sem_value) != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;post process: sem value = %d\n&quot;</span>, sem_value);</span><br><span class="line">        &#125;</span><br><span class="line">        sleep (<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep (<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sem_unlink (name) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sem_unlink %s success\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="POSIX共享内存"><a href="#POSIX共享内存" class="headerlink" title="POSIX共享内存"></a>POSIX共享内存</h3><p>相关的API函数</p>
<p>• int shm_open (const char *name, int oflag, mode_t mode);</p>
<p>• int shm_unlink (const char *name);</p>
<p>• int ftruncate (int fd, off_t length);</p>
<p>• int fstat (int fd, struct stat *buf);</p>
<p>• void *mmap(void *addr, size_t length, int prot, int flags,int fd, off_t offset);</p>
<p>• int munmap (void *addr, size_t length);</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230505160011.png"></p>
<h4 id="编程实例-8"><a href="#编程实例-8" class="headerlink" title="编程实例"></a>编程实例</h4><h5 id="shm-write-c-1"><a href="#shm-write-c-1" class="headerlink" title="shm_write.c"></a>shm_write.c</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_NAME <span class="meta-string">&quot;/shm&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_fd;</span><br><span class="line">    shm_fd = shm_open (SHM_NAME, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;shm_open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ftruncate (shm_fd, <span class="number">8192</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">filestat</span>;</span></span><br><span class="line">    fstat (shm_fd, &amp;filestat);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;st_size: %ld\n&quot;</span>, filestat.st_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *shm_ptr;</span><br><span class="line">    shm_ptr = (<span class="keyword">char</span>*) mmap (<span class="literal">NULL</span>, filestat.st_size, \</span><br><span class="line">                    PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, <span class="number">0</span>);</span><br><span class="line">    close (shm_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[] = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    memmove (shm_ptr, buf, <span class="keyword">sizeof</span> (buf));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;pid %d: %s\n&quot;</span>, getpid(), shm_ptr);    </span><br><span class="line">    munmap (shm_ptr, filestat.st_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="shm-read-c-1"><a href="#shm-read-c-1" class="headerlink" title="shm_read.c"></a>shm_read.c</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_NAME <span class="meta-string">&quot;/shm&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_fd;</span><br><span class="line">    shm_fd = shm_open (SHM_NAME, O_RDWR | O_CREAT, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;shm_open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ftruncate (shm_fd, <span class="number">8192</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">filestat</span>;</span></span><br><span class="line">    fstat (shm_fd, &amp;filestat);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;st_size: %ld\n&quot;</span>, filestat.st_size);</span><br><span class="line">    <span class="keyword">char</span> *shm_ptr;</span><br><span class="line">    shm_ptr = (<span class="keyword">char</span>*) mmap (<span class="literal">NULL</span>, filestat.st_size, \</span><br><span class="line">        PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, <span class="number">0</span>);</span><br><span class="line">    close (shm_fd);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;pid %d: %s\n&quot;</span>, getpid(), shm_ptr);</span><br><span class="line">    munmap (shm_ptr, filestat.st_size);</span><br><span class="line">    shm_unlink (SHM_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="与信号量结合使用"><a href="#与信号量结合使用" class="headerlink" title="与信号量结合使用"></a>与信号量结合使用</h5><p>read_shm_sem.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_NAME <span class="meta-string">&quot;/memmap&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEM_NAME <span class="meta-string">&quot;/memmap_sem&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_fd = shm_open (SHM_NAME, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">sem_t</span> *sem = sem_open (SEM_NAME, O_CREAT, <span class="number">0666</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_fd &lt; <span class="number">0</span> || sem == SEM_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ftruncate (shm_fd, <span class="number">8192</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">filestat</span>;</span></span><br><span class="line">    fstat (shm_fd, &amp;filestat);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;st_size: %ld\n&quot;</span>, filestat.st_size);</span><br><span class="line">    <span class="keyword">char</span> *shm_ptr;</span><br><span class="line">    shm_ptr = (<span class="keyword">char</span>*) mmap (<span class="literal">NULL</span>, filestat.st_size, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, <span class="number">0</span>);    </span><br><span class="line">    <span class="keyword">if</span> (shm_ptr == (<span class="keyword">void</span>*) <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close (shm_fd);</span><br><span class="line">    sem_wait (sem);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;pid %d %s\n&quot;</span>, getpid(), shm_ptr);</span><br><span class="line">    sem_close (sem);</span><br><span class="line">    munmap (shm_ptr, <span class="number">8192</span>);</span><br><span class="line">    shm_unlink (SHM_NAME);</span><br><span class="line">    sem_unlink (SEM_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>write_shm_sem.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_NAME <span class="meta-string">&quot;/memmap&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEM_NAME <span class="meta-string">&quot;/memmap_sem&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shm_fd = shm_open (SHM_NAME, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">sem_t</span> *sem = sem_open (SEM_NAME, O_CREAT, <span class="number">0666</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_fd &lt; <span class="number">0</span> || sem == SEM_FAILED) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ftruncate (shm_fd, <span class="number">8192</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">filestat</span>;</span></span><br><span class="line">    fstat (shm_fd, &amp;filestat);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;st_size: %ld\n&quot;</span>, filestat.st_size);</span><br><span class="line">    <span class="keyword">char</span> *shm_ptr = (<span class="keyword">char</span>*) mmap (<span class="literal">NULL</span>, filestat.st_size, \</span><br><span class="line">                    PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, <span class="number">0</span>);</span><br><span class="line">    close (shm_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> msg[] = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    memmove (shm_ptr, msg, <span class="keyword">sizeof</span> (msg));</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;pid %d: %s\n&quot;</span>, getpid(), shm_ptr);</span><br><span class="line"></span><br><span class="line">    sem_post (sem);</span><br><span class="line">    sem_close (sem);</span><br><span class="line">    munmap (shm_ptr, <span class="number">8192</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="文件锁"><a href="#文件锁" class="headerlink" title="文件锁"></a>文件锁</h3><h4 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h4><p>优点</p>
<ul>
<li>在所有的IPC通信中效率最高</li>
</ul>
<p>缺点</p>
<ul>
<li><p>所有共享内存带来的问题：同步</p>
</li>
<li><p>解决方法</p>
<ul>
<li>System V 信号量</li>
<li>POSIX 信号量</li>
<li>文件锁：<ul>
<li>专门为文件设计的同步技术</li>
<li>适用于操作共享文件映射</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="什么是文件锁"><a href="#什么是文件锁" class="headerlink" title="什么是文件锁"></a>什么是文件锁</h4><ul>
<li><p>英文名：file lock，在同一时刻只允许一个进程对文件进行访问</p>
</li>
<li><p>建议性锁：advisory locking，又称协同锁</p>
<ul>
<li><p>内核只提供加减锁以及检测是否加锁，不提供锁的控制与协调工作</p>
</li>
<li><p> 需要多进程相互检测确认的加锁机制</p>
</li>
<li><p>A进程对一个操作的文件加了锁</p>
</li>
<li><p>B进程同样可以对该文件进行读写操作</p>
</li>
<li><p>只有当B进程也对该文件加锁，文件锁才能起到同步作用</p>
</li>
<li><p>Linux一般使用建议锁，而Windows一般使用强制性锁</p>
</li>
</ul>
</li>
<li><p>强制性锁：mandatory locking</p>
<ul>
<li>进程对文件进行I/O操作是，内核内部会检测该文件是否被加锁</li>
<li>A进程对一个操作的文件加了锁</li>
<li>当B进程对该文件进行I/O操作时，内核若检测该文件加了强制锁，B进程的操作则会失败</li>
</ul>
</li>
</ul>
<h4 id="系统调用：flock"><a href="#系统调用：flock" class="headerlink" title="系统调用：flock"></a>系统调用：flock</h4><ul>
<li><p>函数原型：int flock (int fd, int operation);</p>
</li>
<li><p>函数功能：给整个文件添加或解除一个<font color='9900CC'>建议锁</font></p>
</li>
<li><p>函数参数：operation</p>
<ul>
<li>LOCK_SH：共享锁</li>
<li>LOCK_EX：独占锁、排他锁</li>
<li>LOCK_UN：移除锁</li>
</ul>
</li>
<li><p>TIPS</p>
<ul>
<li><font color='9900CC'>flock只提供加锁、解锁机制，不提供锁检查</font></li>
<li>需要用户自己检测，达到多进程同步操作</li>
<li>用户若不自己检测，同样可以对一个已经加锁的文件进行读写操作</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, i;</span><br><span class="line">    <span class="keyword">char</span> filename[] = <span class="string">&quot;data.log&quot;</span>;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> errno;</span><br><span class="line">    fd = open (filename, O_WRONLY | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;open file %s success\n&quot;</span>, filename);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;pls input a num to lock the file.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span> (<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;try to lock the file...\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flock (fd, LOCK_EX) == <span class="number">0</span>) </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;lock file success\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;lock file failed!\n&quot;</span>);</span><br><span class="line">        write (fd, <span class="string">&quot;hello&quot;</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;input a sum to Unlock the file.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span> (<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">        <span class="keyword">if</span> (flock (fd, LOCK_UN) == <span class="number">0</span>) </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;file unlock success\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;file unlock failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="系统调用：fcntl"><a href="#系统调用：fcntl" class="headerlink" title="系统调用：fcntl"></a>系统调用：fcntl</h4><ul>
<li><p>函数原型：int fcntl (int fd, int cmd, … /* arg */ );</p>
</li>
<li><p>函数功能：给文件(部分文件)进行加锁、解锁操作</p>
</li>
<li><p>函数参数：cmd</p>
<ul>
<li>F_SETLK：非阻塞式申请锁</li>
<li>F_SETLKW：阻塞式申请锁</li>
<li>F_GETLK：获取锁的相关信息</li>
</ul>
</li>
<li><p>记录锁</p>
<ul>
<li>读锁F_RDLCK，写锁F_WRLCK，释放锁F_UNLCK</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230506155523.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fd = open (argv[<span class="number">1</span>], O_WRONLY | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">        <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror (<span class="string">&quot;open&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">flock</span> <span class="title">lock</span>;</span></span><br><span class="line">        lock.l_type = F_WRLCK;</span><br><span class="line">        lock.l_start = <span class="number">0</span>;</span><br><span class="line">        lock.l_whence = SEEK_SET;</span><br><span class="line">        lock.l_len = <span class="number">0</span>;</span><br><span class="line">        lock.l_pid = getpid ();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;trying lock %s ...\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">int</span> ret = fcntl (fd, F_SETLKW, &amp;lock);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;lock %s success\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="系统调用：lockf"><a href="#系统调用：lockf" class="headerlink" title="系统调用：lockf"></a>系统调用：lockf</h4><ul>
<li><p>函数原型：int lockf (int fd, int cmd, off_t len);</p>
</li>
<li><p>函数功能：</p>
<ul>
<li>可以更细粒度地对文件进行加锁、解锁操作</li>
<li>库函数lockf是对系统调用fcntl的封装</li>
</ul>
</li>
<li><p>函数参数：operation</p>
<ul>
<li>F_LOCK：对文件某一区域添加独占锁</li>
<li>F_TLOCK：非阻塞式申请锁</li>
<li>F_ULOCK：对文件某一区域解锁</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, ret;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    fd = open (<span class="string">&quot;tmp.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    ret = flock (fd, LOCK_EX);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;flock return ret: %d\n&quot;</span>, ret);</span><br><span class="line">    ret = lockf (fd, F_LOCK, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;lockf return ret: %d\n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">    sleep (<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="信号机制：signal"><a href="#信号机制：signal" class="headerlink" title="信号机制：signal"></a>信号机制：signal</h2><h3 id="信号-signal"><a href="#信号-signal" class="headerlink" title="信号(signal)"></a>信号(signal)</h3><ul>
<li><p>又叫：软中断信号，是一种异步通信的IPC</p>
</li>
<li><p>类似于硬件中断，可以将一个事件以信号形式通知给进程</p>
</li>
<li><p>给一个指定进程发送一个信号</p>
<ul>
<li>信号只是告诉进程发生了什么事，并不传递数据</li>
<li>进程表的表项中有一个软中断信号域，有信号发给该进程，对应位置位</li>
<li>进程根据接收信号类型作相应的处理</li>
</ul>
</li>
</ul>
<h3 id="信号的来源"><a href="#信号的来源" class="headerlink" title="信号的来源"></a>信号的来源</h3><ul>
<li><p>来自shell终端用户输入的各种信号：ctrl + C/D</p>
</li>
<li><p>来自其它进程或者进程本身发送的信号</p>
</li>
<li><p>来自系统内部的信号</p>
<ul>
<li>硬件异常：如SIGBUS表示总线错误、SIGSEGV表示段错误</li>
<li>终端相关的信号</li>
<li>软件事件相关的信号</li>
</ul>
</li>
</ul>
<h3 id="一个进程对信号的处理方式"><a href="#一个进程对信号的处理方式" class="headerlink" title="一个进程对信号的处理方式"></a>一个进程对信号的处理方式</h3><ul>
<li><p>缺省行为</p>
<ul>
<li>忽略信号：如SIGIGN、SIGCHLD<ul>
<li>SIGKILL/SIGSTOP比较特殊，不能忽略，所有进程都要在OS管控之下</li>
</ul>
</li>
<li>终止进程：SIGTERM、SIGINT、SIGHUP</li>
<li>终止进程并内核转储：SIGBUS、SIGABRT、SIGQUIT</li>
</ul>
</li>
<li><p>捕获信号并执行信号注册的handler</p>
<ul>
<li>通过<font color='red'>signal</font>系统调用可以改变信号的处理行为，即注册新的handler</li>
<li>当有信号到来时，信号的处理类似于中断程序</li>
<li>暂停当前进程正在执行的代码、跳到注册的回调函数handler执行</li>
<li>函数返回，回到当前进程捕获信号的地方继续执行</li>
<li>若该信号没有注册回调函数，采用默认操作：忽略或终止进程</li>
</ul>
</li>
</ul>
<h3 id="信号相关API"><a href="#信号相关API" class="headerlink" title="信号相关API"></a>信号相关API</h3><ul>
<li><p>typedef void (*sighandler_t)(int);</p>
</li>
<li><p>sighandler_t signal (int signum, sighandler_t handler);</p>
</li>
<li><p>int kill (pid_t pid, int sig);</p>
<ul>
<li>通过signal注册信号处理函数</li>
<li>进程之间通过kill发送软中断信号</li>
<li>内核也可以因内部异常等事件给进程发信号</li>
</ul>
</li>
</ul>
<h4 id="系统调用：signal"><a href="#系统调用：signal" class="headerlink" title="系统调用：signal"></a>系统调用：signal</h4><ul>
<li><p>函数原型：sighandler_t signal (int signum, sighandler_t handler);</p>
</li>
<li><p>函数功能：注册一个信号处理函数</p>
</li>
<li><p>函数参数</p>
<ul>
<li>signum：信号值，定义在：asm/signal.h 头文件中，很多信号跟体系相关</li>
<li>handler：信号对应的处理函数</li>
<li>Linux支持的信号列表</li>
</ul>
</li>
</ul>
<p>signal.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span> <span class="params">(<span class="keyword">int</span> signo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGHUP signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGINT signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGQUIT signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    signal (SIGHUP, handler);</span><br><span class="line">    signal (SIGINT, handler);</span><br><span class="line">    signal (SIGQUIT, handler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        kill (<span class="number">3486424</span>, <span class="number">2</span>);</span><br><span class="line">        sleep (<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="系统调用：kill"><a href="#系统调用：kill" class="headerlink" title="系统调用：kill"></a>系统调用：kill</h4><p>• 函数原型：int kill (pid_t pid, int sig);</p>
<p>• 函数功能：给指定进程发送一个信号</p>
<h4 id="系统调用：pause"><a href="#系统调用：pause" class="headerlink" title="系统调用：pause"></a>系统调用：pause</h4><p>• 函数原型：int pause (void);</p>
<p>• 函数功能：将当前进程挂起睡眠，等待某一个信号，直到信号到来，恢复运行</p>
<p>• 返回值：该函数总是返回-1</p>
<h3 id="定时发送信号"><a href="#定时发送信号" class="headerlink" title="定时发送信号"></a>定时发送信号</h3><h4 id="系统调用：alarm"><a href="#系统调用：alarm" class="headerlink" title="系统调用：alarm"></a>系统调用：alarm</h4><p>• 函数原型：unsigned int alarm(unsigned int seconds);</p>
<p>• 函数功能：给当前进程在指定的seconds秒后发送一次SIGALRM信号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal_handler</span> <span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;catch a signal %d \n&quot;</span>, unused);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    signal (SIGALRM, signal_handler);</span><br><span class="line">    alarm (<span class="number">5</span>);</span><br><span class="line">    pause ();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main exit!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="系统调用：setitimer"><a href="#系统调用：setitimer" class="headerlink" title="系统调用：setitimer"></a>系统调用：setitimer</h4><ul>
<li><p>int getitimer (int which, struct itimerval *curr_value);</p>
</li>
<li><p>int setitimer (int which, const struct itimerval *new_value, struct itimerval *old_value);</p>
</li>
<li><p>函数功能：获取定时器状态、设置定时器，周期发送信号</p>
</li>
<li><p>函数参数：which，指定三个内部定时器中的一个</p>
<ul>
<li>ITIMER_REAL：按实际时间计时，计时到达给进程发送SIGALRM信号</li>
<li>ITIMER_VIRTUAL：当进程执行时才计时，到期后发送SIGVTALRM信号</li>
<li>ITIMER_PROF：当进程执行或系统为该进程执行动作时都计时，如统计进程在用户态和内核态所花的时间，到期后发送SIGPROF信号给进程</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal_handler</span> <span class="params">(<span class="keyword">int</span> signum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (signum)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGALRM:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;catch a signal: SIGALRM\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGVTALRM:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;catch a signal: SIGVTALRM\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> <span class="title">value</span>,<span class="title">old_value</span>, <span class="title">value2</span>;</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;process id: %d\n&quot;</span>, getpid());</span><br><span class="line">    signal (SIGALRM, signal_handler);</span><br><span class="line">    signal (SIGVTALRM, signal_handler);</span><br><span class="line"></span><br><span class="line">    value.it_value.tv_sec = <span class="number">5</span>;</span><br><span class="line">    value.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line">    value.it_interval.tv_sec = <span class="number">1</span>;</span><br><span class="line">    value.it_interval.tv_usec = <span class="number">0</span>;</span><br><span class="line">    setitimer (ITIMER_REAL, &amp;value, &amp;old_value);</span><br><span class="line"></span><br><span class="line">    value2.it_value.tv_sec = <span class="number">10</span>;</span><br><span class="line">    value2.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line">    value2.it_interval.tv_sec = <span class="number">1</span>;</span><br><span class="line">    value2.it_interval.tv_usec = <span class="number">0</span>;</span><br><span class="line">    setitimer (ITIMER_VIRTUAL, &amp;value2, &amp;old_value);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// for(;;);</span></span><br><span class="line">       sleep (<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="编写安全的信号处理函数"><a href="#编写安全的信号处理函数" class="headerlink" title="编写安全的信号处理函数"></a>编写安全的信号处理函数</h3><h4 id="信号的本质"><a href="#信号的本质" class="headerlink" title="信号的本质"></a>信号的本质</h4><ul>
<li>是一种软中断，中断有优先级，信号也有优先级</li>
<li>信号处理函数类似于中断处理函数</li>
<li>信号也可以随时打断当前正在运行的进程，去执行信号处理函数</li>
</ul>
<h4 id="编程要点"><a href="#编程要点" class="headerlink" title="编程要点"></a>编程要点</h4><ul>
<li><p>重入：可能在任何时刻、任意地点打断当前进程的执行</p>
</li>
<li><p>尽量不要在处理函数中修改全局数据</p>
</li>
<li><p>尽量使用可重入函数，被打断的进程可能正在调用不可重入函数</p>
</li>
<li><p>难点：很难写出一个安全地、可重入的信号处理程序</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum ;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span> <span class="params">(<span class="keyword">int</span> count)</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i from <span class="number">0</span> to count)</span><br><span class="line">        sum = sum + i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="可重入与线程安全"><a href="#可重入与线程安全" class="headerlink" title="可重入与线程安全"></a>可重入与线程安全</h4><ul>
<li><p>可重入函数一定是线程安全的</p>
</li>
<li><p><font color='9900CC'>不可重入函数通过加锁访问全局变量，也是线程安全的</font>，但仍是不可重入的</p>
</li>
<li><p>如果一个函数对于信号处理来说是可重入的，则称其为异步信号安全函数，可重入函数跟信号安全函数可以看做等价的</p>
</li>
<li><p>线程安全的函数，不一定是异步信号安全的</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230507093955.png"></p>
<h4 id="可重入函数安全列表"><a href="#可重入函数安全列表" class="headerlink" title="可重入函数安全列表"></a>可重入函数安全列表</h4><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230507094800.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230507094834.png"></p>
<h3 id="信号底层API：sigaction"><a href="#信号底层API：sigaction" class="headerlink" title="信号底层API：sigaction"></a>信号底层API：sigaction</h3><h4 id="标准信号及其不可靠性"><a href="#标准信号及其不可靠性" class="headerlink" title="标准信号及其不可靠性"></a>标准信号及其不可靠性</h4><ul>
<li><p>标准信号</p>
<ul>
<li>1~31号信号，也叫不可靠信号，继承UNIX信号，采用位图管理</li>
<li>如果同时来相同的信号来不及处理，内核会丢弃掉</li>
</ul>
</li>
<li><p>实时信号</p>
<ul>
<li>32~64号信号，是可靠的，采用队列管理</li>
<li>来一次，处理一次，转发一次</li>
</ul>
</li>
</ul>
<h4 id="内核对信号的处理"><a href="#内核对信号的处理" class="headerlink" title="内核对信号的处理"></a>内核对信号的处理</h4><ul>
<li><p>A进程向B进程发送一个信号，内核会首先收到该信号，然后发给B进程，在发送给B进程之前，内核负责管理这些信号</p>
</li>
<li><p>对于不可靠信号，内核采用位图标记，给该信号分配sigqueue结构体，挂入链表之中，并将位图中的对应位置一；此时若有相同的信号发来，因为对应位已经置一，因此内核会丢弃该信号</p>
</li>
<li><p>对于可靠信号，内核采用队列管理：给该信号分配一个sigqueue结构体，并挂入到链表队列之中</p>
</li>
<li><p>队列中信号的个数也是有限制的，超过默认值，可靠信号也会丢失，也就变得不可靠了。</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span> <span class="params">(<span class="keyword">int</span> signo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (signo)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGHUP:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGHUP signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGINT signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGQUIT:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGQUIT signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGUSR1:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get a SIGUSR1 signal: %d\n&quot;</span>, signo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;unknow signal\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)   <span class="comment">//delay </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++)</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;handler exit with signo: %d\n&quot;</span>, signo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal (SIGHUP, handler);</span><br><span class="line">    signal (SIGINT, handler);</span><br><span class="line">    signal (SIGQUIT, handler);</span><br><span class="line">    signal (SIGUSR1, handler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//test 1:</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"><span class="comment">//test 2:</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"><span class="comment">// run:  kill -INT  22380</span></span><br><span class="line"><span class="comment">// run:  kill -QUIT  22380</span></span><br><span class="line"><span class="comment">// run:  kill -USR1  22380</span></span><br><span class="line"><span class="comment">// run:  kill -HUP  22380</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="信号底层注册函数"><a href="#信号底层注册函数" class="headerlink" title="信号底层注册函数"></a>信号底层注册函数</h4><ul>
<li><p>函数原型：int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);</p>
</li>
<li><p>函数功能：给信号设置新的注册函数act，同时保留原有的信号处理函数在oldact</p>
<ul>
<li><p>执行某些信号时屏蔽某些信号，直接给sa_mask赋值即可</p>
</li>
<li><p>处理带参数的信号</p>
</li>
<li><p>一次注册，长期有效</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*sa_handler)(<span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">void</span> (*sa_sigaction)(<span class="keyword">int</span>, <span class="keyword">siginfo_t</span> *, <span class="keyword">void</span> *);</span><br><span class="line">    <span class="keyword">sigset_t</span> sa_mask;</span><br><span class="line">    <span class="keyword">int</span> sa_flags;</span><br><span class="line">    <span class="keyword">void</span> (*sa_restorer)(<span class="keyword">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal_handler</span> <span class="params">(<span class="keyword">int</span> signum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;signal_handler\n&quot;</span>);</span><br><span class="line">    <span class="keyword">switch</span> (signum)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGHUP:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGHUP\n&quot;</span>);</span><br><span class="line">            sleep (<span class="number">20</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGINT\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGQUIT:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGQUIT\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGUSR1:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGUSR1\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;undefined signal\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal_sigaction</span> <span class="params">(<span class="keyword">int</span> signum, <span class="keyword">siginfo_t</span> *parm, <span class="keyword">void</span> *parm2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;signal_sigaction\n&quot;</span>);</span><br><span class="line">    <span class="keyword">switch</span> (signum)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGHUP:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGHUP\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGINT:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGINT\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGQUIT:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGQUIT\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGUSR1:</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;get signal: SIGUSR1\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;received data: %d\n&quot;</span>, parm-&gt;si_value);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sending signal process pid : %d\n&quot;</span>, parm-&gt;si_pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>, <span class="title">old_act</span>;</span></span><br><span class="line">    act.sa_sigaction = signal_sigaction;</span><br><span class="line">    act.sa_handler = signal_handler;</span><br><span class="line">    sigemptyset (&amp;act.sa_mask);</span><br><span class="line">    sigaddset (&amp;act.sa_mask, SIGUSR1);</span><br><span class="line">    act.sa_flags = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//sa_flags must be set,or it will cause core dump</span></span><br><span class="line">        <span class="comment">//set 0 may cause signal losing</span></span><br><span class="line">        <span class="comment">//act.sa_flags = SA_RESETHAND | SA_NODEFER;</span></span><br><span class="line">        <span class="comment">//SA_RESETHAND: restore signal action to DEF</span></span><br><span class="line">        <span class="comment">//SA_SIGINFO: use sa_sigaction as signal handler</span></span><br><span class="line">        <span class="comment">//SA_NODEFER: umask sa_mask</span></span><br><span class="line"></span><br><span class="line">    sigaction (SIGHUP, &amp;act, &amp;old_act);</span><br><span class="line"><span class="comment">//	sigaction (SIGINT, &amp;act, &amp;old_act);</span></span><br><span class="line"><span class="comment">//	sigaction (SIGQUIT, &amp;act, &amp;old_act);</span></span><br><span class="line"><span class="comment">//	sigaction (SIGUSR1, &amp;act, &amp;old_act);</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="新的信号发送函数"><a href="#新的信号发送函数" class="headerlink" title="新的信号发送函数"></a>新的信号发送函数</h4><ul>
<li><p>函数原型：int sigqueue (pid_t pid, int sig, const union sigval value);</p>
</li>
<li><p>函数功能：</p>
<ul>
<li>用法与kill类似</li>
<li>与kill不同之处：kill可以将 pid 设置为指定负值，向整个进程发送信号</li>
<li>可以给指定进程传递一个int型数据</li>
<li>sigaction 和 sigqueue 是一对 CP</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">sigval</span> <span class="title">val</span>;</span></span><br><span class="line">    val.sival_int = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = atoi (argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (sigqueue (pid, SIGHUP, val) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;sigqueue&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;current pid: %d\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h4 id="小结-6"><a href="#小结-6" class="headerlink" title="小结"></a>小结</h4><ul>
<li><p>一旦给信号安装了handler，它就一直有效</p>
</li>
<li><p>信号的handler存在并发访问、可重入问题</p>
</li>
<li><p>在信号的handler运行期间，可能会阻塞掉当前本身相同的信号</p>
</li>
<li><p>在handler运行期间，当前信号的多次提交可能被丢弃，只保留一次</p>
</li>
<li><p>除了本身信号是被阻塞的，可以通过设置，阻塞设定的一些信号</p>
</li>
<li><p>signal是标准C定义的函数，而sigaction是POSIX接口函数</p>
</li>
<li><p>Signal是对sigaction的封装</p>
</li>
<li><p>不同的架构、操作系统对信号的value、default action 可能不一样</p>
</li>
<li><p>特殊的两个信号：SIGKILL和SIGSTOP</p>
<ul>
<li>不能被忽略</li>
<li>不能安装signal handler、不能被捕捉</li>
<li>不能被阻塞</li>
</ul>
</li>
</ul>
<h2 id="Linux新增API"><a href="#Linux新增API" class="headerlink" title="Linux新增API"></a>Linux新增API</h2><h3 id="signalfd"><a href="#signalfd" class="headerlink" title="signalfd"></a>signalfd</h3><h4 id="信号通信机制优缺点"><a href="#信号通信机制优缺点" class="headerlink" title="信号通信机制优缺点"></a>信号通信机制优缺点</h4><p>• 在软件层次上是对中断机制的一种模拟</p>
<p>• 信号是进程间通信中唯一的“异步通信机制”</p>
<p>• 带来的弊端：数据的并发访问、可重入问题</p>
<p>• 解决方案：将信号抽象为文件，将信号转化为I/O文件操作</p>
<h4 id="signalfd-1"><a href="#signalfd-1" class="headerlink" title="signalfd"></a>signalfd</h4><p>• 将信号抽象为一个文件描述符</p>
<p>• 将信号的异步处理转换为文件的I/O操作</p>
<p>• 当有信号发生时，可以对其read</p>
<p>• 每次read都会阻塞、直到signalfd指定的信号到来</p>
<p>• 也可以将信号的监听放到select、poll、epoll等监听队列中</p>
<ul>
<li><p>函数原型：int signalfd(int fd, const sigset_t *mask, int flags);</p>
</li>
<li><p>函数功能：创建一个可以对信号进行I/O访问的文件描述符</p>
</li>
<li><p>函数参数：</p>
<ul>
<li>mask：进程想通过文件描述符接收的信号集</li>
<li>flags：<ul>
<li>SFD_NONBLOCK：</li>
<li>SFD_CLOEXEC：</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/signalfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    <span class="keyword">do</span> &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_signal</span> <span class="params">(struct signalfd_siginfo *siginfo)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;read signal: %d\n&quot;</span>, siginfo-&gt;ssi_signo);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sending process PID: %d\n&quot;</span>, siginfo-&gt;ssi_pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask;</span><br><span class="line">    <span class="keyword">int</span> signal_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">signalfd_siginfo</span> <span class="title">siginfo</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> read_len;</span><br><span class="line"></span><br><span class="line">    sigemptyset (&amp;mask);</span><br><span class="line">    sigaddset (&amp;mask, SIGINT);</span><br><span class="line">    sigaddset (&amp;mask, SIGQUIT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sigprocmask (SIG_BLOCK, &amp;mask, <span class="literal">NULL</span>) == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;sigpromask&quot;</span>);</span><br><span class="line">    signal_fd = signalfd (<span class="number">-1</span>, &amp;mask, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (signal_fd == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;signalfd&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        read_len = read (signal_fd, &amp;siginfo, <span class="keyword">sizeof</span> (struct signalfd_siginfo));</span><br><span class="line">        <span class="keyword">if</span> (read_len != <span class="keyword">sizeof</span> (struct signalfd_siginfo))</span><br><span class="line">            handle_error (<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (siginfo.ssi_signo == SIGINT)</span><br><span class="line">            print_signal (&amp;siginfo);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (siginfo.ssi_signo == SIGQUIT) </span><br><span class="line">            print_signal (&amp;siginfo);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (siginfo.ssi_signo == SIGHUP) <span class="comment">// 这里永远不会执行</span></span><br><span class="line">            print_signal (&amp;siginfo);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;Read unexpect signal!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;for loop\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="timerfd"><a href="#timerfd" class="headerlink" title="timerfd"></a>timerfd</h3><p>timerfd</p>
<ul>
<li><p>函数功能：通过文件I/O方式去获取定时器的通知事件</p>
</li>
<li><p>相关API：</p>
<ul>
<li>int timerfd_create(int clockid, int flags);</li>
<li>int timerfd_settime(int fd, int flags, const struct itimerspec *new_value, struct itimerspec *old_value);</li>
<li>int timerfd_gettime(int fd, sturct itimerspec *curr_value);</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    <span class="keyword">do</span>&#123;perror(msg);<span class="built_in">exit</span>(EXIT_FAILURE);&#125;<span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_time</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    gettimeofday (&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;current time: %ld.%ld\n&quot;</span>, tv.tv_sec, tv.tv_usec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">now</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (clock_gettime (CLOCK_REALTIME, &amp;now) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;clock_gettime&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerspec</span> <span class="title">new_value</span>;</span></span><br><span class="line">    new_value.it_value.tv_sec = now.tv_sec + <span class="number">10</span>; <span class="comment">// 10s later,timer will timeout</span></span><br><span class="line">    new_value.it_value.tv_nsec = now.tv_nsec;</span><br><span class="line">    new_value.it_interval.tv_sec = <span class="number">3</span>;  <span class="comment">//timer intelval</span></span><br><span class="line">    new_value.it_interval.tv_nsec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = timerfd_create (CLOCK_REALTIME, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;timerfd_creat&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (timerfd_settime(fd, TFD_TIMER_ABSTIME, &amp;new_value, <span class="literal">NULL</span>) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;timerfd_settime&quot;</span>);</span><br><span class="line"></span><br><span class="line">    print_time ();</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;timer started\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint64_t</span> tot_exp = <span class="number">0</span>; tot_exp &lt; <span class="number">20</span>;) <span class="comment">//timer run times: 20</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> <span class="built_in">exp</span>;</span><br><span class="line">        <span class="keyword">ssize_t</span> s = read (fd, &amp;<span class="built_in">exp</span>, <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>))</span><br><span class="line">            handle_error (<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        tot_exp += <span class="built_in">exp</span>;</span><br><span class="line">        print_time ();</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;read: %llu, total: %llu\n&quot;</span>, <span class="built_in">exp</span>, tot_exp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="eventfd"><a href="#eventfd" class="headerlink" title="eventfd"></a>eventfd</h3><p>eventfd API</p>
<ul>
<li><p>int eventfd(unsigned int initval, int flags);</p>
<ul>
<li>用来创建一个用于事件通知的eventfd对象</li>
<li>返回值为一个int型fd，用来引用打开的对象</li>
<li>打开的对象在内核中是一个64位的无符号整型计数器，初始化为initval</li>
<li>计数器数据类型：typedef uint64_t eventfd_t</li>
</ul>
</li>
<li><p>flags:</p>
<ul>
<li>EFD_CLOEXEC：类似于open的flags，fork子进程时不继承</li>
<li>EFD_NONBLOCK：一般会设置成非阻塞</li>
<li>EFD_SEMAPHORE：信号量语义的read，每次读操作，计时器值减1</li>
</ul>
</li>
<li><p>内核实现：fs/eventfd.c</p>
</li>
</ul>
<p>eventfd操作API</p>
<ul>
<li><p>read/eventfd_read</p>
<ul>
<li>读操作将64位的计数器置0</li>
<li>如果有EFD_SEMAPHORE标记，计数器值减1</li>
</ul>
</li>
<li><p>如果计数器值为零，继续读的话，可能会阻塞或非阻塞</p>
</li>
<li><p>write/eventfd_write：</p>
<ul>
<li>设置计数器的值</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/eventfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) \</span></span><br><span class="line">    <span class="keyword">do</span> &#123;perror (msg); <span class="built_in">exit</span> (EXIT_FAILURE); &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd_event, j;</span><br><span class="line">    <span class="keyword">uint64_t</span> u;</span><br><span class="line">    <span class="keyword">ssize_t</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;num&gt;...\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    fd_event = eventfd (<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd_event == <span class="number">-1</span>) </span><br><span class="line">        handle_error (<span class="string">&quot;eventfd&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (fork()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            sleep (<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; argc; j ++) &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;Child writing %s to fd_event\n&quot;</span>, argv[j]);</span><br><span class="line">                u = strtoull (argv[j], <span class="literal">NULL</span>, <span class="number">0</span>);    </span><br><span class="line">                s = write (fd_event, &amp;u, <span class="keyword">sizeof</span> (<span class="keyword">uint64_t</span>));</span><br><span class="line">                <span class="keyword">if</span> (s != <span class="keyword">sizeof</span> (<span class="keyword">uint64_t</span>)) </span><br><span class="line">                    handle_error (<span class="string">&quot;error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;Child completed write loop!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            sleep (<span class="number">2</span>);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;Parent about to read!\n&quot;</span>);</span><br><span class="line">            s = read (fd_event, &amp;u, <span class="keyword">sizeof</span> (<span class="keyword">uint64_t</span>));</span><br><span class="line">            <span class="keyword">if</span> (s != <span class="keyword">sizeof</span> (<span class="keyword">uint64_t</span>)) </span><br><span class="line">                handle_error (<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span> (<span class="string">&quot;Parent read %llu (0x%llx) from fd_event!\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) u, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) u);</span><br><span class="line">            <span class="built_in">exit</span> (EXIT_SUCCESS);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">            handle_error (<span class="string">&quot;fork&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="D-BUS总线简介及小结"><a href="#D-BUS总线简介及小结" class="headerlink" title="D-BUS总线简介及小结"></a>D-BUS总线简介及小结</h2><p>什么是D-BUS？</p>
<p>• 针对桌面环境，用于本地进程间通信的一种IPC机制</p>
<p>• 主要用于同一桌面会话中，不同桌面应用程序之间的通信</p>
<p>• 同时支持桌面会话与操作系统之间的通信</p>
<p>• 系统总线：system bus，用于内核和应用进程之间的通信和消息传递</p>
<p>• 会话总线：session bus，用于桌面(GNOME/KDE等)用户进程之间的通信。D-BUS一般由一个系统总线和几个会话总线构成</p>
<p>• 总线权限：只有Linux内核、Linux桌面环境和权限较高的应用进程才有权限向系统总线写入消息，安全性高</p>
<p>D-BUS组成</p>
<ul>
<li><p>Libdbus</p>
<ul>
<li>点对点的通信支持库，提供C语言API</li>
<li>不同进程可引用库的API进行通信</li>
</ul>
</li>
<li><p>dbus daemon</p>
<ul>
<li><p>D-BUS服务进程，基于libdbus，作用类似于总线</p>
</li>
<li><p>不同进程可以通过API连接它，发送和接收消息</p>
</li>
<li><p>支持一对一、一对多的通信</p>
</li>
</ul>
</li>
<li><p>基于libdbus的封装库或框架：</p>
<ul>
<li>Libdbus-glib、libdbus-qt</li>
<li>通过dbus binding，支持多种语言：C/C++、Java/Python、Perl、Ruby…</li>
<li>只要应用程序兼容dbus通信协议，可以支持任何语言</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508110906.png"></p>
<p>对象</p>
<ul>
<li><p>每个使用D-BUS的进程都包括一组对象，消息发送到或者发送自某一个对象，这些对象由对象路径唯一标识</p>
</li>
<li><p>D-BUS本质上是一个对等(p2p)协议：每个消息都有一个源和目的，这些地址被称为对象路径</p>
</li>
<li><p>每个对象支持一个或多个接口，一个接口是多个方法和信号的集合</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508111143.png"></p>
<p>在PC桌面环境中的应用</p>
<ul>
<li><p>给Linux桌面环境(GNOME、KDE等)提供的服务标准化</p>
</li>
<li><p>Android中的Dbus</p>
</li>
<li><p>Qt中的Dbus</p>
</li>
<li><p>越多越多的GUI开始支持/兼容Dbus…</p>
</li>
<li><p>例：Ubuntu16.04桌面环境</p>
<ul>
<li>Systemd—lightdm—upstart<ul>
<li>Dbus-daemon</li>
<li>Dcanf-service</li>
<li>Gnome-session-b</li>
<li>Gnome-terminal-bash-su</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="各种工具的比较"><a href="#各种工具的比较" class="headerlink" title="各种工具的比较"></a>各种工具的比较</h3><ul>
<li><p>无名管道：只能用于亲缘进程通信</p>
</li>
<li><p>有名管道：可用于任意两进程间通信，但只能传输流数据、缓冲区大小受限</p>
</li>
<li><p>消息队列：可以传输有格式字节流，但是效率低：系统调用产生的用户空间、内核空间转换的开销</p>
</li>
<li><p>共享内存：通信效率最高最快，解决了进程间通信运行效率低等开销问题，但是可能会带来同步问题</p>
</li>
<li><p>信号量：用来不同进程、线程之间的同步，与共享内存结合使用</p>
</li>
<li><p>文件锁：可以对整个文件、或者文件的一部分区域进行加锁</p>
</li>
<li><p>信号：唯一的异步通信、但是存在一系列的问题</p>
</li>
<li><p>Linux特有API：将异步通信操作转换为I/O操作</p>
</li>
<li><p>Dbus：桌面进程之间的通信</p>
</li>
<li><p>套接字：适用于不同机器进程间的通信，目前应用最广泛的</p>
</li>
</ul>
<h1 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h1><h2 id="多线程编程的概念"><a href="#多线程编程的概念" class="headerlink" title="多线程编程的概念"></a>多线程编程的概念</h2><p>关于多线程…</p>
<p>• 有了进程，为什么还要多线程？</p>
<p>• 多线程编程有哪些优点？</p>
<p>• 多线程编程主要用在什么地方？</p>
<p>• SMP、NUMA、MPP</p>
<p>• 多核、4核8线程</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508154211.png"></p>
<h3 id="进程、线程、协程"><a href="#进程、线程、协程" class="headerlink" title="进程、线程、协程"></a>进程、线程、协程</h3><p>• 提高程序运行效率</p>
<p>• 模块细分，防止程序阻塞</p>
<p>• 高并发、多核、服务器</p>
<p>• 线程池、协程</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508154244.png"></p>
<h2 id="多线程学习准备工作"><a href="#多线程学习准备工作" class="headerlink" title="多线程学习准备工作"></a>多线程学习准备工作</h2><h3 id="Pthread线程库"><a href="#Pthread线程库" class="headerlink" title="Pthread线程库"></a>Pthread线程库</h3><p>• 线程的实现: windows、Linux</p>
<p>• Pthread库: POSIX标准中的thread API</p>
<p>• Glibc 与 LinuxThread</p>
<p>• Glibc 与 NPTL</p>
<p>• $ getconf GNU_LIBPTHREAD_VERSION</p>
<p>在Linux中通常在用户空间实现对线程的支持</p>
<h3 id="Linux和Windows的API"><a href="#Linux和Windows的API" class="headerlink" title="Linux和Windows的API"></a>Linux和Windows的API</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508155311.png"></p>
<h3 id="使用pthread库"><a href="#使用pthread库" class="headerlink" title="使用pthread库"></a>使用pthread库</h3><ul>
<li><p>安装man手册</p>
<ul>
<li>$ apt install glibc-doc manpages-posix-dev</li>
</ul>
</li>
<li><p>程序的编译</p>
<ul>
<li>$ gcc main.c -lpthread</li>
<li>/usr/lib/libpthread.a</li>
</ul>
</li>
<li><p>pthread常用API </p>
<ul>
<li><p>pthread_create </p>
</li>
<li><p>pthread_exit</p>
</li>
<li><p>pthread_cancel</p>
</li>
<li><p>pthread_join</p>
</li>
<li><p>pthread_detach</p>
</li>
<li><p>pthread_mutex_lock</p>
</li>
<li><p>pthread_cond_init</p>
</li>
<li><p>pthread_cond_signal</p>
</li>
<li><p>pthread_cond_wait</p>
</li>
<li><p>pthread_rwlock_rdlock</p>
</li>
</ul>
</li>
</ul>
<h2 id="创建一个新线程：pthread-create"><a href="#创建一个新线程：pthread-create" class="headerlink" title="创建一个新线程：pthread_create"></a>创建一个新线程：pthread_create</h2><h3 id="API接口说明"><a href="#API接口说明" class="headerlink" title="API接口说明"></a>API接口说明</h3><ul>
<li><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span> <span class="params">(<span class="keyword">pthread_t</span> *thread, <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr, <span class="keyword">void</span> *(*start_routine)(<span class="keyword">void</span> *), <span class="keyword">void</span> *arg)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li><p>函数功能：创建一个新线程</p>
</li>
<li><p>参数说明：</p>
<ul>
<li>thread：指向线程ID的指针</li>
<li>attr： 线程的属性</li>
<li>start_routine：线程执行实体入口</li>
<li>arg： 传递给线程的参数</li>
<li>typedef unsigned long int pthread_t</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_start</span> <span class="params">(<span class="keyword">void</span> * arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> arg_data = *((<span class="keyword">int</span> *) arg);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">50000</span>; j ++);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;Receive arg %d = %d\n&quot;</span>, arg_data, arg_data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> arg1 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> arg2 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = pthread_create (&amp;tid, <span class="literal">NULL</span>, thread_start, (<span class="keyword">void</span> *) &amp; arg1);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        perror (<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    thread_start ((<span class="keyword">void</span>*) &amp;arg2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508162903.png"></p>
<h2 id="线程的终止"><a href="#线程的终止" class="headerlink" title="线程的终止"></a>线程的终止</h2><h3 id="终止线程的三种方式"><a href="#终止线程的三种方式" class="headerlink" title="终止线程的三种方式"></a>终止线程的三种方式</h3><ul>
<li><p>从start_routine正常return</p>
</li>
<li><p>显式调用 pthread_exit</p>
<ul>
<li>​    函数原型： void pthread_exit(void *retval);</li>
<li>返回值通过参数retval传递</li>
</ul>
</li>
<li><p>线程被 pthread_cancel取消</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_start</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> len = *(<span class="keyword">int</span>*) arg;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sub thread: sum = %d\n&quot;</span>, sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sub thread: exit !\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> arg = <span class="number">10</span>;</span><br><span class="line">    pthread_create (&amp;tid, <span class="literal">NULL</span>, thread_start, (<span class="keyword">void</span> *) &amp;arg);</span><br><span class="line">    sleep (<span class="number">5</span>);</span><br><span class="line">    pthread_cancel (tid);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread sum = %d\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread: exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="线程pthread-exit与exit的区别"><a href="#线程pthread-exit与exit的区别" class="headerlink" title="线程pthread_exit与exit的区别"></a>线程pthread_exit与exit的区别</h3><ul>
<li>线程调用pthread_exit，只会结束当前线程，不影响进程的运行</li>
<li>一个进程中的任何一个线程调用exit，将会结束整个进程</li>
</ul>
<h2 id="等待线程的终止"><a href="#等待线程的终止" class="headerlink" title="等待线程的终止"></a>等待线程的终止</h2><h3 id="线程分两种"><a href="#线程分两种" class="headerlink" title="线程分两种"></a>线程分两种</h3><ul>
<li><p>Joinable</p>
<ul>
<li>PTHREAD_CREATE_JOINABLE</li>
<li>可通过 pthread_join 等待线程终止</li>
<li>调用pthread_join 的线程会阻塞</li>
<li>一个Joinable线程结束时，资源不会自动释放给系统(堆栈、exit状态等)</li>
<li>当线程终止时， pthread_join 会回收该线程的资源，然后返回</li>
<li>若无pthread_join参与“擦屁股”工作，该线程将变为僵尸线程</li>
</ul>
</li>
<li><p>Unjoinable</p>
<ul>
<li>PTHREAD_CREATE_DETACHED</li>
<li>可通过 pthread_detach 分离一个线程</li>
<li>当线程终止时，资源会自动释放给系统</li>
<li>主线程不会阻塞</li>
</ul>
</li>
</ul>
<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><h4 id="pthread-join"><a href="#pthread-join" class="headerlink" title="pthread_join()"></a>pthread_join()</h4><ul>
<li>函数原型：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span> <span class="params">(<span class="keyword">pthread_t</span> thread, <span class="keyword">void</span> **retval)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>函数功能：阻塞掉当前线程，等待指定线程终止</p>
</li>
<li><p>函数终止： void pthread_exit (void *retval);</p>
</li>
<li><p>参数：</p>
<ul>
<li>thread：线程的ID</li>
<li>retval：从pthread_exit 返回的值</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_start</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> len = *(<span class="keyword">int</span> *) arg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        sum += <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sub thread: sum = %d\n&quot;</span>, sum);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sub thread: exit !\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> arg = <span class="number">10</span>;</span><br><span class="line">    pthread_create (&amp;tid, <span class="literal">NULL</span>, thread_start, (<span class="keyword">void</span> *) &amp;arg);</span><br><span class="line">    pthread_join (tid, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sum = %d\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread: exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508171832.png"></p>
<h4 id="pthread-detach"><a href="#pthread-detach" class="headerlink" title="pthread_detach()"></a>pthread_detach()</h4><ul>
<li>函数原型： </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_detach</span> <span class="params">(<span class="keyword">pthread_t</span> thread)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>函数功能：将指定线程与当前线程分离</p>
</li>
<li><p>参数说明：指定要分离的线程的ID</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_start</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    pthread_detach (pthread_self ());</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> len = *(<span class="keyword">int</span> *) arg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        sum += <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sub thread: sum = %d\n&quot;</span>, sum);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sub thread: exit !\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> arg = <span class="number">10</span>;</span><br><span class="line">    pthread_create (&amp;tid, <span class="literal">NULL</span>, thread_start, (<span class="keyword">void</span>*) &amp;arg);</span><br><span class="line">    <span class="comment">// pthread_detach (tid);</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sum = %d\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread: exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508174157.png"></p>
<h2 id="线程属性"><a href="#线程属性" class="headerlink" title="线程属性"></a>线程属性</h2><h3 id="默认属性"><a href="#默认属性" class="headerlink" title="默认属性"></a>默认属性</h3><ul>
<li><p>调度参数：</p>
</li>
<li><p>线程栈地址：</p>
</li>
<li><p>线程栈大小：8M</p>
</li>
<li><p>栈末尾警戒缓冲区大小：PAGESIZE</p>
</li>
<li><p>线程的分离状态：joinable、detached</p>
</li>
<li><p>继承性：PTHREAD_INHERIT_SCHED、PTHREAD_EXPLICIT_SCHED</p>
</li>
<li><p>作用域：PTHREAD_SCOPE_PROCESS、PTHREAD_SCOPE_SYSTEM </p>
</li>
<li><p>调度策略：SCHED_FIFO、SCHED_RR、SCHED_OTHER</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508174801.png"></p>
<h3 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h3><p>• int pthread_attr_init (pthread_attr_t *attr);</p>
<p>• int pthread_attr_destroy (pthread_attr_t *attr);</p>
<p>• int pthread_attr_setstacksize (pthread_attr_t *attr, size_t stacksize);</p>
<p>• int pthread_attr_getstacksize (const pthread_attr_t *attr, size_t *stacksize);</p>
<p>• int pthread_attr_setstackaddr (pthread_attr_t *attr, void *stackaddr);</p>
<p>• int pthread_attr_getstackaddr (const pthread_attr_t *attr, void **stackaddr);</p>
<p>• int pthread_attr_setdetachstate (pthread_attr_t *attr, int detachstate);</p>
<p>• int pthread_attr_getdetachstate (const pthread_attr_t *attr, int *detachstate);</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">thread_start</span> <span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = *(<span class="keyword">int</span>*)arg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;sub thead: sum = %d\n&quot;</span>, sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sub thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> arg = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_attr_t</span> attr;</span><br><span class="line">    status = pthread_attr_init (&amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (status != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror (<span class="string">&quot;pthread_attr_init&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span> (EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set/get thread stack size</span></span><br><span class="line">    <span class="keyword">int</span> stacksize = <span class="number">0</span>;</span><br><span class="line">    pthread_attr_getstacksize (&amp;attr, &amp;stacksize);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;stacksize = %d kb\n&quot;</span>, stacksize/<span class="number">1024</span>);</span><br><span class="line">    stacksize = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    pthread_attr_setstacksize (&amp;attr, stacksize);</span><br><span class="line">    stacksize = <span class="number">0</span>;</span><br><span class="line">    pthread_attr_getstacksize (&amp;attr, &amp;stacksize);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;stacksize = %d kb\n&quot;</span>, stacksize/<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get/set thread detach state</span></span><br><span class="line">    <span class="keyword">int</span> detachstate;</span><br><span class="line">    pthread_attr_getdetachstate (&amp;attr, &amp;detachstate);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;thread detach state: %d\n&quot;</span>, detachstate);</span><br><span class="line">    pthread_attr_setdetachstate (&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    <span class="comment">// pthread_attr_setdetachstate (&amp;attr, PTHREAD_CREATE_JOINABLE);</span></span><br><span class="line">    pthread_attr_getdetachstate (&amp;attr, &amp;detachstate);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;thread detach state: %d\n&quot;</span>, detachstate);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    pthread_create (&amp;tid, &amp;attr, thread_start, (<span class="keyword">void</span> *) &amp;arg);</span><br><span class="line">    pthread_attr_destroy (&amp;attr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pthread_join (tid, NULL);</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread: sum = %d\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="线程调度与运行"><a href="#线程调度与运行" class="headerlink" title="线程调度与运行"></a>线程调度与运行</h2><h3 id="线程分类"><a href="#线程分类" class="headerlink" title="线程分类"></a>线程分类</h3><ul>
<li>核心级线程<ul>
<li>由内核调度，有利于并发使用多核处理器资源</li>
</ul>
</li>
<li>用户级线程<ul>
<li>由用户层调度，减少上下文切换开销</li>
</ul>
</li>
<li>线程模型<ul>
<li>一对一模型</li>
<li>多对一模型</li>
<li>多对多模型</li>
</ul>
</li>
</ul>
<h3 id="一对一模型"><a href="#一对一模型" class="headerlink" title="一对一模型"></a>一对一模型</h3><p>• 用户线程通过LWP关联内核线程</p>
<p>• 线程调度由内核完成</p>
<p>• SMP、并发使用CPU资源</p>
<p>• 线程间同步由用户层完成</p>
<p>• Linux、Windows家族(XP之前)</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508211418.png"></p>
<h3 id="多对一模型"><a href="#多对一模型" class="headerlink" title="多对一模型"></a>多对一模型</h3><p>• 多个用户线程与一个内核线程关联</p>
<p>• 线程管理由用户完成、CPU仍以进程为调度单位</p>
<p>• 单处理器</p>
<p>• Solaris线程库：Green thread</p>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508211438.png"></p>
<h3 id="多对多模型"><a href="#多对多模型" class="headerlink" title="多对多模型"></a>多对多模型</h3><ul>
<li><p>内核线程为CPU调度单元</p>
</li>
<li><p>用户线程管理</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508211521.png"></p>
<h3 id="Linux下的线程"><a href="#Linux下的线程" class="headerlink" title="Linux下的线程"></a>Linux下的线程</h3><p>一对一线程模型</p>
<ul>
<li><p>一个轻量进程(LWP)对应一个线程，</p>
</li>
<li><p>每个LWP都与一个内核线程关联</p>
</li>
<li><p>内核线程，通过LWP绑定，调度用户线程</p>
</li>
<li><p>内核线程被阻塞，LWP也阻塞，用户线程也阻塞</p>
</li>
<li><p>调度由内核完成</p>
<ul>
<li>SCHED_OTHER：分时调度策略</li>
<li>SCHED_FIFO：实时调度策略：FIFO</li>
<li>SCHED_RR：实时调度策略：时间片轮转</li>
</ul>
</li>
<li><p><font color='9900CC'>创建线程、同步等API由用户线程库完成</font></p>
<ul>
<li><p>Linuxthreads：线程PID、信号处理存在不足</p>
</li>
<li><p>NPTL(Native POSIX Thread Library)</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508212114.png"></p>
<h3 id="LWP与普通用户进程比较"><a href="#LWP与普通用户进程比较" class="headerlink" title="LWP与普通用户进程比较"></a>LWP与普通用户进程比较</h3><ul>
<li><p>LWP只有一个最小的执行上下文和调度程序需要的统计信息</p>
</li>
<li><p>用户进程有独立地址空间，LWP与父进程共享地址空间</p>
</li>
<li><p>LWP可以像内核线程一样，全局范围内竞争处理器资源</p>
</li>
<li><p>LWP调度可以跟用户进程、内核线程一样调度</p>
</li>
<li><p>每一个用户进程可能有一个或多个LWP</p>
</li>
<li><p><font color='9900CC'>通过clone，各进程共享地址空间和资源</font></p>
<ul>
<li>CLONE_VM、 CLONE_FS</li>
<li>CLONE_FILES、CLONE_SIGHAND</li>
</ul>
</li>
<li><p>$ top -H -p &lt;pid&gt; </p>
</li>
<li><p>查看某个指定PID进程下的线程运行</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508212720.png"></p>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><h3 id="进程的虚拟地址空间"><a href="#进程的虚拟地址空间" class="headerlink" title="进程的虚拟地址空间"></a>进程的虚拟地址空间</h3><p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508213425.png"></p>
<h3 id="多进程下的资源访问"><a href="#多进程下的资源访问" class="headerlink" title="多进程下的资源访问"></a>多进程下的资源访问</h3><p>资源划分</p>
<ul>
<li><p>共享的资源</p>
<ul>
<li><p>代码段、数据段、地址空间</p>
</li>
<li><p>打开的文件、信号处理程序</p>
</li>
</ul>
</li>
<li><p>独占的资源</p>
<ul>
<li>程序计数器：PC</li>
<li>寄存器</li>
<li>栈空间<ul>
<li>不同体系不同分配方式</li>
<li>用户线程和管理线程栈是分离的</li>
</ul>
</li>
</ul>
</li>
<li><p>进程与线程资源</p>
<ul>
<li>一室一厅一卫</li>
<li>三室一厅一卫</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508213640.png"></p>
<h3 id="线程安全-1"><a href="#线程安全-1" class="headerlink" title="线程安全"></a>线程安全</h3><p>对共享资源的安全访问</p>
<ul>
<li><p>临界区与临界资源</p>
</li>
<li><p>关中断</p>
</li>
<li><p>锁、条件变量、读写锁</p>
</li>
</ul>
<p>函数引用</p>
<ul>
<li><p>可重入函数</p>
</li>
<li><p>线程安全函数</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230508213926.png"></p>
<h2 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h2><h3 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h3><p>竞争访问</p>
<ul>
<li><p>全局变量</p>
</li>
<li><p>缓冲区</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230509093355.png"></p>
<h4 id="相关API函数-1"><a href="#相关API函数-1" class="headerlink" title="相关API函数"></a>相关API函数</h4><p>• int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *mutexattr);</p>
<p>• int pthread_mutex_lock(pthread_mutex_t *mutex);</p>
<p>• int pthread_mutex_trylock(pthread_mutex_t *mutex);</p>
<p>• int pthread_mutex_unlock(pthread_mutex_t *mutex);</p>
<p>• int pthread_mutex_destroy(pthread_mutex_t *mutex);</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cake_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">produce_thread</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    cake_count = *(<span class="keyword">int</span> *)arg;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        cake_count += <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;produce thread: cake_count = %d\n&quot;</span>, cake_count);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        sleep (<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sub thread1: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">consume_thread</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> consume_unit = *(<span class="keyword">int</span> *) arg;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        <span class="keyword">if</span> (cake_count == <span class="number">0</span>) &#123;</span><br><span class="line">            pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cake_count -= consume_unit;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;consume thread consume 1: cake_count = %d\n&quot;</span>, cake_count);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;sub thread2 exit!\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init (&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> arg1 = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> arg2 = <span class="number">1</span>;</span><br><span class="line">    pthread_create (&amp;tid1, <span class="literal">NULL</span>, produce_thread, (<span class="keyword">void</span> *) &amp;arg1);</span><br><span class="line">    pthread_create (&amp;tid2, <span class="literal">NULL</span>, consume_thread, (<span class="keyword">void</span> *) &amp;arg2);</span><br><span class="line">    pthread_join (tid1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join (tid2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_destroy (&amp;mutex);</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread: exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230509111242.png"></p>
<h3 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p>互斥锁缺陷：</p>
<ul>
<li><p><strong>不断</strong>加锁解锁、查询满足条件，开销很大</p>
</li>
<li><p>加锁开销：用户态-内核态-用户态，阻塞在内核态</p>
</li>
<li><p>解锁开销：用户态-内核态-用户态，唤醒等待线程</p>
</li>
</ul>
<p>条件变量</p>
<ul>
<li>互斥锁(mutex)搭配使用，允许线程阻塞，等待条件满足的信号</li>
</ul>
<p>优势：</p>
<ul>
<li><p>将互斥锁和条件变量绑定</p>
</li>
<li><p>省去了不断加锁解锁的开销</p>
</li>
<li><p>可以使用广播(broadcast)唤醒所有绑定到该条件变量的线程</p>
</li>
</ul>
<h4 id="相关API函数-2"><a href="#相关API函数-2" class="headerlink" title="相关API函数"></a>相关API函数</h4><p>• pthread_cond_t cond = PTHREAD_COND_INITIALIZER;</p>
<p>• int pthread_cond_init (pthread_cond_t *cond, pthread_condattr_t *cond_attr);</p>
<p>• int pthread_cond_wait (pthread_cond_t *cond, pthread_mutex_t *mutex); </p>
<p>• int pthread_cond_signal (pthread_cond_t *cond); </p>
<p>• int pthread_cond_broadcast (pthread_cond_t *cond); </p>
<p>• int pthread_cond_timedwait (pthread_cond_t *cond, pthread_mutex_t *mutex, </p>
<p> const struct timespec *abstime);</p>
<p>• int pthread_cond_destroy (pthread_cond_t *cond);</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> current_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="keyword">pthread_cond_t</span>   cond = PTHREAD_COND_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">produce_thread</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count_init = * (<span class="keyword">int</span> *) arg;</span><br><span class="line">    current_count = count_init;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        current_count ++;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;produce thread: current_count = %d\n&quot;</span>, current_count);</span><br><span class="line">        <span class="keyword">if</span> (current_count % <span class="number">10</span> == <span class="number">0</span>) </span><br><span class="line">            pthread_cond_signal (&amp;cond);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        sleep (<span class="number">1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;produce thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">consume_thread</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> consume_unit = *(<span class="keyword">int</span> *) arg;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        pthread_cond_wait (&amp;cond, &amp;mutex); <span class="comment">// 释放锁，阻塞，等待条件满足时的信号</span></span><br><span class="line">        current_count -= <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;consume thread has consume: %d\n&quot;</span>, consume_unit);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;consume thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2;</span><br><span class="line">    pthread_mutex_init (&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">int</span> arg1 = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> arg2 = <span class="number">10</span>;</span><br><span class="line">    pthread_create (&amp;tid1, <span class="literal">NULL</span>, produce_thread, (<span class="keyword">void</span> *) &amp;arg1);</span><br><span class="line">    pthread_create (&amp;tid2, <span class="literal">NULL</span>, consume_thread, (<span class="keyword">void</span> *) &amp;arg2);</span><br><span class="line">    pthread_join (tid1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join (tid2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_destroy (&amp;mutex);</span><br><span class="line">    pthread_cond_destroy (&amp;cond);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread exit!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> current_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="keyword">pthread_cond_t</span>   cond = PTHREAD_COND_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">produce_thread</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count_init = * (<span class="keyword">int</span> *) arg;</span><br><span class="line">    current_count = count_init;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        current_count ++;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;produce thread: current_count = %d\n&quot;</span>, current_count);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        <span class="keyword">if</span> (current_count % <span class="number">20</span> == <span class="number">0</span>) </span><br><span class="line">            pthread_cond_broadcast (&amp;cond);</span><br><span class="line">        sleep (<span class="number">1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;produce thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">consume_thread</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> consume_unit = *(<span class="keyword">int</span> *) arg;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        pthread_cond_wait (&amp;cond, &amp;mutex); <span class="comment">// 释放锁，阻塞，等待条件满足时的信号</span></span><br><span class="line">        current_count -= <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;consume thread1 has consume: %d\n&quot;</span>, consume_unit);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;consume thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">consume_thread2</span> <span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> consume_unit = *(<span class="keyword">int</span> *) arg;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock (&amp;mutex);</span><br><span class="line">        pthread_cond_wait (&amp;cond, &amp;mutex); <span class="comment">// 释放锁，阻塞，等待条件满足时的信号</span></span><br><span class="line">        current_count -= <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;consume thread2 has consume: %d\n&quot;</span>, consume_unit);</span><br><span class="line">        pthread_mutex_unlock (&amp;mutex);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;consume thread: exit\n&quot;</span>);</span><br><span class="line">    pthread_exit (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2, tid3;</span><br><span class="line">    pthread_mutex_init (&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">int</span> arg1 = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> arg2 = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> arg3 = <span class="number">10</span>;</span><br><span class="line">    pthread_create (&amp;tid1, <span class="literal">NULL</span>, produce_thread, (<span class="keyword">void</span> *) &amp;arg1);</span><br><span class="line">    pthread_create (&amp;tid2, <span class="literal">NULL</span>, consume_thread, (<span class="keyword">void</span> *) &amp;arg2);</span><br><span class="line">    pthread_create (&amp;tid3, <span class="literal">NULL</span>, consume_thread2, (<span class="keyword">void</span> *) &amp;arg2);</span><br><span class="line">    pthread_join (tid1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join (tid2, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join (tid3, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_destroy (&amp;mutex);</span><br><span class="line">    pthread_cond_destroy (&amp;cond);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;main thread exit!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h2><h3 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h3><ul>
<li><p>互斥锁：同一时刻只允许一个线程读或写</p>
</li>
<li><p>读写锁</p>
<ul>
<li>允许多个读线程同时读</li>
<li>只允许一个线程写，写的时候会阻塞其它线程(包括读线程)</li>
<li>写优先级高于读</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sineagle/Pic_image/20230509213110.png"></p>
<p>相关API函数</p>
<p>• pthread_rwlock_t rwlock = PTHREAD_RWLOCK_INITIALIZER;</p>
<p>• pthread_rwlock_init (pthread_rwlock_t *restrict rwlock,</p>
<p> const pthread_rwlockattr_t *restrict attr);</p>
<p>• int pthread_rwlock_rdlock (pthread_rwlock_t *rwlock);</p>
<p>• int pthread_rwlock_wrlock (pthread_rwlock_t *rwlock);</p>
<p>• int pthread_rwlock_tryrdlock (pthread_rwlock_t *rwlock);</p>
<p>• int pthread_rwlock_trywrlock (pthread_rwlock_t *rwlock);</p>
<p>• int pthread_rwlock_unlock (pthread_rwlock_t *rwlock);</p>
<p>• int pthread_rwlock_destroy (pthread_rwlock_t *rwlock)</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>求大佬赏个饭</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/weichat.png" alt="sineagle 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/11/HIT-OS-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="prev" title="HIT-OS 内存管理">
      <i class="fa fa-chevron-left"></i> HIT-OS 内存管理
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/30/HIT-OS-%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%AE%A1%E7%90%86/" rel="next" title="HIT-OS 设备驱动管理与文件系统">
      HIT-OS 设备驱动管理与文件系统 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



			
          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8"><span class="nav-number">1.</span> <span class="nav-text">Linux 系统编程入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">什么是系统编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E8%8C%83%E7%95%B4"><span class="nav-number">1.1.1.</span> <span class="nav-text">系统编程范畴</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-number">1.1.2.</span> <span class="nav-text">系统调用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E4%BE%8B%E5%AD%90%EF%BC%88%E6%96%87%E4%BB%B6%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">一个系统编程例子（文件基本操作）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-cp-%E5%91%BD%E4%BB%A4"><span class="nav-number">1.3.</span> <span class="nav-text">实现 cp 命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%8EC%E6%A0%87%E5%87%86%E5%BA%93"><span class="nav-number">1.4.</span> <span class="nav-text">系统调用与C标准库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#strace-%E5%91%BD%E4%BB%A4"><span class="nav-number">1.5.</span> <span class="nav-text">strace 命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">1.6.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GNU%E7%BC%96%E7%A0%81%E9%A3%8E%E6%A0%BC"><span class="nav-number">1.7.</span> <span class="nav-text">GNU编码风格</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E9%A1%B6%E5%A4%B4%E5%86%99"><span class="nav-number">1.7.1.</span> <span class="nav-text">函数顶头写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E6%A0%BC"><span class="nav-number">1.7.2.</span> <span class="nav-text">空格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E9%BD%90"><span class="nav-number">1.7.3.</span> <span class="nav-text">对齐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D"><span class="nav-number">1.7.4.</span> <span class="nav-text">命名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux%E5%93%B2%E5%AD%A6%EF%BC%9A%E4%B8%80%E5%88%87%E7%9A%86%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.</span> <span class="nav-text">Linux哲学：一切皆文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%BF%E4%B9%89%E4%B8%8A%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.1.</span> <span class="nav-text">广义上的文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPS"><span class="nav-number">1.8.2.</span> <span class="nav-text">VPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">1.8.3.</span> <span class="nav-text">文件描述符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%EF%BC%9A%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8"><span class="nav-number">1.9.</span> <span class="nav-text">编程实战：音频播放器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6"><span class="nav-number">1.9.1.</span> <span class="nav-text">设备文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6"><span class="nav-number">1.9.2.</span> <span class="nav-text">常见的设备文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6-dsp"><span class="nav-number">1.9.3.</span> <span class="nav-text">设备文件 dsp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8F%AD%E5%BC%80%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1"><span class="nav-number">2.</span> <span class="nav-text">揭开文件系统的神秘面纱</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.1.</span> <span class="nav-text">文件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%9C%A8%E7%A3%81%E7%9B%98%E4%B8%8A%E7%9A%84%E5%AD%98%E5%82%A8"><span class="nav-number">2.2.</span> <span class="nav-text">文件在磁盘上的存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A3%81%E7%9B%98"><span class="nav-number">2.2.1.</span> <span class="nav-text">磁盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E5%8E%9F%E7%90%86"><span class="nav-number">2.2.2.</span> <span class="nav-text">磁盘原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E6%8E%A7%E5%88%B6%E5%99%A8%E9%A9%B1%E5%8A%A8"><span class="nav-number">2.2.3.</span> <span class="nav-text">磁盘控制器驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="nav-number">2.2.4.</span> <span class="nav-text">文件数据存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8"><span class="nav-number">2.2.5.</span> <span class="nav-text">文件信息存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E6%8A%BD%E8%B1%A1"><span class="nav-number">2.2.6.</span> <span class="nav-text">存储抽象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%9C%A8Flash%E4%B8%8A%E7%9A%84%E5%AD%98%E5%82%A8"><span class="nav-number">2.3.</span> <span class="nav-text">文件在Flash上的存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B4%A2%E5%BC%95%E7%BB%93%E7%82%B9%EF%BC%9Ainode"><span class="nav-number">2.4.</span> <span class="nav-text">文件索引结点：inode</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%9D%97"><span class="nav-number">2.4.1.</span> <span class="nav-text">逻辑块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E5%AD%98%E5%82%A8"><span class="nav-number">2.4.2.</span> <span class="nav-text">文件的存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BB%93%E7%82%B9%EF%BC%9Ainode"><span class="nav-number">2.4.3.</span> <span class="nav-text">索引结点：inode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BB%93%E7%82%B9%E8%A1%A8%EF%BC%88inode-table%EF%BC%89"><span class="nav-number">2.4.4.</span> <span class="nav-text">索引结点表（inode table）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-block"><span class="nav-number">2.4.5.</span> <span class="nav-text">data block</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E6%98%A0%E5%B0%84"><span class="nav-number">2.4.6.</span> <span class="nav-text">存储映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B6%85%E7%BA%A7%E5%9D%97%EF%BC%9Asuperblock"><span class="nav-number">2.5.</span> <span class="nav-text">超级块：superblock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="nav-number">2.5.1.</span> <span class="nav-text">磁盘格式化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E7%BB%84"><span class="nav-number">2.5.2.</span> <span class="nav-text">块组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%9C%A8%E7%A3%81%E7%9B%98%E4%B8%8A%E7%9A%84%E5%AD%98%E5%82%A8-1"><span class="nav-number">2.5.3.</span> <span class="nav-text">文件在磁盘上的存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E5%92%8C%E7%9B%AE%E5%BD%95%E9%A1%B9"><span class="nav-number">2.6.</span> <span class="nav-text">目录和目录项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90"><span class="nav-number">2.7.</span> <span class="nav-text">文件路径解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84"><span class="nav-number">2.7.1.</span> <span class="nav-text">文件路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="nav-number">2.7.2.</span> <span class="nav-text">绝对路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="nav-number">2.7.3.</span> <span class="nav-text">相对路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">2.7.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%8C%82%E8%BD%BD"><span class="nav-number">2.8.</span> <span class="nav-text">文件系统的挂载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C-%E7%9B%AE%E5%BD%95%E6%8C%82%E8%BD%BD"><span class="nav-number">2.8.1.</span> <span class="nav-text">实验-目录挂载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%82%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-number">2.8.2.</span> <span class="nav-text">挂载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90-1"><span class="nav-number">2.8.3.</span> <span class="nav-text">文件路径解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.9.</span> <span class="nav-text">文件系统的类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9AVFS"><span class="nav-number">2.10.</span> <span class="nav-text">虚拟文件系统：VFS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VFS"><span class="nav-number">2.10.1.</span> <span class="nav-text">VFS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VFS%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.10.2.</span> <span class="nav-text">VFS对象类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87OOP%E7%90%86%E8%A7%A3VFS"><span class="nav-number">2.10.3.</span> <span class="nav-text">通过OOP理解VFS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6-1"><span class="nav-number">2.11.</span> <span class="nav-text">文件描述符</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E4%B8%AD%E5%A6%82%E4%BD%95%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="nav-number">2.11.1.</span> <span class="nav-text">程序中如何操作文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E6%89%93%E5%BC%80%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">2.11.2.</span> <span class="nav-text">一个进程打开的文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8C%87%E9%92%88"><span class="nav-number">2.12.</span> <span class="nav-text">文件指针</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87C%E5%BA%93%E5%87%BD%E6%95%B0%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6"><span class="nav-number">2.12.1.</span> <span class="nav-text">通过C库函数操作文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%8C%87%E9%92%88FILE"><span class="nav-number">2.12.2.</span> <span class="nav-text">C语言中的文件指针FILE*</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E6%B5%81"><span class="nav-number">2.12.3.</span> <span class="nav-text">标准流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E9%93%BE%E6%8E%A5%E5%92%8C%E8%BD%AF%E9%93%BE%E6%8E%A5"><span class="nav-number">2.13.</span> <span class="nav-text">硬链接和软链接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5"><span class="nav-number">2.13.1.</span> <span class="nav-text">链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E9%93%BE%E6%8E%A5"><span class="nav-number">2.13.2.</span> <span class="nav-text">硬链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E9%93%BE%E6%8E%A5"><span class="nav-number">2.13.3.</span> <span class="nav-text">软链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">2.13.4.</span> <span class="nav-text">实验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%99%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%A1%AC%E9%93%BE%E6%8E%A5"><span class="nav-number">2.13.4.1.</span> <span class="nav-text">给文件创建一个硬链接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%99%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%BD%AF%E9%93%BE%E6%8E%A5"><span class="nav-number">2.13.4.2.</span> <span class="nav-text">给文件创建一个软链接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%92%8C%E7%A1%AC%E9%93%BE%E6%8E%A5%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.13.5.</span> <span class="nav-text">软链接和硬链接的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%A1%AC%E9%93%BE%E6%8E%A5%E4%B8%8D%E8%83%BD%E8%B7%A8%E8%B6%8A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%88%96%E5%88%86%E5%8C%BA%E5%88%9B%E5%BB%BA%EF%BC%9F-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%8F%AF%E4%BB%A5%E8%B7%A8%E8%B6%8A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%88%96%E5%88%86%E5%8C%BA%E5%88%9B%E5%BB%BA%EF%BC%9F"><span class="nav-number">2.13.5.1.</span> <span class="nav-text">为什么硬链接不能跨越文件系统或分区创建？ 为什么软链接可以跨越文件系统或分区创建？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E4%B8%8D%E8%83%BD%E5%AF%B9%E7%9B%AE%E5%BD%95%E5%88%9B%E5%BB%BA%E7%A1%AC%E9%93%BE%E6%8E%A5%EF%BC%9F"><span class="nav-number">2.13.5.2.</span> <span class="nav-text">为什么不能不能对目录创建硬链接？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="nav-number">2.14.</span> <span class="nav-text">一些命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%9F-FS-%E7%9B%B8%E5%85%B3"><span class="nav-number">2.14.1.</span> <span class="nav-text">跟 FS 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86"><span class="nav-number">2.14.2.</span> <span class="nav-text">磁盘管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="nav-number">2.14.3.</span> <span class="nav-text">文件管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%EF%BC%9A%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%8F%8A%E6%8C%82%E8%BD%BD"><span class="nav-number">2.15.</span> <span class="nav-text">实验：磁盘格式化及挂载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="nav-number">2.15.1.</span> <span class="nav-text">分区格式化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.15.2.</span> <span class="nav-text">安装文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%82%E8%BD%BD"><span class="nav-number">2.15.3.</span> <span class="nav-text">挂载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%EF%BC%9A%E6%81%A2%E5%A4%8D%E5%88%A0%E9%99%A4%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">2.16.</span> <span class="nav-text">实验：恢复删除的文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#rm-%E5%91%BD%E4%BB%A4%E2%80%A6"><span class="nav-number">2.16.1.</span> <span class="nav-text">rm 命令….</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="nav-number">2.16.2.</span> <span class="nav-text">真正的文件删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8D%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">2.16.3.</span> <span class="nav-text">删除恢复的文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E4%BB%B6IO%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98"><span class="nav-number">3.</span> <span class="nav-text">文件IO编程实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E6%89%93%E5%BC%80%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">文件的打开模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">3.1.1.</span> <span class="nav-text">文件的基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8open"><span class="nav-number">3.1.2.</span> <span class="nav-text">系统调用open</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E6%89%93%E5%BC%80%E6%A8%A1%E5%BC%8F-1"><span class="nav-number">3.1.3.</span> <span class="nav-text">文件的打开模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">3.1.4.</span> <span class="nav-text">使用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E5%85%B3%E9%97%AD"><span class="nav-number">3.1.5.</span> <span class="nav-text">文件的关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93%E5%88%9B%E5%BB%BA%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%96%87%E4%BB%B6%E6%97%B6"><span class="nav-number">3.1.6.</span> <span class="nav-text">当创建不存在的文件时</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%86%99%E6%9D%83%E9%99%90"><span class="nav-number">3.2.</span> <span class="nav-text">文件的读写权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E8%AF%BB%E5%86%99%E6%9D%83%E9%99%90"><span class="nav-number">3.2.1.</span> <span class="nav-text">修改读写权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%86%99%E5%87%BD%E6%95%B0"><span class="nav-number">3.3.</span> <span class="nav-text">文件的读写函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99"><span class="nav-number">3.3.1.</span> <span class="nav-text">文件读写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#read%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="nav-number">3.3.2.</span> <span class="nav-text">read函数解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E5%AE%9E%E7%8E%B0cat%E5%8A%9F%E8%83%BD"><span class="nav-number">3.3.3.</span> <span class="nav-text">编程实战实现cat功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%86%99%E4%BD%8D%E7%BD%AE%E5%92%8C%E5%AE%9A%E4%BD%8D"><span class="nav-number">3.4.</span> <span class="nav-text">文件的读写位置和定位</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%86%99%E4%BD%8D%E7%BD%AE"><span class="nav-number">3.4.1.</span> <span class="nav-text">文件的读写位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E5%8F%98%E6%96%87%E4%BB%B6%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="nav-number">3.4.2.</span> <span class="nav-text">改变文件偏移量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%A9%BA%E6%B4%9E"><span class="nav-number">3.4.3.</span> <span class="nav-text">文件空洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BF%A1%E6%81%AF"><span class="nav-number">3.5.</span> <span class="nav-text">获取文件的属性信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7"><span class="nav-number">3.5.1.</span> <span class="nav-text">文件属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">3.5.2.</span> <span class="nav-text">获取文件的元数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0shell%E5%91%BD%E4%BB%A4-ll"><span class="nav-number">3.6.</span> <span class="nav-text">实现shell命令: ll</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getpwuid%E5%87%BD%E6%95%B0"><span class="nav-number">3.6.1.</span> <span class="nav-text">getpwuid函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getgrgid%E5%87%BD%E6%95%B0"><span class="nav-number">3.6.2.</span> <span class="nav-text">getgrgid函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">3.6.3.</span> <span class="nav-text">文件元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B-%E6%9D%83%E9%99%90"><span class="nav-number">3.6.4.</span> <span class="nav-text">文件类型+权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%AE%8F"><span class="nav-number">3.6.5.</span> <span class="nav-text">测试宏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6"><span class="nav-number">3.7.</span> <span class="nav-text">读取目录文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6"><span class="nav-number">3.7.1.</span> <span class="nav-text">打开目录文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E9%A1%B9"><span class="nav-number">3.7.2.</span> <span class="nav-text">目录项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0ls%E5%91%BD%E4%BB%A4"><span class="nav-number">3.7.3.</span> <span class="nav-text">编程实现ls命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0ls%E5%91%BD%E4%BB%A4%EF%BC%9A%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA%E7%9B%AE%E5%BD%95"><span class="nav-number">3.8.</span> <span class="nav-text">实现ls命令：支持多个目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0ls%E5%91%BD%E4%BB%A4%EF%BC%9A%E6%94%AF%E6%8C%81-c%E5%8F%82%E6%95%B0"><span class="nav-number">3.9.</span> <span class="nav-text">实现ls命令：支持-c参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0ls%E5%91%BD%E4%BB%A4%EF%BC%9A%E6%94%AF%E6%8C%81-l%E5%8F%82%E6%95%B0"><span class="nav-number">3.10.</span> <span class="nav-text">实现ls命令：支持-l参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%9A%84%E5%85%B6%E5%AE%83%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">3.11.</span> <span class="nav-text">目录的其它相关操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="nav-number">3.11.1.</span> <span class="nav-text">目录操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C"><span class="nav-number">3.11.2.</span> <span class="nav-text">路径操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5-1"><span class="nav-number">3.11.3.</span> <span class="nav-text">链接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E8%BD%AC%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="nav-number">3.12.</span> <span class="nav-text">相对路径转绝对路径</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="nav-number">3.12.1.</span> <span class="nav-text">实现方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0shell%E5%91%BD%E4%BB%A4%EF%BC%9Apwd"><span class="nav-number">3.12.2.</span> <span class="nav-text">实现shell命令：pwd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E5%90%8D%E8%BD%AC%E6%8D%A2%E4%B8%BA%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84-%E6%96%87%E4%BB%B6%E5%90%8D%E7%9A%84%E5%BD%A2%E5%BC%8F"><span class="nav-number">3.12.3.</span> <span class="nav-text">将一个文件名转换为绝对路径+ 文件名的形式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%EF%BC%9A%E5%AE%9E%E7%8E%B0-wc-%E5%91%BD%E4%BB%A4"><span class="nav-number">3.13.</span> <span class="nav-text">编程实战：实现 wc 命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98"><span class="nav-number">3.13.1.</span> <span class="nav-text">编程实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">3.13.2.</span> <span class="nav-text">功能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.13.3.</span> <span class="nav-text">功能实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E4%BB%B6IO%E7%BC%93%E5%AD%98%E4%B8%8E%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84"><span class="nav-number">4.</span> <span class="nav-text">文件IO缓存与内存映射</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">4.1.</span> <span class="nav-text">缓存的基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E7%BC%93%E5%AD%98"><span class="nav-number">4.1.1.</span> <span class="nav-text">计算机中的缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I-O%E7%BC%93%E5%AD%98"><span class="nav-number">4.1.2.</span> <span class="nav-text">I&#x2F;O缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98-%E9%A1%B5%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E6%B5%81%E7%A8%8B"><span class="nav-number">4.2.</span> <span class="nav-text">页高速缓存-页缓存读写流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-number">4.2.1.</span> <span class="nav-text">内核中的缓冲区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98"><span class="nav-number">4.2.2.</span> <span class="nav-text">页高速缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E7%BC%93%E5%AD%98%E5%92%8C%E8%AF%BB%E5%86%99"><span class="nav-number">4.2.3.</span> <span class="nav-text">页缓存和读写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F"><span class="nav-number">4.2.4.</span> <span class="nav-text">同步方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C-%E9%A1%B5%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E5%AE%9E%E9%AA%8C"><span class="nav-number">4.2.5.</span> <span class="nav-text">实验-页缓存读写实验</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">4.3.</span> <span class="nav-text">页高速缓存-内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">4.3.1.</span> <span class="nav-text">物理内存管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%99%E4%BC%B4%E7%AE%97%E6%B3%95"><span class="nav-number">4.3.2.</span> <span class="nav-text">伙伴算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7"><span class="nav-number">4.3.3.</span> <span class="nav-text">内存申请</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">4.3.4.</span> <span class="nav-text">Linux虚拟地址空间</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98-%E9%A1%B5%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.4.</span> <span class="nav-text">页高速缓存-页缓存的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E7%BC%93%E5%AD%98%E5%AF%B9%E8%B1%A1%EF%BC%9A%E5%B1%9E%E6%80%A7"><span class="nav-number">4.4.1.</span> <span class="nav-text">页缓存对象：属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E7%BC%93%E5%AD%98%E5%AF%B9%E8%B1%A1%EF%BC%9A%E6%96%B9%E6%B3%95"><span class="nav-number">4.4.2.</span> <span class="nav-text">页缓存对象：方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E7%BC%93%E5%AD%98%E5%AF%B9%E8%B1%A1%EF%BC%9A%E7%89%A9%E7%90%86%E9%A1%B5"><span class="nav-number">4.4.3.</span> <span class="nav-text">页缓存对象：物理页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">4.4.4.</span> <span class="nav-text">页缓存数据结构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E6%96%87%E4%BB%B6-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">4.4.5.</span> <span class="nav-text">读文件-基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E6%96%87%E4%BB%B6%E5%AE%9E%E4%BE%8B"><span class="nav-number">4.4.6.</span> <span class="nav-text">读文件实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E6%96%87%E4%BB%B6-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">4.4.7.</span> <span class="nav-text">写文件-基本流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">4.5.</span> <span class="nav-text">块设备驱动架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E7%BC%93%E5%AD%98"><span class="nav-number">4.5.1.</span> <span class="nav-text">块缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bio%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">4.5.2.</span> <span class="nav-text">bio结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84-1"><span class="nav-number">4.5.3.</span> <span class="nav-text">块设备驱动架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%84%E7%A7%8D%E5%90%84%E6%A0%B7%E7%9A%84%E5%9D%97%E8%AE%BE%E5%A4%87"><span class="nav-number">4.5.3.1.</span> <span class="nav-text">各种各样的块设备</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84IO%E7%BC%93%E5%AD%98"><span class="nav-number">4.6.</span> <span class="nav-text">用户空间的IO缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E6%B5%81%E7%A8%8B"><span class="nav-number">4.6.1.</span> <span class="nav-text">文件读写流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.6.2.</span> <span class="nav-text">三种模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-number">4.6.3.</span> <span class="nav-text">自定义缓冲区</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scatter-gather-I-O"><span class="nav-number">4.7.</span> <span class="nav-text">Scatter-gather I&#x2F;O</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%95%A3-%E8%81%9A%E9%9B%86IO"><span class="nav-number">4.7.1.</span> <span class="nav-text">分散&#x2F;聚集IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="nav-number">4.7.2.</span> <span class="nav-text">系统调用函数原型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-number">4.7.3.</span> <span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#writev"><span class="nav-number">4.7.3.1.</span> <span class="nav-text">writev()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#readv"><span class="nav-number">4.7.3.2.</span> <span class="nav-text">readv()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5I-O"><span class="nav-number">4.8.</span> <span class="nav-text">直接I&#x2F;O</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84IO%E7%BC%93%E5%AD%98-1"><span class="nav-number">4.8.1.</span> <span class="nav-text">用户空间的IO缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A3%9E%E8%B7%83%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-number">4.8.2.</span> <span class="nav-text">飞跃缓冲区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E7%BC%93%E5%AD%98%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.8.3.</span> <span class="nav-text">自缓存应用程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5IO"><span class="nav-number">4.8.4.</span> <span class="nav-text">直接IO</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84%E5%88%B0%E5%86%85%E5%AD%98"><span class="nav-number">4.9.</span> <span class="nav-text">将文件映射到内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%9A%84IO%E7%BC%93%E5%AD%98"><span class="nav-number">4.9.1.</span> <span class="nav-text">用户的IO缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84%E5%88%B0%E5%86%85%E5%AD%98-1"><span class="nav-number">4.9.2.</span> <span class="nav-text">将文件映射到内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="nav-number">4.9.3.</span> <span class="nav-text">系统调用接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-number">4.9.4.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84%E7%9A%84%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.10.</span> <span class="nav-text">文件映射的内存实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E8%BF%9B%E7%A8%8B%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">4.10.1.</span> <span class="nav-text">Linux进程虚拟地址空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E8%BF%9B%E7%A8%8B%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E6%8F%8F%E8%BF%B0"><span class="nav-number">4.10.2.</span> <span class="nav-text">Linux进程虚拟地址描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%88%B0%E6%96%87%E4%BB%B6%E7%9A%84%E6%98%A0%E5%B0%84"><span class="nav-number">4.10.3.</span> <span class="nav-text">Linux虚拟地址到文件的映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E4%B8%8ELinux%E8%BF%9B%E7%A8%8B%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%BB%BA%E7%AB%8B%E5%85%B3%E8%81%94"><span class="nav-number">4.10.4.</span> <span class="nav-text">内存物理地址与Linux进程虚拟地址建立关联</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86%E8%AE%BE%E5%A4%87%E6%98%A0%E5%B0%84%E5%88%B0%E5%86%85%E5%AD%98"><span class="nav-number">4.11.</span> <span class="nav-text">将设备映射到内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LCD%E6%98%BE%E7%A4%BA%E5%8E%9F%E7%90%86"><span class="nav-number">4.11.1.</span> <span class="nav-text">LCD显示原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frambuffer%E8%AE%BE%E5%A4%87"><span class="nav-number">4.11.2.</span> <span class="nav-text">Frambuffer设备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E8%AE%BE%E5%A4%87%E6%98%A0%E5%B0%84%E5%88%B0%E5%86%85%E5%AD%98-1"><span class="nav-number">4.11.3.</span> <span class="nav-text">将设备映射到内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84"><span class="nav-number">4.11.4.</span> <span class="nav-text">共享文件映射</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BB%88%E7%AB%AF"><span class="nav-number">5.</span> <span class="nav-text">进程与终端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%EF%BC%9A%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%9A%84%E2%80%9C%E7%89%8C%E7%85%A7%E2%80%9D"><span class="nav-number">5.1.</span> <span class="nav-text">进程：程序运行的“牌照”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.1.1.</span> <span class="nav-text">进程与程序的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B-fork"><span class="nav-number">5.2.</span> <span class="nav-text">创建一个进程:fork</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AD%90%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.2.1.</span> <span class="nav-text">创建一个子进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%BF%90%E8%A1%8C%EF%BC%9A%E2%80%9C%E5%80%9F%E5%A3%B3%E4%B8%8A%E5%B8%82%E2%80%9D"><span class="nav-number">5.3.</span> <span class="nav-text">子进程的运行：“借壳上市”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E4%B8%80%E4%B8%AA%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%A8%8B%E5%BA%8F%E6%96%87%E4%BB%B6"><span class="nav-number">5.3.1.</span> <span class="nav-text">执行一个二进制程序文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%EF%BC%88COW%EF%BC%89%E4%B8%8Evfork"><span class="nav-number">5.4.</span> <span class="nav-text">写时复制（COW）与vfork</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E6%96%B0%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%AF%9E%E7%94%9F%EF%BC%9A%E8%99%9A%E6%8B%9F%E7%A9%BA%E9%97%B4"><span class="nav-number">5.4.1.</span> <span class="nav-text">一个新进程的诞生：虚拟空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E6%96%B0%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%AF%9E%E7%94%9F%EF%BC%9A%E7%89%A9%E7%90%86%E7%A9%BA%E9%97%B4"><span class="nav-number">5.4.2.</span> <span class="nav-text">一个新进程的诞生：物理空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6-copy-on-write"><span class="nav-number">5.4.3.</span> <span class="nav-text">写时复制(copy-on-write)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Avfork"><span class="nav-number">5.4.4.</span> <span class="nav-text">系统调用：vfork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%80%80%E5%87%BA%EF%BC%9Aexit"><span class="nav-number">5.5.</span> <span class="nav-text">进程的退出：exit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%88%E6%AD%A2%E5%BD%93%E5%89%8D%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.5.1.</span> <span class="nav-text">终止当前进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exit%E5%87%BD%E6%95%B0%E7%9A%84%E8%83%8C%E5%90%8E"><span class="nav-number">5.5.2.</span> <span class="nav-text">exit函数的背后</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#atexit-on-exit"><span class="nav-number">5.5.3.</span> <span class="nav-text">atexit&#x2F;on_exit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#return%E4%B8%8Eexit%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.5.4.</span> <span class="nav-text">return与exit的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exit-group%E5%87%BD%E6%95%B0"><span class="nav-number">5.5.5.</span> <span class="nav-text">exit_group函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tips"><span class="nav-number">5.5.6.</span> <span class="nav-text">Tips</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%80%80%E5%87%BA%EF%BC%9Aexit%E4%B8%8E-exit"><span class="nav-number">5.6.</span> <span class="nav-text">进程的退出：exit与_exit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E8%80%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.6.1.</span> <span class="nav-text">两者的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exit%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">5.6.2.</span> <span class="nav-text">_exit的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-exit%E5%92%8Cexit%E6%80%BB%E7%BB%93"><span class="nav-number">5.6.3.</span> <span class="nav-text">关于_exit和exit总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%80%80%E5%87%BA%EF%BC%9Avfork%E4%B8%8Eexit"><span class="nav-number">5.7.</span> <span class="nav-text">进程的退出：vfork与exit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vfork%E5%87%BD%E6%95%B0"><span class="nav-number">5.7.1.</span> <span class="nav-text">vfork函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8vfork%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%80%80%E5%87%BA"><span class="nav-number">5.7.2.</span> <span class="nav-text">使用vfork创建子进程的退出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%EF%BC%9Await"><span class="nav-number">5.8.</span> <span class="nav-text">等待子进程终止：wait</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81"><span class="nav-number">5.8.1.</span> <span class="nav-text">子进程的返回状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E5%AE%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81"><span class="nav-number">5.8.2.</span> <span class="nav-text">通过宏来解析返回状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">5.8.3.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E7%89%B9%E5%AE%9A%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8C%E7%BB%88%E6%AD%A2"><span class="nav-number">5.8.4.</span> <span class="nav-text">等待特定子进程运行终止</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6"><span class="nav-number">5.9.</span> <span class="nav-text">进程调度</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A0%B8%E5%BF%83%EF%BC%9A%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="nav-number">5.9.1.</span> <span class="nav-text">操作系统的核心：任务管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="nav-number">5.9.2.</span> <span class="nav-text">调度器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="nav-number">5.9.3.</span> <span class="nav-text">Linux进程管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%88%86%E7%B1%BB"><span class="nav-number">5.9.3.1.</span> <span class="nav-text">进程分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="nav-number">5.9.3.2.</span> <span class="nav-text">Linux调度策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">5.9.4.</span> <span class="nav-text">进程的优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E5%8C%BA%E5%88%AB"><span class="nav-number">5.9.5.</span> <span class="nav-text">并发与并行区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="nav-number">5.10.</span> <span class="nav-text">Linux进程状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="nav-number">5.10.1.</span> <span class="nav-text">进程状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84UID%E5%92%8CGID"><span class="nav-number">5.11.</span> <span class="nav-text">进程的UID和GID</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84PID"><span class="nav-number">5.11.1.</span> <span class="nav-text">进程的PID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84"><span class="nav-number">5.11.2.</span> <span class="nav-text">用户和组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8BUID%E5%92%8CGID"><span class="nav-number">5.11.3.</span> <span class="nav-text">进程UID和GID</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87proc%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E8%B5%84%E6%BA%90"><span class="nav-number">5.12.</span> <span class="nav-text">通过proc查看进程资源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E8%B5%84%E6%BA%90%EF%BC%9Atask-struct"><span class="nav-number">5.12.1.</span> <span class="nav-text">进程资源：task_struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87ps%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E8%B5%84%E6%BA%90"><span class="nav-number">5.12.2.</span> <span class="nav-text">通过ps命令查看进程资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87proc%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E8%B5%84%E6%BA%90-1"><span class="nav-number">5.12.3.</span> <span class="nav-text">通过proc查看进程资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8E%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%EF%BC%9A%E4%BF%A1%E5%8F%B7"><span class="nav-number">5.13.</span> <span class="nav-text">与进程通信：信号</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7"><span class="nav-number">5.13.1.</span> <span class="nav-text">信号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%AF%B9%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">5.13.2.</span> <span class="nav-text">一个进程对信号的处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E4%B8%8E%E5%85%B6%E5%AF%B9%E5%BA%94%E7%9A%84%E7%B3%BB%E7%BB%9F%E4%BA%8B%E4%BB%B6"><span class="nav-number">5.13.3.</span> <span class="nav-text">信号与其对应的系统事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%88%E7%AB%AF%E9%A9%B1%E5%8A%A8%E6%94%AF%E6%8C%81%E7%9A%84%E4%BF%A1%E5%8F%B7"><span class="nav-number">5.13.4.</span> <span class="nav-text">终端驱动支持的信号</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%88%E7%AB%AF%E4%B8%8E%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-number">5.14.</span> <span class="nav-text">终端与控制台</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%88%E7%AB%AF%E7%9A%84%E6%BC%94%E5%8F%98"><span class="nav-number">5.14.1.</span> <span class="nav-text">终端的演变</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">5.14.2.</span> <span class="nav-text">控制台的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E7%BB%88%E7%AB%AF"><span class="nav-number">5.14.3.</span> <span class="nav-text">虚拟终端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E7%BB%88%E7%AB%AF"><span class="nav-number">5.14.4.</span> <span class="nav-text">伪终端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TIPS"><span class="nav-number">5.14.5.</span> <span class="nav-text">TIPS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%84%E4%B8%8E%E4%BC%9A%E8%AF%9D"><span class="nav-number">5.15.</span> <span class="nav-text">进程组与会话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%84"><span class="nav-number">5.15.1.</span> <span class="nav-text">进程组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D"><span class="nav-number">5.15.2.</span> <span class="nav-text">会话</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E4%B8%8Eshell"><span class="nav-number">5.15.3.</span> <span class="nav-text">会话与shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell-%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="nav-number">5.15.4.</span> <span class="nav-text">shell 解释器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">5.15.5.</span> <span class="nav-text">shell的工作流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%90%8E%E5%8F%B0%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.16.</span> <span class="nav-text">前台进程与后台进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%89%8D%E5%90%8E%E5%8F%B0"><span class="nav-number">5.16.1.</span> <span class="nav-text">进程的前后台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shell%E4%B8%8E%E5%89%8D%E5%90%8E%E5%8F%B0"><span class="nav-number">5.16.2.</span> <span class="nav-text">Shell与前后台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%89%8D%E5%90%8E%E5%8F%B0%E8%BD%AC%E6%8D%A2"><span class="nav-number">5.16.3.</span> <span class="nav-text">进程的前后台转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.16.4.</span> <span class="nav-text">Android中的进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.17.</span> <span class="nav-text">守护进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">5.17.1.</span> <span class="nav-text">守护进程的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">5.17.2.</span> <span class="nav-text">守护进程的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.17.3.</span> <span class="nav-text">查看守护进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">5.17.4.</span> <span class="nav-text">守护进程的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="nav-number">5.17.5.</span> <span class="nav-text">守护进程的启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.17.6.</span> <span class="nav-text">后台进程与守护进程的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E5%B9%B6%E8%BF%90%E8%A1%8C"><span class="nav-number">5.17.7.</span> <span class="nav-text">编写一个守护进程并运行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.18.</span> <span class="nav-text">僵尸进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%88%B6%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%85%B3%E8%81%94"><span class="nav-number">5.18.1.</span> <span class="nav-text">父进程和子进程的关联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%EF%BC%9F"><span class="nav-number">5.18.2.</span> <span class="nav-text">什么是僵尸进程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%B9%B6%E8%A7%82%E5%AF%9F%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-number">5.18.3.</span> <span class="nav-text">创建一个僵尸进程，并观察进程的状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.19.</span> <span class="nav-text">孤儿进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B%EF%BC%9F"><span class="nav-number">5.19.1.</span> <span class="nav-text">什么是孤儿进程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.19.2.</span> <span class="nav-text">编程示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%BC%94%E5%8F%98"><span class="nav-number">5.19.3.</span> <span class="nav-text">init服务进程的演变</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0%E5%8F%B7%E8%BF%9B%E7%A8%8B%E5%92%8C1%E5%8F%B7%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.20.</span> <span class="nav-text">0号进程和1号进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%B5%B7%E6%BA%90"><span class="nav-number">5.20.1.</span> <span class="nav-text">Linux进程的起源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0%E5%8F%B7%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.20.2.</span> <span class="nav-text">0号进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E5%8F%B7%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.20.3.</span> <span class="nav-text">1号进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84init%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.20.4.</span> <span class="nav-text">Linux操作系统的init服务进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E4%B8%AD%E7%9A%84init%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.20.5.</span> <span class="nav-text">嵌入式中的init服务进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux%E8%BF%9B%E7%A8%8B%E5%85%A8%E6%99%AF%E5%9B%BE"><span class="nav-number">5.21.</span> <span class="nav-text">Linux进程全景图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-number">6.</span> <span class="nav-text">进程间通信</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1IPC"><span class="nav-number">6.1.</span> <span class="nav-text">进程间通信IPC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">6.1.1.</span> <span class="nav-text">进程的地址空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%89%A9%E7%90%86%E7%A9%BA%E9%97%B4"><span class="nav-number">6.1.2.</span> <span class="nav-text">进程的物理空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1-1"><span class="nav-number">6.1.3.</span> <span class="nav-text">进程间通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%AE%9E%E7%8E%B0%E4%B8%A4%E4%B8%AA%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%AE%AF"><span class="nav-number">6.1.4.</span> <span class="nav-text">使用文件实现两个进程通讯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sender"><span class="nav-number">6.1.4.1.</span> <span class="nav-text">sender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#receiver"><span class="nav-number">6.1.4.2.</span> <span class="nav-text">receiver</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-number">6.1.5.</span> <span class="nav-text">Linux 进程间通信</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFIPC%EF%BC%9F"><span class="nav-number">6.1.5.1.</span> <span class="nav-text">什么是IPC？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPC%E5%B7%A5%E5%85%B7%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">6.1.5.2.</span> <span class="nav-text">IPC工具的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E5%90%8CIPC%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E5%90%88"><span class="nav-number">6.1.5.3.</span> <span class="nav-text">不同IPC的应用场合</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A0%E5%90%8D%E7%AE%A1%E9%81%93%EF%BC%9APIPE"><span class="nav-number">6.2.</span> <span class="nav-text">无名管道：PIPE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E7%AE%A1%E9%81%93"><span class="nav-number">6.2.1.</span> <span class="nav-text">Linux内核中的管道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PIPE%E7%9A%84%E5%86%85%E6%A0%B8%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.2.2.</span> <span class="nav-text">PIPE的内核层实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">通信原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PIPE%E7%AE%A1%E9%81%93%E7%BC%96%E7%A8%8B"><span class="nav-number">6.2.3.</span> <span class="nav-text">PIPE管道编程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%A1%E9%81%93"><span class="nav-number">6.2.3.1.</span> <span class="nav-text">创建一个管道</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.2.3.2.</span> <span class="nav-text">编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%95%E5%90%91%E9%80%9A%E4%BF%A1"><span class="nav-number">6.2.3.2.1.</span> <span class="nav-text">单向通信</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1"><span class="nav-number">6.2.3.2.2.</span> <span class="nav-text">双向通信</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell%E7%AE%A1%E9%81%93%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.2.4.</span> <span class="nav-text">shell管道的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%A1%E9%81%93%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">6.2.4.1.</span> <span class="nav-text">管道的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B%E5%92%8C%E9%87%8D%E5%AE%9A%E5%90%91%E5%8A%9F%E8%83%BD"><span class="nav-number">6.2.4.2.</span> <span class="nav-text">基本流程和重定向功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">6.2.4.3.</span> <span class="nav-text">输入输出重定向</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHELL%E7%AE%A1%E9%81%93%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">6.2.4.4.</span> <span class="nav-text">SHELL管道实现的原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E7%AE%A1%E9%81%93%E4%B8%8Eshell%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1"><span class="nav-number">6.2.5.</span> <span class="nav-text">通过管道与shell命令进行通信</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#popen%E5%87%BD%E6%95%B0"><span class="nav-number">6.2.5.1.</span> <span class="nav-text">popen函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E7%AE%A1%E9%81%93%E5%90%8C%E6%AD%A5%E8%BF%9B%E7%A8%8B"><span class="nav-number">6.2.6.</span> <span class="nav-text">通过管道同步进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PIPE%E9%80%9A%E4%BF%A1%E5%BA%94%E7%94%A8"><span class="nav-number">6.2.6.1.</span> <span class="nav-text">PIPE通信应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%A1%E9%81%93%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-number">6.2.6.2.</span> <span class="nav-text">管道缓冲区的设置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-number">6.2.7.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%EF%BC%9AFIFO-named-pipe"><span class="nav-number">6.3.</span> <span class="nav-text">命名管道：FIFO(named pipe)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FIFO%E9%80%9A%E4%BF%A1%E7%89%B9%E7%82%B9"><span class="nav-number">6.3.1.</span> <span class="nav-text">FIFO通信特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FIFO%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.3.2.</span> <span class="nav-text">FIFO编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3-1"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">系统调用接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">进程通信示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FIFO%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.3.3.</span> <span class="nav-text">FIFO内核实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FIFO%E5%BA%94%E7%94%A8%EF%BC%9ALOG%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.4.</span> <span class="nav-text">FIFO应用：LOG日志系统的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Log%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F"><span class="nav-number">6.4.1.</span> <span class="nav-text">Log日志系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FIFO%E5%BA%94%E7%94%A8%EF%BC%9A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E4%BF%A1"><span class="nav-number">6.5.</span> <span class="nav-text">FIFO应用：服务端与客户端通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%BF%87FIFO%E5%AE%9E%E7%8E%B0%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1"><span class="nav-number">6.5.1.</span> <span class="nav-text">服务端、客户端进程通过FIFO实现双向通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%BF%87%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1"><span class="nav-number">6.5.2.</span> <span class="nav-text">2个客户端进程通过服务端实现双向通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%BF%87%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0%E9%80%9A%E4%BF%A1"><span class="nav-number">6.5.3.</span> <span class="nav-text">不同客户端进程通过服务端实现通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPC%E5%AF%B9%E8%B1%A1%E5%92%8CIPC-key"><span class="nav-number">6.6.</span> <span class="nav-text">IPC对象和IPC key</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E5%AF%B9%E8%B1%A1-IPC"><span class="nav-number">6.6.1.</span> <span class="nav-text">进程间通信对象: IPC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC%E5%88%86%E7%B1%BB"><span class="nav-number">6.6.2.</span> <span class="nav-text">IPC分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.6.3.</span> <span class="nav-text">IPC对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC%E6%A0%87%E8%AF%86%E7%AC%A6%E5%92%8CIPC-key"><span class="nav-number">6.6.4.</span> <span class="nav-text">IPC标识符和IPC key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC-key"><span class="nav-number">6.6.5.</span> <span class="nav-text">IPC key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8"><span class="nav-number">6.6.6.</span> <span class="nav-text">IPC对象的引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%84%E7%A7%8DIPC%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%A0%87%E8%AF%86%E7%AC%A6%E5%92%8C%E5%8F%A5%E6%9F%84"><span class="nav-number">6.6.7.</span> <span class="nav-text">各种IPC对象的标识符和句柄</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#System-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">6.7.</span> <span class="nav-text">System V 消息队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#System-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-1"><span class="nav-number">6.7.1.</span> <span class="nav-text">System V 消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="nav-number">6.7.2.</span> <span class="nav-text">编程接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-1"><span class="nav-number">6.7.3.</span> <span class="nav-text">编程实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">6.7.4.</span> <span class="nav-text">Linux中的消息队列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9A%E7%82%B9%E5%AF%B9%E7%82%B9%E9%80%9A%E4%BF%A1"><span class="nav-number">6.8.</span> <span class="nav-text">消息队列的应用：点对点通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9A%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="nav-number">6.9.</span> <span class="nav-text">消息队列的应用：多人聊天室</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%AC%E5%9C%B0%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.9.1.</span> <span class="nav-text">多用户本地聊天室实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-3"><span class="nav-number">6.9.2.</span> <span class="nav-text">小结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8EFIFO%E6%AF%94%E8%BE%83"><span class="nav-number">6.9.2.1.</span> <span class="nav-text">消息队列与FIFO比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-number">6.9.2.2.</span> <span class="nav-text">消息队列的优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="nav-number">6.9.2.3.</span> <span class="nav-text">消息队列的缺陷</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#system-V-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-number">6.10.</span> <span class="nav-text">system V 共享内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86-1"><span class="nav-number">6.10.1.</span> <span class="nav-text">通信原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF"><span class="nav-number">6.10.2.</span> <span class="nav-text">优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">6.10.3.</span> <span class="nav-text">操作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3API"><span class="nav-number">6.10.4.</span> <span class="nav-text">相关API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%AF%B9%E8%B1%A1%E7%9A%84ID"><span class="nav-number">6.10.4.1.</span> <span class="nav-text">获取共享内存对象的ID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#attach%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-number">6.10.4.2.</span> <span class="nav-text">attach共享内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#detach%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-number">6.10.4.3.</span> <span class="nav-text">detach共享内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">6.10.4.4.</span> <span class="nav-text">设置共享内存的属性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-2"><span class="nav-number">6.10.5.</span> <span class="nav-text">编程实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E9%80%9A%E4%BF%A1%E9%99%90%E5%88%B6"><span class="nav-number">6.10.6.</span> <span class="nav-text">共享内存的通信限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E9%80%9A%E4%BF%A1%E7%89%B9%E7%82%B9"><span class="nav-number">6.10.7.</span> <span class="nav-text">共享内存通信特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84mmap%E5%92%8C%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98shmat%E4%B9%8B%E9%97%B4%E6%9C%89%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F"><span class="nav-number">6.10.8.</span> <span class="nav-text">内存映射mmap和共享内存shmat之间有什么关系？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#system-V-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">6.11.</span> <span class="nav-text">system V 信号量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">6.11.1.</span> <span class="nav-text">信号量的基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86-2"><span class="nav-number">6.11.2.</span> <span class="nav-text">通信原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8system-V-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">6.11.3.</span> <span class="nav-text">使用system V 信号量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3API-1"><span class="nav-number">6.11.3.1.</span> <span class="nav-text">相关API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%88%96%E6%89%93%E5%BC%80%E4%B8%80%E4%B8%AA%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">6.11.3.2.</span> <span class="nav-text">创建或打开一个信号量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E8%AE%BE%E7%BD%AE"><span class="nav-number">6.11.3.3.</span> <span class="nav-text">信号量设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8FP-V%E6%93%8D%E4%BD%9C"><span class="nav-number">6.11.3.4.</span> <span class="nav-text">信号量P&#x2F;V操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9Asembuf"><span class="nav-number">6.11.3.5.</span> <span class="nav-text">结构体：sembuf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">6.11.4.</span> <span class="nav-text">使用流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-3"><span class="nav-number">6.11.5.</span> <span class="nav-text">编程实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%BC%96%E7%A8%8B%E5%BA%94%E7%94%A8%EF%BC%9A%E5%AF%B9%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE"><span class="nav-number">6.12.</span> <span class="nav-text">信号量编程应用：对共享内存的同步访问</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#shm-read-c"><span class="nav-number">6.12.1.</span> <span class="nav-text">shm_read.c</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shm-write-c"><span class="nav-number">6.12.2.</span> <span class="nav-text">shm_write.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%BC%96%E7%A8%8B%E5%BA%94%E7%94%A8%EF%BC%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="nav-number">6.13.</span> <span class="nav-text">信号量编程应用：生产者-消费者模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-4"><span class="nav-number">6.13.1.</span> <span class="nav-text">编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#producer"><span class="nav-number">6.13.1.1.</span> <span class="nav-text">producer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#consumer"><span class="nav-number">6.13.1.2.</span> <span class="nav-text">consumer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-4"><span class="nav-number">6.13.2.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POSIX-IPC"><span class="nav-number">6.14.</span> <span class="nav-text">POSIX IPC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX-IPC%E7%AE%80%E4%BB%8B"><span class="nav-number">6.14.1.</span> <span class="nav-text">POSIX IPC简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#POSIX-IPC%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="nav-number">6.14.1.1.</span> <span class="nav-text">POSIX IPC对象编程接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POSIX-%E4%B8%8E-system-V-IPC"><span class="nav-number">6.14.1.2.</span> <span class="nav-text">POSIX 与 system V IPC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POSIX-%E7%BC%96%E7%A8%8B%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">6.14.1.3.</span> <span class="nav-text">POSIX 编程注意事项</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8A%EF%BC%9AAPI%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.14.2.</span> <span class="nav-text">POSIX消息队列上：API编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3API-2"><span class="nav-number">6.14.2.1.</span> <span class="nav-text">相关API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E6%89%93%E5%BC%80IPC%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.14.2.2.</span> <span class="nav-text">创建和打开IPC对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%ADPOSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">6.14.2.3.</span> <span class="nav-text">关闭POSIX消息队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AAPOSIX-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">6.14.2.4.</span> <span class="nav-text">删除一个POSIX 消息队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%91-POSIX-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%86%99%E5%85%A5%E6%B6%88%E6%81%AF"><span class="nav-number">6.14.2.5.</span> <span class="nav-text">向 POSIX 消息队列写入消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E-POSIX-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF"><span class="nav-number">6.14.2.6.</span> <span class="nav-text">从 POSIX 消息队列读取消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-5"><span class="nav-number">6.14.2.7.</span> <span class="nav-text">编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%88%B6%E5%AD%90%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%BF%87%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1"><span class="nav-number">6.14.2.7.1.</span> <span class="nav-text">父子进程通过消息队列进行通信</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E4%B8%8D%E7%9B%B8%E5%85%B3%E7%9A%84%E8%BF%9B%E7%A8%8B%E9%80%9A%E8%BF%87%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1"><span class="nav-number">6.14.2.7.2.</span> <span class="nav-text">两个不相关的进程通过消息队列进行通信</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%EF%BC%9A%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="nav-number">6.14.3.</span> <span class="nav-text">POSIX消息队列中：异步通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5API%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.14.3.1.</span> <span class="nav-text">异步通知API介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9Asigevent"><span class="nav-number">6.14.3.2.</span> <span class="nav-text">关键结构体：sigevent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-6"><span class="nav-number">6.14.3.3.</span> <span class="nav-text">编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mq-notify-c"><span class="nav-number">6.14.3.3.1.</span> <span class="nav-text">mq_notify.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mq-send-c"><span class="nav-number">6.14.3.3.2.</span> <span class="nav-text">mq_send.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8B-%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.14.4.</span> <span class="nav-text">POSIX消息队列下:内核实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#POSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.14.4.1.</span> <span class="nav-text">POSIX消息队列内核实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#system-V%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.14.4.2.</span> <span class="nav-text">system V消息队列内核实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84POSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">6.14.4.3.</span> <span class="nav-text">内核中的POSIX消息队列描述符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%AE%BE%E7%BD%AE%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">6.14.4.4.</span> <span class="nav-text">查看设置消息队列的属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POSIX%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8Linux%E4%B8%8A%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%89%B9%E6%80%A7"><span class="nav-number">6.14.4.5.</span> <span class="nav-text">POSIX消息队列在Linux上实现的特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POSIX%E4%B8%8E-system-V%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">6.14.4.6.</span> <span class="nav-text">POSIX与 system V消息队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-5"><span class="nav-number">6.14.4.7.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">6.14.5.</span> <span class="nav-text">POSIX 信号量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84API"><span class="nav-number">6.14.5.1.</span> <span class="nav-text">相关的API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="nav-number">6.14.5.2.</span> <span class="nav-text">使用指南</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-7"><span class="nav-number">6.14.5.3.</span> <span class="nav-text">编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sem-demo-c"><span class="nav-number">6.14.5.3.1.</span> <span class="nav-text">sem_demo.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sem-sync-c"><span class="nav-number">6.14.5.3.2.</span> <span class="nav-text">sem_sync.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sem-post-c%E5%92%8Csem-wait-c"><span class="nav-number">6.14.5.3.3.</span> <span class="nav-text">sem_post.c和sem_wait.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POSIX%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-number">6.14.6.</span> <span class="nav-text">POSIX共享内存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%AE%9E%E4%BE%8B-8"><span class="nav-number">6.14.6.1.</span> <span class="nav-text">编程实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#shm-write-c-1"><span class="nav-number">6.14.6.1.1.</span> <span class="nav-text">shm_write.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#shm-read-c-1"><span class="nav-number">6.14.6.1.2.</span> <span class="nav-text">shm_read.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8E%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8"><span class="nav-number">6.14.6.1.3.</span> <span class="nav-text">与信号量结合使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E9%94%81"><span class="nav-number">6.14.7.</span> <span class="nav-text">文件锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-number">6.14.7.1.</span> <span class="nav-text">共享内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%87%E4%BB%B6%E9%94%81"><span class="nav-number">6.14.7.2.</span> <span class="nav-text">什么是文件锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Aflock"><span class="nav-number">6.14.7.3.</span> <span class="nav-text">系统调用：flock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Afcntl"><span class="nav-number">6.14.7.4.</span> <span class="nav-text">系统调用：fcntl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Alockf"><span class="nav-number">6.14.7.5.</span> <span class="nav-text">系统调用：lockf</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E6%9C%BA%E5%88%B6%EF%BC%9Asignal"><span class="nav-number">6.15.</span> <span class="nav-text">信号机制：signal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7-signal"><span class="nav-number">6.15.1.</span> <span class="nav-text">信号(signal)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="nav-number">6.15.2.</span> <span class="nav-text">信号的来源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%AF%B9%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="nav-number">6.15.3.</span> <span class="nav-text">一个进程对信号的处理方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E7%9B%B8%E5%85%B3API"><span class="nav-number">6.15.4.</span> <span class="nav-text">信号相关API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Asignal"><span class="nav-number">6.15.4.1.</span> <span class="nav-text">系统调用：signal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Akill"><span class="nav-number">6.15.4.2.</span> <span class="nav-text">系统调用：kill</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Apause"><span class="nav-number">6.15.4.3.</span> <span class="nav-text">系统调用：pause</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">6.15.5.</span> <span class="nav-text">定时发送信号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Aalarm"><span class="nav-number">6.15.5.1.</span> <span class="nav-text">系统调用：alarm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Asetitimer"><span class="nav-number">6.15.5.2.</span> <span class="nav-text">系统调用：setitimer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E5%AE%89%E5%85%A8%E7%9A%84%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="nav-number">6.15.6.</span> <span class="nav-text">编写安全的信号处理函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="nav-number">6.15.6.1.</span> <span class="nav-text">信号的本质</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E8%A6%81%E7%82%B9"><span class="nav-number">6.15.6.2.</span> <span class="nav-text">编程要点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E4%B8%8E%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="nav-number">6.15.6.3.</span> <span class="nav-text">可重入与线程安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E5%87%BD%E6%95%B0%E5%AE%89%E5%85%A8%E5%88%97%E8%A1%A8"><span class="nav-number">6.15.6.4.</span> <span class="nav-text">可重入函数安全列表</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E5%BA%95%E5%B1%82API%EF%BC%9Asigaction"><span class="nav-number">6.15.7.</span> <span class="nav-text">信号底层API：sigaction</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E4%BF%A1%E5%8F%B7%E5%8F%8A%E5%85%B6%E4%B8%8D%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="nav-number">6.15.7.1.</span> <span class="nav-text">标准信号及其不可靠性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%AF%B9%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">6.15.7.2.</span> <span class="nav-text">内核对信号的处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E5%BA%95%E5%B1%82%E6%B3%A8%E5%86%8C%E5%87%BD%E6%95%B0"><span class="nav-number">6.15.7.3.</span> <span class="nav-text">信号底层注册函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E7%9A%84%E4%BF%A1%E5%8F%B7%E5%8F%91%E9%80%81%E5%87%BD%E6%95%B0"><span class="nav-number">6.15.7.4.</span> <span class="nav-text">新的信号发送函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-6"><span class="nav-number">6.15.7.5.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux%E6%96%B0%E5%A2%9EAPI"><span class="nav-number">6.16.</span> <span class="nav-text">Linux新增API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#signalfd"><span class="nav-number">6.16.1.</span> <span class="nav-text">signalfd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">6.16.1.1.</span> <span class="nav-text">信号通信机制优缺点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signalfd-1"><span class="nav-number">6.16.1.2.</span> <span class="nav-text">signalfd</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timerfd"><span class="nav-number">6.16.2.</span> <span class="nav-text">timerfd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eventfd"><span class="nav-number">6.16.3.</span> <span class="nav-text">eventfd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#D-BUS%E6%80%BB%E7%BA%BF%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%B0%8F%E7%BB%93"><span class="nav-number">6.17.</span> <span class="nav-text">D-BUS总线简介及小结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%84%E7%A7%8D%E5%B7%A5%E5%85%B7%E7%9A%84%E6%AF%94%E8%BE%83"><span class="nav-number">6.17.1.</span> <span class="nav-text">各种工具的比较</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="nav-number">7.</span> <span class="nav-text">多线程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">7.1.</span> <span class="nav-text">多线程编程的概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B"><span class="nav-number">7.1.1.</span> <span class="nav-text">进程、线程、协程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">7.2.</span> <span class="nav-text">多线程学习准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Pthread%E7%BA%BF%E7%A8%8B%E5%BA%93"><span class="nav-number">7.2.1.</span> <span class="nav-text">Pthread线程库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E5%92%8CWindows%E7%9A%84API"><span class="nav-number">7.2.2.</span> <span class="nav-text">Linux和Windows的API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8pthread%E5%BA%93"><span class="nav-number">7.2.3.</span> <span class="nav-text">使用pthread库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%BA%BF%E7%A8%8B%EF%BC%9Apthread-create"><span class="nav-number">7.3.</span> <span class="nav-text">创建一个新线程：pthread_create</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E"><span class="nav-number">7.3.1.</span> <span class="nav-text">API接口说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%BB%88%E6%AD%A2"><span class="nav-number">7.4.</span> <span class="nav-text">线程的终止</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%88%E6%AD%A2%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">7.4.1.</span> <span class="nav-text">终止线程的三种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8Bpthread-exit%E4%B8%8Eexit%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">7.4.2.</span> <span class="nav-text">线程pthread_exit与exit的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%BB%88%E6%AD%A2"><span class="nav-number">7.5.</span> <span class="nav-text">等待线程的终止</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%86%E4%B8%A4%E7%A7%8D"><span class="nav-number">7.5.1.</span> <span class="nav-text">线程分两种</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E6%8E%A5%E5%8F%A3"><span class="nav-number">7.5.2.</span> <span class="nav-text">API接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pthread-join"><span class="nav-number">7.5.2.1.</span> <span class="nav-text">pthread_join()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pthread-detach"><span class="nav-number">7.5.2.2.</span> <span class="nav-text">pthread_detach()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%B1%9E%E6%80%A7"><span class="nav-number">7.6.</span> <span class="nav-text">线程属性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%B1%9E%E6%80%A7"><span class="nav-number">7.6.1.</span> <span class="nav-text">默认属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3API%E5%87%BD%E6%95%B0"><span class="nav-number">7.6.2.</span> <span class="nav-text">相关API函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E4%B8%8E%E8%BF%90%E8%A1%8C"><span class="nav-number">7.7.</span> <span class="nav-text">线程调度与运行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%86%E7%B1%BB"><span class="nav-number">7.7.1.</span> <span class="nav-text">线程分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.7.2.</span> <span class="nav-text">一对一模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.7.3.</span> <span class="nav-text">多对一模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.7.4.</span> <span class="nav-text">多对多模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E4%B8%8B%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="nav-number">7.7.5.</span> <span class="nav-text">Linux下的线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LWP%E4%B8%8E%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E8%BF%9B%E7%A8%8B%E6%AF%94%E8%BE%83"><span class="nav-number">7.7.6.</span> <span class="nav-text">LWP与普通用户进程比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="nav-number">7.8.</span> <span class="nav-text">线程安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">7.8.1.</span> <span class="nav-text">进程的虚拟地址空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8B%E7%9A%84%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE"><span class="nav-number">7.8.2.</span> <span class="nav-text">多进程下的资源访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8-1"><span class="nav-number">7.8.3.</span> <span class="nav-text">线程安全</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="nav-number">7.9.</span> <span class="nav-text">线程同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-number">7.9.1.</span> <span class="nav-text">互斥锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3API%E5%87%BD%E6%95%B0-1"><span class="nav-number">7.9.1.1.</span> <span class="nav-text">相关API函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number">7.9.2.</span> <span class="nav-text">条件变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">7.9.2.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3API%E5%87%BD%E6%95%B0-2"><span class="nav-number">7.9.2.2.</span> <span class="nav-text">相关API函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%BF%E6%92%AD"><span class="nav-number">7.9.3.</span> <span class="nav-text">广播</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E9%94%81"><span class="nav-number">7.10.</span> <span class="nav-text">读写锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1"><span class="nav-number">7.10.1.</span> <span class="nav-text">基本概念</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sineagle"
      src="/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">sineagle</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">133</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">85</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/sineagle" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sineagle" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:997991067@gmail.com" title="E-Mail → mailto:997991067@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/bottlecodes" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;bottlecodes" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/bottlecodes" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;bottlecodes" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
      <span class="links-of-author-item">
        <a href="skype:yourname?call|chat" title="Skype → skype:yourname?call|chat" rel="noopener" target="_blank"><i class="fab fa-skype fa-fw"></i>Skype</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://cnblogs.com/sineagle" title="OldBlogs → https:&#x2F;&#x2F;cnblogs.com&#x2F;sineagle" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>OldBlogs</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sineagle</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">738k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">11:11</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
